<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSVåŠ¨ç”»å¯¹æ¯”</title>
    <script>
        // === å¤š CDN å¤‡ä»½åŠ è½½æœºåˆ¶ ===
        // è§£å†³ Windows å¹³å°ä¸Š CDN è®¿é—®é—®é¢˜

        (function() {
            'use strict';

            // CDN åˆ—è¡¨ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰- å›½å†…å‹å¥½ CDN
            const cdnList = [
                {
                    name: 'BootCDN (å›½å†…)',
                    url: 'https://cdn.bootcdn.net/ajax/libs/Chart.js/4.4.1/chart.umd.min.js',
                    timeout: 8000
                },
                {
                    name: 'Staticfile (ä¸ƒç‰›äº‘)',
                    url: 'https://cdn.staticfile.org/Chart.js/4.4.1/chart.umd.min.js',
                    timeout: 8000
                },
                {
                    name: 'Baomitu (ä¿éšœæ€§)',
                    url: 'https://lib.baomitu.com/Chart.js/4.4.1/chart.umd.min.js',
                    timeout: 8000
                },
                {
                    name: 'jsDelivr (å›½é™…)',
                    url: 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js',
                    timeout: 5000
                },
                {
                    name: 'cdnjs (å›½é™…)',
                    url: 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js',
                    timeout: 5000
                }
            ];

            let currentCdnIndex = 0;
            let currentScript = null; // è·Ÿè¸ªå½“å‰åŠ è½½çš„è„šæœ¬
            let loadTimeout = null;
            let isLoaded = false; // é˜²æ­¢é‡å¤åŠ è½½
            let isAborted = false; // é˜²æ­¢å·²ä¸­æ­¢çš„åŠ è½½è§¦å‘å›è°ƒ

            // åœæ­¢å½“å‰åŠ è½½
            function abortCurrentLoad() {
                if (currentScript) {
                    // ç§»é™¤è„šæœ¬èŠ‚ç‚¹ä»¥åœæ­¢åŠ è½½
                    if (currentScript.parentNode) {
                        currentScript.parentNode.removeChild(currentScript);
                    }
                    // æ¸…é™¤äº‹ä»¶ç›‘å¬å™¨
                    currentScript.onload = null;
                    currentScript.onerror = null;
                    currentScript = null;
                }
                if (loadTimeout) {
                    clearTimeout(loadTimeout);
                    loadTimeout = null;
                }
                isAborted = true;
            }

            // åŠ è½½ Chart.js è„šæœ¬
            function loadChartJs(cdnIndex) {
                // å¦‚æœå·²ç»æˆåŠŸåŠ è½½ï¼Œä¸å†å°è¯•
                if (isLoaded || typeof Chart !== 'undefined') {
                    console.log('âœ… Chart.js å·²åŠ è½½ï¼Œè·³è¿‡åç»­ CDN');
                    return;
                }

                if (cdnIndex >= cdnList.length) {
                    console.error('âŒ æ‰€æœ‰ CDN å‡åŠ è½½å¤±è´¥ï¼');
                    showLoadFailedWarning();
                    return;
                }

                const cdn = cdnList[cdnIndex];
                console.log(`ğŸ“¡ å°è¯•ä» ${cdn.name} åŠ è½½ Chart.js...`);

                // åœæ­¢ä¹‹å‰çš„åŠ è½½
                abortCurrentLoad();
                isAborted = false;

                const script = document.createElement('script');
                currentScript = script;
                script.async = false; // ä¿æŒåŒæ­¥åŠ è½½ä»¥ç¡®ä¿æ‰§è¡Œé¡ºåº
                script.src = cdn.url;

                // æˆåŠŸåŠ è½½
                script.onload = function() {
                    // å¦‚æœå·²ä¸­æ­¢ï¼Œä¸å¤„ç†
                    if (isAborted) {
                        console.log(`âš ï¸ ${cdn.name} åŠ è½½å®Œæˆä½†å·²è¢«ä¸­æ­¢`);
                        return;
                    }

                    // æ¸…é™¤è¶…æ—¶
                    if (loadTimeout) {
                        clearTimeout(loadTimeout);
                        loadTimeout = null;
                    }

                    // åŒé‡æ£€æŸ¥ Chart æ˜¯å¦çœŸçš„åŠ è½½æˆåŠŸ
                    if (typeof Chart !== 'undefined') {
                        isLoaded = true;
                        currentScript = null;
                        const loadTime = Date.now() - performance.timing.navigationStart;
                        console.log(`âœ… Chart.js ä» ${cdn.name} åŠ è½½æˆåŠŸï¼è€—æ—¶: ${loadTime}ms`);
                        window.chartJsLoadStatus = {
                            isLoaded: true,
                            loadTime: loadTime,
                            cdnUsed: cdn.name
                        };
                    } else {
                        console.warn(`âš ï¸ ${cdn.name} è„šæœ¬å·²åŠ è½½ï¼Œä½† Chart å¯¹è±¡æœªå®šä¹‰ï¼Œå°è¯•ä¸‹ä¸€ä¸ª CDN...`);
                        currentScript = null;
                        tryNextCdn(cdnIndex);
                    }
                };

                // åŠ è½½å¤±è´¥
                script.onerror = function() {
                    // å¦‚æœå·²ä¸­æ­¢ï¼Œä¸å¤„ç†
                    if (isAborted) {
                        return;
                    }

                    console.warn(`âŒ ${cdn.name} åŠ è½½å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ª CDN...`);
                    currentScript = null;
                    tryNextCdn(cdnIndex);
                };

                // è®¾ç½®è¶…æ—¶
                loadTimeout = setTimeout(() => {
                    if (isAborted || isLoaded) {
                        return;
                    }
                    console.warn(`â±ï¸ ${cdn.name} åŠ è½½è¶…æ—¶ (${cdn.timeout}ms)ï¼Œå°è¯•ä¸‹ä¸€ä¸ª CDN...`);
                    // ä¸­æ­¢å½“å‰åŠ è½½å¹¶å°è¯•ä¸‹ä¸€ä¸ª
                    abortCurrentLoad();
                    tryNextCdn(cdnIndex);
                }, cdn.timeout);

                document.head.appendChild(script);
            }

            // å°è¯•ä¸‹ä¸€ä¸ª CDN
            function tryNextCdn(failedIndex) {
                currentCdnIndex = failedIndex + 1;
                if (currentCdnIndex < cdnList.length) {
                    // çŸ­æš‚å»¶è¿Ÿåé‡è¯•
                    setTimeout(() => {
                        loadChartJs(currentCdnIndex);
                    }, 500);
                } else {
                    console.error('âŒ æ‰€æœ‰ CDN å‡åŠ è½½å¤±è´¥ï¼');
                    showLoadFailedWarning();
                }
            }

            // æ˜¾ç¤ºåŠ è½½å¤±è´¥è­¦å‘Š
            function showLoadFailedWarning() {
                window.chartJsLoadStatus = {
                    isLoaded: false,
                    loadTime: null,
                    cdnUsed: null
                };

                // ç­‰å¾… DOM åŠ è½½åæ˜¾ç¤ºè­¦å‘Š
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', showWarning);
                } else {
                    showWarning();
                }
            }

            function showWarning() {
                const warningDiv = document.createElement('div');
                warningDiv.style.cssText = 'position: fixed; top: 10px; left: 50%; transform: translateX(-50%); ' +
                    'background: #ff6b6b; color: white; padding: 20px 25px; border-radius: 8px; ' +
                    'z-index: 10000; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); max-width: 80%;';
                warningDiv.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 10px;">âš ï¸ Chart.js åŠ è½½å¤±è´¥</div>
                    <div style="font-size: 13px; line-height: 1.6;">
                        æ‰€æœ‰å›½å†…/å›½é™… CDN å‡æ— æ³•è®¿é—®<br>
                        <strong>å¯èƒ½åŸå› ï¼š</strong><br>
                        â€¢ ç½‘ç»œè¿æ¥æ–­å¼€æˆ–é™åˆ¶<br>
                        â€¢ å…¬å¸/å­¦æ ¡ç½‘ç»œç­–ç•¥é™åˆ¶<br>
                        â€¢ é˜²ç«å¢™æˆ–å®‰å…¨è½¯ä»¶é˜»æ­¢<br>
                        â€¢ DNS è§£æé—®é¢˜<br>
                        <br>
                        <strong>è§£å†³æ–¹æ¡ˆï¼š</strong><br>
                        1. åˆ·æ–°é¡µé¢é‡è¯• (F5)<br>
                        2. æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸<br>
                        3. å°è¯•åˆ‡æ¢ç½‘ç»œï¼ˆå¦‚æ‰‹æœºçƒ­ç‚¹ï¼‰<br>
                        4. æš‚æ—¶å…³é—­é˜²ç«å¢™/å®‰å…¨è½¯ä»¶<br>
                        5. æŒ‰F12æŸ¥çœ‹æ§åˆ¶å°è¯¦ç»†é”™è¯¯ä¿¡æ¯
                    </div>
                `;

                document.body.appendChild(warningDiv);

                // 15ç§’åè‡ªåŠ¨ç§»é™¤
                setTimeout(() => {
                    if (warningDiv.parentNode) {
                        warningDiv.parentNode.removeChild(warningDiv);
                    }
                }, 15000);
            }

            // å¯åŠ¨åŠ è½½
            console.log('ğŸš€ å¼€å§‹åŠ è½½ Chart.js...');
            loadChartJs(0);

        })();
    </script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }
        .main-title-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 5px;
        }
        .version-info {
            font-size: 14px;
            color: #666;
            text-align: center;
            margin-bottom: 20px;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin: 0;
        }
        .upload-section {
            border: 2px dashed #3498db;
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 20px;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
            position: relative;
        }
        .upload-section.has-file {
            border-style: solid;
            border-color: #ddd;
            padding: 15px;
        }
        .upload-section .upload-prompt {
            text-align: center;
        }
        .upload-section:hover {
            border-color: #2980b9;
            background-color: #eef7ff;
        }
        .upload-section.dragover {
            border-color: #2980b9;
            background-color: #eef7ff;
        }
        .upload-section.parsing {
            pointer-events: none;
            opacity: 0.7;
        }
        .file-input {
            display: none;
        }
        .upload-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .upload-btn:hover {
            background-color: #2980b9;
        }
        .upload-btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .data-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .data-preview-header h3 {
            margin: 0;
            color: #2c3e50;
        }
        .data-preview-section {
            margin-bottom: 20px;
        }
        .data-preview {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        /* è¡Œå·åˆ—å›ºå®šæ ·å¼ */
        td.row-number {
            background-color: #f2f2f2;
            position: sticky;
            left: 0;
            z-index: 1;
            font-weight: bold;
            width: 60px;
            min-width: 60px;
            max-width: 60px;
            white-space: nowrap;
            text-align: center;
        }
        th.row-number-header {
            background-color: #f2f2f2;
            position: sticky;
            left: 0;
            z-index: 2;
            width: 60px;
            min-width: 60px;
            max-width: 60px;
        }
        .config-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .config-group {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        .config-group h3 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 8px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea {
            height: 60px;
            resize: vertical;
        }
        /* é»˜è®¤å€¼æ ·å¼ */
        .default-value {
            color: #999;
        }

        /* ç»Ÿä¸€è¾“å…¥æ¡†å’Œä¸‹æ‹‰æ¡†æ ·å¼ */
        input[type="text"],
        input[type="number"],
        select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 14px;
            box-sizing: border-box;
            height: 40px;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        /* æ‰‹åŠ¨ä¿®æ”¹å€¼æ ·å¼ */
        .manual-value {
            color: #333;
        }
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #95a5a6;
        }
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        .btn-danger {
            background-color: #e74c3c;
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .chart-container {
            margin-top: 20px;
            position: relative;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            width: 100%;
        }
        .control-buttons {
            display: flex;
            gap: 10px;
        }
        .frame-info {
            margin: 0 15px;
            font-weight: 500;
            min-width: 80px;
            text-align: right;
        }
        .progress-container {
            flex: 2;
            margin: 0 15px;
            max-width: 800px;
        }
        .progress {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #e0e0e0;
            border-radius: 4px;
            outline: none;
        }
        .progress::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #3498db;
            border-radius: 50%;
            cursor: pointer;
        }
        .progress::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #3498db;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        .hidden {
            display: none;
        }

        /* å›¾è¡¨å®¹å™¨æ ·å¼ */
        .chart-container {
            position: relative;
        }


        /* Toasté€šçŸ¥æ ·å¼ */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 400px;
        }

        .toast {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            margin-bottom: 10px;
            padding: 16px 20px;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            border-left: 4px solid #3498db;
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 100%;
            word-wrap: break-word;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast.success {
            border-left-color: #27ae60;
            background-color: #d4f8e8;
        }

        .toast.error {
            border-left-color: #e74c3c;
            background-color: #fadbd8;
        }

        .toast.info {
            border-left-color: #3498db;
            background-color: #eef7ff;
        }

        .toast.warning {
            border-left-color: #f39c12;
            background-color: #fef9e7;
        }

        .toast-content {
            flex: 1;
            margin-right: 10px;
            white-space: pre-line; /* æ”¯æŒæ¢è¡Œç¬¦æ˜¾ç¤ºï¼Œä½¿ \n èƒ½æ­£ç¡®æ¸²æŸ“ */
        }

        .toast-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toast-close:hover {
            color: #333;
        }

        .toast-cancel-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .toast-cancel-btn:hover {
            background: #c0392b;
        }

        /* ç¦ç”¨æ•´ä¸ªé¡µé¢çš„æ ·å¼ */
        .page-disabled {
            pointer-events: none;
            opacity: 0.7;
        }

        .page-disabled .toast-container {
            pointer-events: auto;
            opacity: 1;
        }

        /* æ–‡ä»¶æ ‡ç­¾é¡µæ ·å¼ */
        .file-tabs-container {
            margin-bottom: 20px;
        }

        .file-tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            overflow-x: auto;
            background-color: #f8f9fa;
            border-radius: 6px 6px 0 0;
        }

        .file-tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
            position: relative;
            min-width: 120px;
            text-align: center;
        }

        .file-tab:hover {
            background-color: #e9ecef;
            color: #333;
        }

        .file-tab.active {
            background-color: white;
            color: #3498db;
            border-bottom-color: #3498db;
            font-weight: 500;
        }

        .file-tab .file-name {
            font-weight: 500;
            margin-bottom: 2px;
            cursor: text;
            padding: 2px 4px;
            border-radius: 3px;
            transition: background-color 0.2s ease;
        }

        .file-tab .file-name:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }

        .file-tab .file-name:focus {
            outline: 2px solid #3498db;
            outline-offset: -2px;
            background-color: rgba(52, 152, 219, 0.05);
        }

        .file-tab .file-info {
            font-size: 11px;
            color: #888;
            white-space: nowrap;
        }
        .file-tab .file-config {
            margin-top: 4px;
        }
        .file-tab .constant-rows-input {
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f8f9fa;
            color: #666;
            transition: all 0.2s ease;
            height: 40px;
            box-sizing: border-box;
        }
        .file-tab .constant-rows-input:focus {
            outline: none;
            border-color: #3498db;
            background-color: white;
            color: #333;
        }
        .file-tab .constant-rows-input::placeholder {
            color: #aaa;
            font-style: italic;
        }

        .file-tab .close-tab {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #e74c3c;
            color: white;
            border: none;
            font-size: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .file-tab .close-tab:hover {
            opacity: 1;
        }

        .file-tab.active .close-tab {
            background: #c0392b;
        }

        .add-file-tab {
            padding: 12px 16px;
            cursor: pointer;
            border: 2px dashed #3498db;
            background: none;
            color: #3498db;
            border-radius: 6px;
            margin: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .add-file-tab:hover {
            background-color: rgba(52, 152, 219, 0.1);
            border-color: #2980b9;
        }

        /* --- å¸®åŠ©æµ®çª—æ ·å¼ --- */
        .help-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            -webkit-animation-name: fadeIn;
            animation-name: fadeIn;
            -webkit-animation-duration: 0.3s;
            animation-duration: 0.3s;
        }
        .help-modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px 30px;
            border: 1px solid #888;
            width: 80%;
            max-width: 800px;
            border-radius: 8px;
            -webkit-animation-name: slideIn;
            animation-name: slideIn;
            -webkit-animation-duration: 0.3s;
            animation-duration: 0.3s;
        }
        .help-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .help-modal-header h2 {
            margin: 0;
            color: #2c3e50;
        }
        .help-modal-close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .help-modal-close:hover,
        .help-modal-close:focus {
            color: black;
            text-decoration: none;
        }
        .help-modal-body {
            max-height: 60vh;
            overflow-y: auto;
            line-height: 1.6;
        }
        .help-modal-body h3 {
            color: #3498db;
            margin-top: 20px;
        }
        .help-modal-body p {
            margin-bottom: 10px;
        }
        .help-modal-body code {
            background-color: #f0f0f0;
            padding: 2px 5px;
            border-radius: 4px;
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
        }
        .help-modal-body ul {
            padding-left: 20px;
        }
        .help-modal-body li {
            margin-bottom: 8px;
        }

        @-webkit-keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
        @keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
        @-webkit-keyframes slideIn { from {top: -100px; opacity: 0} to {top: 0; opacity: 1} }
        @keyframes slideIn { from {margin-top: 0; opacity: 0} to {margin-top: 5%; opacity: 1} }

        /* æ—¶é—´åºåˆ—æµ®çª—æ ·å¼ */
        .time-series-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            -webkit-animation-name: fadeIn;
            animation-name: fadeIn;
            -webkit-animation-duration: 0.3s;
            animation-duration: 0.3s;
        }

        .time-series-modal-content {
            background-color: #fefefe;
            margin: 3% auto;
            padding: 20px 30px;
            border: 1px solid #888;
            width: 80%;
            max-width: 900px;
            border-radius: 8px;
            -webkit-animation-name: slideIn;
            animation-name: slideIn;
            -webkit-animation-duration: 0.3s;
            animation-duration: 0.3s;
        }

        .time-series-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .time-series-modal-header h3 {
            margin: 0;
            color: #2c3e50;
        }

        .time-series-modal-close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .time-series-modal-close:hover,
        .time-series-modal-close:focus {
            color: black;
            text-decoration: none;
        }

        .time-series-modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        .time-series-info {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-size: 14px;
            color: #666;
        }

        .time-series-info span {
            font-weight: bold;
            color: #2c3e50;
        }

        .time-series-chart-container {
            position: relative;
            width: 100%;
            height: 400px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background-color: white;
        }

        #timeSeriesChart {
            width: 100% !important;
            height: 100% !important;
        }

        /* å…¨å±€æ‹–æ”¾è¦†ç›–å±‚æ ·å¼ */
        .global-drop-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(52, 152, 219, 0.1);
            backdrop-filter: blur(2px);
            z-index: 9998;
            display: none;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .global-drop-overlay.active {
            display: flex;
            pointer-events: auto;
        }

        .global-drop-overlay .drop-hint {
            background: rgba(52, 152, 219, 0.9);
            color: white;
            padding: 30px 50px;
            border-radius: 12px;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 8px 32px rgba(52, 152, 219, 0.3);
            border: 3px dashed rgba(255, 255, 255, 0.8);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .global-drop-overlay .drop-hint .drop-icon {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }

        /* å…¨å±€æ‹–æ”¾æ—¶ä¸Šä¼ åŒºåŸŸçš„ç‰¹æ®Šé«˜äº® */
        .upload-section.global-drop-highlight {
            border-color: #2980b9;
            background-color: #eef7ff;
            box-shadow: 0 0 20px rgba(52, 152, 219, 0.4);
            transform: scale(1.02);
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>

    <!-- å…¨å±€æ‹–æ”¾è¦†ç›–å±‚ -->
    <div class="global-drop-overlay" id="globalDropOverlay">
        <div class="drop-hint">
            <span class="drop-icon">ğŸ“</span>
            æ‹–æ”¾åˆ°ä»»æ„ä½ç½®ä¸Šä¼ CSVæ–‡ä»¶
        </div>
    </div>

    <div class="container" id="mainContainer">
        <div class="main-title-container">
            <h1>CSVåŠ¨ç”»å¯¹æ¯”</h1>
            <button class="btn btn-secondary" id="helpBtn">å¸®åŠ©</button>
        </div>
        <div class="version-info">ä½œè€…ï¼š<a href="mailto:miboyu@yeah.net">ç±³åšå®‡</a> | ç‰ˆæœ¬ï¼šv1.0.2</div>

        <div class="upload-section" id="uploadSection">
            <div class="upload-prompt" id="uploadPrompt">
                <p>æ‹–æ‹½CSVæ–‡ä»¶åˆ°æ­¤å¤„æˆ–</p>
                <button class="upload-btn" id="initialUploadBtn">é€‰æ‹©æ–‡ä»¶</button>
                <button class="upload-btn" id="addFileBtn" style="margin-left: 10px; display: none;">æ·»åŠ æ–‡ä»¶</button>
            </div>

            <!-- æ–‡ä»¶æ ‡ç­¾é¡µå®¹å™¨ -->
            <div id="fileTabsContainer" class="file-tabs-container" style="display: none;">
                <div class="file-tabs" id="fileTabs"></div>
            </div>

            <div id="dataPreviewSection" class="data-preview-section hidden">
                <div class="data-preview-header">
                    <h3 id="fileName"></h3>
                    <div>
                        <button class="btn" id="refreshFileBtn">åˆ·æ–°æ–‡ä»¶</button>
                        <button class="btn" id="uploadBtn">æ·»åŠ æ–‡ä»¶</button>
                        <button class="btn btn-danger" id="clearFilesBtn" style="display: none;">æ¸…é™¤æ–‡ä»¶</button>
                    </div>
                </div>
                <div class="data-preview" id="dataPreview"></div>
            </div>
            <input type="file" id="fileInput" class="file-input" accept=".csv" multiple>
        </div>

        <div id="configSection" class="hidden">
            <div class="config-section">
                <div class="config-group">
                    <h3>æ•°æ®è®¾ç½®</h3>
                    <div class="form-group">
                        <label for="xAxisRow">Xè½´æ•°æ®è¡Œå·ï¼ˆé»˜è®¤ç¬¬1è¡Œï¼‰</label>
                        <input type="number" id="xAxisRow" min="1" value="1" class="default-value">
                    </div>
                    <div class="form-group">
                        <label for="startRow">Yè½´èµ·å§‹è¡Œï¼ˆé»˜è®¤Xè½´è¡Œå·åŠ 1ï¼‰</label>
                        <input type="number" id="startRow" min="1" value="2" class="default-value">
                    </div>
                    <div class="form-group">
                        <label for="endRow">Yè½´ç»“æŸè¡Œï¼ˆé»˜è®¤æœ€åä¸€è¡Œï¼Œè´Ÿæ•°è¡¨ç¤ºå€’æ•°ï¼‰</label>
                        <input type="number" id="endRow" value="-1" class="default-value">
                    </div>
                    <div class="form-group">
                        <label for="startCol">Yè½´èµ·å§‹åˆ—ï¼ˆé»˜è®¤ç¬¬2åˆ—ï¼‰</label>
                        <input type="number" id="startCol" min="1" value="2" class="default-value">
                    </div>
                    <div class="form-group">
                        <label for="endCol">Yè½´ç»“æŸåˆ—ï¼ˆé»˜è®¤æœ€åä¸€åˆ—ï¼Œè´Ÿæ•°è¡¨ç¤ºå€’æ•°ï¼‰</label>
                        <input type="number" id="endCol" value="-1" class="default-value">
                    </div>
                    <div class="form-group">
                        <label for="constantRows">å¸¸æ˜¾è¡Œï¼ˆé»˜è®¤ä¸æ˜¾ç¤ºï¼‰</label>
                        <textarea id="constantRows"
                            placeholder="è¾“å…¥è¦å›ºå®šæ˜¾ç¤ºçš„è¡Œå·ï¼Œç”¨é€—å·åˆ†éš”ï¼Œå¦‚: 3,5,7 æˆ– -1,-2 è¡¨ç¤ºå€’æ•°ï¼Œå¼€å¯åå°†è‡ªåŠ¨æ‰“å¼€<æ˜¾ç¤ºå›¾ä¾‹>è®¾ç½®ã€‚æç¤ºï¼šå¯åœ¨æ–‡ä»¶æ ‡ç­¾é¡µä¸­ä¸ºå•ä¸ªæ–‡ä»¶å•ç‹¬è®¾ç½®å¸¸æ˜¾è¡Œã€‚" class="default-value"></textarea>
                    </div>
                </div>

                <div class="config-group">
                    <h3>åŠ¨ç”»è®¾ç½®</h3>
                    <div class="form-group">
                        <label for="frameInterval">å¸§é—´éš” (æ¯«ç§’)</label>
                        <input type="number" id="frameInterval" min="10" max="5000" value="50" class="default-value">
                    </div>
                    <div class="form-group">
                        <label for="skipFrames">è·³å¸§æ•° (0=ä¸è·³å¸§)</label>
                        <input type="number" id="skipFrames" min="0" value="0" class="default-value">
                    </div>
                    <div class="form-group">
                        <label for="xMin">Xè½´æœ€å°å€¼</label>
                        <input type="text" id="xMin" value="auto" class="default-value">
                    </div>
                    <div class="form-group">
                        <label for="xMax">Xè½´æœ€å¤§å€¼</label>
                        <input type="text" id="xMax" value="auto" class="default-value">
                    </div>
                    <div class="form-group">
                        <label for="yMin">Yè½´æœ€å°å€¼</label>
                        <input type="text" id="yMin" value="auto" class="default-value">
                    </div>
                    <div class="form-group">
                        <label for="yMax">Yè½´æœ€å¤§å€¼</label>
                        <input type="text" id="yMax" value="auto" class="default-value">
                    </div>
                </div>

                <div class="config-group">
                    <h3>æ˜¾ç¤ºè®¾ç½®</h3>
                    <div class="form-group">
                        <label for="showLegend">æ˜¾ç¤ºå›¾ä¾‹</label>
                        <select id="showLegend" class="default-value">
                            <option value="false">å¦</option>
                            <option value="true">æ˜¯</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tooltipMode">æµ®çª—æ˜¾ç¤ºæ¨¡å¼</label>
                        <select id="tooltipMode" class="default-value">
                            <option value="compact" selected>ç¼©ç•¥æ˜¾ç¤º</option>
                            <option value="full">å®Œæ•´æ˜¾ç¤º</option>
                            <option value="off">å…³é—­æ˜¾ç¤º</option>
                        </select>
                    </div>
                        <div class="form-group">
                        <label for="xAxisType">Xè½´ç±»å‹</label>
                        <select id="xAxisType" class="default-value">
                            <option value="linear">æ•°å€¼</option>
                            <option value="category">åˆ†ç±»</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="chartTitle">åŠ¨ç”»æ ‡é¢˜</label>
                        <input type="text" id="chartTitle" value="æ•°æ®åŠ¨ç”»" class="default-value">
                    </div>
                    <div class="form-group">
                        <label for="xAxisLabel">Xè½´æ ‡ç­¾</label>
                        <input type="text" id="xAxisLabel" value="Xè½´" class="default-value">
                    </div>
                    <div class="form-group">
                        <label for="yAxisLabel">Yè½´æ ‡ç­¾</label>
                        <input type="text" id="yAxisLabel" value="Yè½´" class="default-value">
                    </div>
                    </div>
            </div>

            <div class="form-group">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <button class="btn" id="generateChartBtn">ç”ŸæˆåŠ¨ç”»</button>
                        <button class="btn" id="saveVideoBtn" disabled>ä¿å­˜è§†é¢‘</button>
                        <select id="videoQuality" class="default-value" style="width: auto; min-width: 80px; text-align: center;">
                            <option value="low">æ ‡æ¸…</option>
                            <option value="medium" selected>é«˜æ¸…</option>
                            <option value="high">è¶…æ¸…</option>
                            <option value="ultra">2K</option>
                            <option value="extreme">4K</option>
                        </select>
                        <button class="btn btn-secondary" id="resetBtn">é‡ç½®è®¾ç½®</button>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <select id="axisZoomTarget" title="é€‰æ‹©ç¼©æ”¾ç›®æ ‡" class="default-value">
                            <option value="xy">XYè½´åŒæ­¥</option>
                            <option value="x">ä»…Xè½´</option>
                            <option value="y">ä»…Yè½´</option>
                        </select>
                        <button class="btn" id="axisZoomInBtn" title="æ”¾å¤§åæ ‡è½´ (+)" style="padding: 10px 15px; width: auto; min-width: 60px;">æ”¾å¤§</button>
                        <button class="btn" id="axisZoomOutBtn" title="ç¼©å°åæ ‡è½´ (-)" style="padding: 10px 15px; width: auto; min-width: 60px;">ç¼©å°</button>
                        <button class="btn btn-secondary" id="axisResetBtn" title="é‡ç½®åæ ‡è½´ (0)" style="padding: 10px 15px; width: auto; min-width: 60px;">é‡ç½®</button>
                        <input type="range" id="axisZoomSlider" min="1" max="1000" value="100" step="1">
                        <input type="number" id="axisZoomInput" min="1" max="999999" value="100" step="1"
                               style="width: 70px; text-align: center;"
                               title="ç›´æ¥è¾“å…¥ç¼©æ”¾ç™¾åˆ†æ¯”" class="default-value">
                        <span>%</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="chartSection" class="hidden">
            <div class="chart-container">
                <div id="chartContainer" style="width: 100%; height: 600px;"></div>
            </div>

            <div class="controls">
                <div class="control-buttons">
                    <button class="btn" id="playPauseBtn">æ’­æ”¾</button>
                    <button class="btn" id="prevFrameBtn">ä¸Šä¸€å¸§</button>
                    <button class="btn" id="nextFrameBtn">ä¸‹ä¸€å¸§</button>
                </div>
                <div class="progress-container" id="progressContainer">
                    <input type="range" class="progress" id="progressBar" min="0" max="100" value="0">
                </div>
                <div class="frame-info">
                    <span id="currentFrame">0</span> / <span id="totalFrames">0</span>
                </div>
            </div>

          </div>
    </div>

    <!-- æ—¶é—´åºåˆ—æµ®çª— -->
    <div id="timeSeriesModal" class="time-series-modal">
        <div class="time-series-modal-content">
            <div class="time-series-modal-header">
                <h3 id="timeSeriesModalTitle">æ•°æ®ç‚¹æ—¶é—´åºåˆ—</h3>
                <span class="time-series-modal-close" id="timeSeriesModalClose">&times;</span>
            </div>
            <div class="time-series-modal-body">
                <div class="time-series-info">
                    <div>ç‚¹å‡»ä½ç½®: <span id="clickedPosition"></span></div>
                    <div class="time-series-stats" id="timeSeriesStats" style="display: none;">
                        <hr style="margin: 10px 0; border: none; border-top: 1px solid #ddd;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px;">
                            <div>æœ€å¤§å€¼: <span id="statsMax" style="color: #e74c3c; font-weight: bold;"></span></div>
                            <div>æœ€å°å€¼: <span id="statsMin" style="color: #27ae60; font-weight: bold;"></span></div>
                            <div>å¹³å‡å€¼: <span id="statsAvg" style="color: #3498db; font-weight: bold;"></span></div>
                            <div>æ ‡å‡†å·®: <span id="statsStd" style="color: #9b59b6; font-weight: bold;"></span></div>
                            <div>æ•°æ®ç‚¹æ•°: <span id="statsCount" style="color: #34495e; font-weight: bold;"></span></div>
                            <div>å˜åŒ–èŒƒå›´: <span id="statsRange" style="color: #f39c12; font-weight: bold;"></span></div>
                        </div>
                    </div>
                </div>
                <div class="time-series-chart-container">
                    <canvas id="timeSeriesChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="helpModal" class="help-modal">
        <div class="help-modal-content">
            <div class="help-modal-header">
                <h2>å¸®åŠ©æ–‡æ¡£</h2>
                <span class="help-modal-close" id="helpModalClose">&times;</span>
            </div>
            <div class="help-modal-body">
                <h3>å·¥å…·ç®€ä»‹</h3>
                <p><strong>CSVåŠ¨ç”»å¯¹æ¯”å·¥å…·</strong>æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•°æ®å¯è§†åŒ–å·¥å…·ï¼Œå¯ä»¥å°†CSVæ–‡ä»¶ä¸­çš„æ—¶åºæ•°æ®è½¬æ¢æˆåŠ¨æ€çš„æŠ˜çº¿å›¾åŠ¨ç”»ï¼Œæ”¯æŒå¤šæ–‡ä»¶å¯¹æ¯”åˆ†æï¼Œå¹¶å¯å°†åŠ¨ç”»å¯¼å‡ºä¸ºé«˜è´¨é‡è§†é¢‘æ–‡ä»¶ã€‚å·¥å…·é›†æˆäº†ä¸°å¯Œçš„äº¤äº’åŠŸèƒ½å’Œç»Ÿè®¡åˆ†æèƒ½åŠ›ï¼Œéå¸¸é€‚åˆç§‘ç ”ã€å·¥ç¨‹å’Œæ•°æ®åˆ†æåœºæ™¯ã€‚</p>

                <h3>æ“ä½œæ­¥éª¤</h3>
                <ol>
                    <li><b>ä¸Šä¼ æ–‡ä»¶ï¼š</b>ç‚¹å‡»"é€‰æ‹©æ–‡ä»¶"æŒ‰é’®æˆ–ç›´æ¥å°†CSVæ–‡ä»¶æ‹–æ‹½åˆ°ä¸Šä¼ åŒºåŸŸã€‚æ”¯æŒå•æ–‡ä»¶æˆ–å¤šæ–‡ä»¶åŒæ—¶å¯¼å…¥ã€‚</li>
                    <li><b>è®¾ç½®å‚æ•°ï¼š</b>æ–‡ä»¶ä¸Šä¼ æˆåŠŸåï¼Œæ ¹æ®æ‚¨çš„æ•°æ®æ ¼å¼å’Œéœ€æ±‚ï¼Œåœ¨è®¾ç½®åŒºåŸŸï¼ˆæ•°æ®ã€åŠ¨ç”»ã€æ˜¾ç¤ºï¼‰ä¸­è®¾ç½®å‚æ•°ã€‚</li>
                    <li><b>ç”ŸæˆåŠ¨ç”»ï¼š</b>ç‚¹å‡»"ç”ŸæˆåŠ¨ç”»"æŒ‰é’®ï¼Œç³»ç»Ÿå°†åˆ›å»ºå¤šæ–‡ä»¶å¯¹æ¯”å›¾è¡¨å’Œæ§åˆ¶é¢æ¿ã€‚</li>
                    <li><b>æ’­æ”¾ä¸é¢„è§ˆï¼š</b>ä½¿ç”¨æ’­æ”¾/æš‚åœã€å¸§å¯¼èˆªå’Œè¿›åº¦æ¡æ¥é¢„è§ˆåŠ¨ç”»æ•ˆæœã€‚</li>
                    <li><b>ç¼©æ”¾ä¸åˆ†æï¼š</b>ä½¿ç”¨ç¼©æ”¾æ§ä»¶æŸ¥çœ‹æ•°æ®ç»†èŠ‚ï¼ŒåŒå‡»å›¾è¡¨è¿›è¡Œæ—¶é—´åºåˆ—åˆ†æã€‚</li>
                    <li><b>ä¿å­˜è§†é¢‘ï¼š</b>å…ˆé€‰æ‹©è§†é¢‘è´¨é‡ï¼Œç„¶åç‚¹å‡»"ä¿å­˜è§†é¢‘"æŒ‰é’®å¯¼å‡ºå®Œæ•´çš„åŠ¨ç”»è§†é¢‘ï¼ˆåŒ…å«æ‰€æœ‰æ•°æ®çº¿æ¡ï¼‰ã€‚</li>
                </ol>

                <h3>æ–‡ä»¶æ“ä½œè¯´æ˜</h3>
                <h4>æ–‡ä»¶å¯¼å…¥æ–¹å¼</h4>
                <p>æœ¬å·¥å…·æ”¯æŒçµæ´»çš„æ–‡ä»¶å¯¼å…¥æ–¹å¼ï¼Œæ»¡è¶³ä¸åŒä½¿ç”¨åœºæ™¯ï¼š</p>
                <ul>
                    <li><b>æŒ‰é’®é€‰æ‹©ï¼ˆæ¨èï¼‰ï¼š</b>ç‚¹å‡»"é€‰æ‹©æ–‡ä»¶"æŒ‰é’®ï¼Œé€šè¿‡æ–‡ä»¶é€‰æ‹©å™¨å¯¼å…¥æ–‡ä»¶ã€‚æ”¯æŒå•æ–‡ä»¶æˆ–å¤šæ–‡ä»¶æ‰¹é‡é€‰æ‹©ï¼Œè‡ªåŠ¨è·å–æŒä¹…è®¿é—®æƒé™ï¼Œåç»­åˆ·æ–°æ–‡ä»¶æ—¶æ— éœ€é‡æ–°é€‰æ‹©ã€‚</li>
                    <li><b>æ‹–æ‹½å¯¼å…¥ï¼š</b>ç›´æ¥å°†å•ä¸ªæˆ–å¤šä¸ªCSVæ–‡ä»¶æ‹–æ‹½åˆ°ä¸Šä¼ åŒºåŸŸã€‚æ“ä½œç®€å•å¿«æ·ï¼Œæ”¯æŒæ‰¹é‡å¯¼å…¥ï¼Œä½†åˆ·æ–°æ—¶éœ€è¦é‡æ–°æˆæƒã€‚</li>
                    <li><b>æ–‡ä»¶è·¯å¾„è®°å¿†ï¼š</b>ç³»ç»Ÿä¼šè®°ä½ä¸Šæ¬¡æ‰“å¼€çš„æ–‡ä»¶è·¯å¾„ï¼Œä¸‹æ¬¡é€‰æ‹©æ–‡ä»¶æ—¶é»˜è®¤æ‰“å¼€è¯¥ç›®å½•ï¼Œæå‡æ“ä½œæ•ˆç‡ã€‚</li>
                </ul>

                <h4>æ–‡ä»¶åˆ·æ–°åŠŸèƒ½</h4>
                <p>å½“æ‚¨çš„CSVæ–‡ä»¶å†…å®¹æ›´æ–°åï¼Œå¯ä»¥ä½¿ç”¨"åˆ·æ–°æ–‡ä»¶"æŒ‰é’®é‡æ–°åŠ è½½æ•°æ®ï¼š</p>
                <ul>
                    <li><b>æ‰¹é‡åˆ·æ–°ï¼š</b>æ”¯æŒä¸€é”®åˆ·æ–°æ‰€æœ‰å·²å¯¼å…¥çš„æ–‡ä»¶ï¼Œè‡ªåŠ¨ä¿æŒå½“å‰çš„è®¾ç½®ã€‚</li>
                    <li><b>æ™ºèƒ½æƒé™ç®¡ç†ï¼š</b>æ ¹æ®æ–‡ä»¶å¯¼å…¥æ–¹å¼è‡ªåŠ¨å¤„ç†æƒé™é—®é¢˜ï¼ŒæŒ‰é’®å¯¼å…¥çš„æ–‡ä»¶ç›´æ¥åˆ·æ–°ï¼Œæ‹–æ‹½æ–‡ä»¶æç¤ºé‡æ–°æˆæƒã€‚</li>
                    <li><b>æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤ºï¼š</b>é¢„è§ˆçª—å£æ˜¾ç¤ºæ–‡ä»¶å¤§å°ã€è¡Œæ•°å’Œåˆ—æ•°ï¼Œåˆ·æ–°åä¿¡æ¯è‡ªåŠ¨æ›´æ–°ã€‚</li>
                    <li><b>é‡å‘½åæ”¯æŒï¼š</b>å¦‚æœå¯¹æ–‡ä»¶è¿›è¡Œäº†é‡å‘½åï¼Œåˆ·æ–°æç¤ºä¸­ä¼šæ˜¾ç¤ºæ–°çš„æ–‡ä»¶åç§°ã€‚</li>
                </ul>
                <p><b>æç¤ºï¼š</b>å¯¹äºéœ€è¦é¢‘ç¹æ›´æ–°çš„æ•°æ®ï¼Œå»ºè®®ä½¿ç”¨"é€‰æ‹©æ–‡ä»¶"æŒ‰é’®å¯¼å…¥ä»¥è·å¾—æœ€ä½³çš„æ— ç¼åˆ·æ–°ä½“éªŒã€‚</p>

                <h4>æ–‡ä»¶ç®¡ç†åŠŸèƒ½</h4>
                <p>å¤šæ–‡ä»¶ç¯å¢ƒä¸‹çš„æ–‡ä»¶ç®¡ç†æ“ä½œï¼š</p>
                <ul>
                    <li><b>Tabæ ‡ç­¾åˆ‡æ¢ï¼š</b>æ¯ä¸ªæ–‡ä»¶éƒ½æœ‰ç‹¬ç«‹çš„Tabæ ‡ç­¾ï¼Œç‚¹å‡»å¯åˆ‡æ¢æŸ¥çœ‹ä¸åŒæ–‡ä»¶çš„é¢„è§ˆæ•°æ®ã€‚</li>
                    <li><b>æ–‡ä»¶é‡å‘½åï¼š</b>ç‚¹å‡»Tabæ ‡ç­¾å¯ä»¥ç›´æ¥ç¼–è¾‘æ–‡ä»¶åï¼Œé‡å‘½ååä¼šåŒæ­¥æ›´æ–°å›¾è¡¨å›¾ä¾‹ã€‚</li>
                    <li><b>æ·»åŠ æ–‡ä»¶ï¼š</b>ç‚¹å‡»"æ·»åŠ æ–‡ä»¶"æŒ‰é’®å¯ä»¥ç»§ç»­å¯¼å…¥æ–°çš„CSVæ–‡ä»¶è¿›è¡Œå¯¹æ¯”åˆ†æã€‚</li>
                    <li><b>åˆ é™¤æ–‡ä»¶ï¼š</b>ç‚¹å‡»Tabæ ‡ç­¾ä¸Šçš„"Ã—"æŒ‰é’®å¯ä»¥åˆ é™¤å•ä¸ªæ–‡ä»¶ã€‚</li>
                    <li><b>æ¸…é™¤æ‰€æœ‰æ–‡ä»¶ï¼š</b>ç‚¹å‡»"æ¸…é™¤æ–‡ä»¶"æŒ‰é’®å¯ä»¥ä¸€æ¬¡æ€§æ¸…é™¤æ‰€æœ‰æ–‡ä»¶ï¼Œé‡ç½®ä¸ºåˆå§‹çŠ¶æ€ã€‚</li>
                </ul>

                <h4>æƒé™è¯´æ˜</h4>
                <p>ä¸ºäº†ä¿æŠ¤ç”¨æˆ·éšç§ï¼Œç°ä»£æµè§ˆå™¨å¯¹æ–‡ä»¶è®¿é—®æœ‰ä¸¥æ ¼çš„å®‰å…¨é™åˆ¶ï¼š</p>
                <ul>
                    <li><b>æŒä¹…æƒé™ï¼š</b>é€šè¿‡"é€‰æ‹©æ–‡ä»¶"æŒ‰é’®å¯¼å…¥æ—¶ï¼Œå·¥å…·ä¼šè¯·æ±‚æŒä¹…è®¿é—®æƒé™ï¼Œè·å¾—æƒé™åå¯ä»¥éšæ—¶è¯»å–æ–‡ä»¶ã€‚</li>
                    <li><b>ä¸´æ—¶æƒé™ï¼š</b>æ‹–æ‹½å¯¼å…¥çš„æ–‡ä»¶åªèƒ½è·å¾—ä¸´æ—¶è®¿é—®æƒé™ï¼Œé¡µé¢åˆ·æ–°æˆ–é‡æ–°æ‰“å¼€åéœ€è¦é‡æ–°æˆæƒã€‚</li>
                    <li><b>æƒé™èŒƒå›´ï¼š</b>æƒé™ä»…é™äºæ‚¨é€‰æ‹©çš„ç‰¹å®šæ–‡ä»¶ï¼Œå·¥å…·æ— æ³•è®¿é—®å…¶ä»–æ–‡ä»¶ã€‚</li>
                    <li><b>é»˜è®¤ç›®å½•ï¼š</b>é¦–æ¬¡é€‰æ‹©æ–‡ä»¶æ—¶é»˜è®¤æ‰“å¼€Downloadsç›®å½•ï¼Œåç»­è®°ä½ä¸Šæ¬¡æ‰“å¼€è·¯å¾„ã€‚</li>
                </ul>

                <h3>CSVæ•°æ®æ ¼å¼è¦æ±‚</h3>
                <p>ä¸ºäº†è®©å·¥å…·æ­£ç¡®è§£æï¼Œæ‚¨çš„CSVæ–‡ä»¶éœ€è¦éµå¾ªä»¥ä¸‹æ ¼å¼ï¼š</p>
                <ul>
                    <li><b>Xè½´æ•°æ®ï¼š</b>æ‰€æœ‰æ•°æ®ç‚¹å…±äº«çš„Xè½´åæ ‡å€¼ï¼Œå¿…é¡»å•ç‹¬æ”¾åœ¨<b>ä¸€è¡Œ</b>ä¸­ã€‚ä¾‹å¦‚ï¼Œé¢‘ç‡ã€æ³¢é•¿ç­‰ã€‚</li>
                    <li><b>Yè½´æ•°æ®ï¼š</b>æ¯ä¸€<b>è¡Œ</b>ä»£è¡¨åŠ¨ç”»çš„ä¸€å¸§ã€‚è¡Œä¸­çš„æ¯ä¸ªå•å…ƒæ ¼æ˜¯è¯¥å¸§åœ¨å¯¹åº”Xè½´åæ ‡ä¸Šçš„Yå€¼ã€‚</li>
                    <li><b>æ ‡ç­¾/æ—¶é—´åˆ—ï¼š</b>å»ºè®®æ¯è¡Œçš„<b>ç¬¬ä¸€åˆ—</b>ç”¨äºå­˜æ”¾è¯¥å¸§çš„æ ‡è¯†ï¼Œå¦‚æ—¶é—´æˆ³æˆ–åç§°ã€‚è¿™ä¸ªæ ‡è¯†ä¼šæ˜¾ç¤ºåœ¨åŠ¨ç”»æ ‡é¢˜ä¸­ï¼Œä»¥åŠä½œä¸ºâ€œå¸¸æ˜¾è¡Œâ€çš„å›¾ä¾‹æ ‡ç­¾ã€‚</li>
                </ul>
                <p><b>ç¤ºä¾‹ï¼š</b></p>
                <pre><code>X-Axis, 1, 2, 3, 4, 5
Time_1, 10, 12, 15, 13, 11
Time_2, 11, 13, 14, 12, 10
Time_3, 12, 14, 13, 11, 9
...
Static_Line_A, 5, 5, 5, 5, 5
Static_Line_B, 15, 15, 15, 15, 15
</code></pre>
                <p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œç¬¬ä¸€è¡Œæ˜¯Xè½´æ•°æ®ï¼Œç¬¬2-4è¡Œæ˜¯åŠ¨ç”»å¸§æ•°æ®ï¼Œç¬¬5-6è¡Œæ˜¯å¯ä»¥è®¾ç½®ä¸ºâ€œå¸¸æ˜¾è¡Œâ€çš„é™æ€æ•°æ®ã€‚</p>

                <h3>è®¾ç½®è¯¦è§£</h3>
                <h4>æ•°æ®è®¾ç½®</h4>
                <ul>
                    <li><b>Xè½´æ•°æ®è¡Œå·ï¼š</b>æŒ‡å®šå“ªä¸€è¡Œæ˜¯Xè½´çš„åæ ‡æ•°æ®ã€‚ä¾‹å¦‚ï¼Œç¤ºä¾‹ä¸­åº”å¡« <code>1</code>ã€‚</li>
                    <li><b>Yè½´èµ·å§‹/ç»“æŸè¡Œï¼š</b>å®šä¹‰å“ªäº›è¡Œçš„æ•°æ®ç”¨äºç”ŸæˆåŠ¨ç”»å¸§ã€‚ä¾‹å¦‚ï¼Œç¤ºä¾‹ä¸­å¯å¡«èµ·å§‹ <code>2</code>ï¼Œç»“æŸ <code>4</code>ã€‚</li>
                    <li><b>Yè½´èµ·å§‹/ç»“æŸåˆ—ï¼š</b>å®šä¹‰ä»å“ªä¸€åˆ—å¼€å§‹è¯»å–Xå’ŒYçš„æ•°æ®ã€‚é€šå¸¸ä»ç¬¬2åˆ—å¼€å§‹ï¼Œå› ä¸ºç¬¬1åˆ—æ˜¯æ ‡ç­¾ã€‚ä¾‹å¦‚ï¼Œç¤ºä¾‹ä¸­åº”å¡«èµ·å§‹ <code>2</code>ã€‚</li>
                    <li><b>è´Ÿæ•°ç´¢å¼•ï¼š</b>åœ¨"ç»“æŸè¡Œ/åˆ—"ä¸­ï¼Œå¯ä»¥ä½¿ç”¨è´Ÿæ•°è¡¨ç¤ºå€’æ•°ã€‚ä¾‹å¦‚ï¼Œ<code>-1</code> è¡¨ç¤ºæœ€åä¸€è¡Œ/åˆ—ï¼Œ<code>-2</code> è¡¨ç¤ºå€’æ•°ç¬¬äºŒè¡Œ/åˆ—ã€‚</li>
                    <li><b>å¸¸æ˜¾è¡Œï¼š</b>è¾“å…¥æ‚¨å¸Œæœ›åœ¨æ•´ä¸ªåŠ¨ç”»ä¸­éƒ½ä¿æŒä¸å˜çš„é™æ€æ•°æ®è¡Œå·ã€‚è¿™äº›è¡Œä¼šä»¥ç»†å®çº¿çš„å½¢å¼æ˜¾ç¤ºä½œä¸ºå‚è€ƒçº¿ã€‚å¤šä¸ªè¡Œå·ç”¨è‹±æ–‡é€—å· <code>,</code> åˆ†éš”ï¼Œæ”¯æŒè´Ÿæ•°ç´¢å¼•ã€‚ä¾‹å¦‚ï¼Œç¤ºä¾‹ä¸­å¯å¡« <code>5,6</code> æˆ– <code>-1,-2</code>ã€‚</li>
                    <li><b>æ–‡ä»¶ç‹¬ç«‹å¸¸æ˜¾è¡Œï¼š</b>åœ¨å¤šæ–‡ä»¶æ¨¡å¼ä¸‹ï¼Œå¯ä»¥ä¸ºæ¯ä¸ªæ–‡ä»¶å•ç‹¬è®¾ç½®å¸¸æ˜¾è¡Œã€‚æ–‡ä»¶ç‹¬ç«‹è®¾ç½®ä¼˜å…ˆçº§é«˜äºå…¨å±€è®¾ç½®ã€‚</li>
                </ul>

                <h4>åŠ¨ç”»è®¾ç½®</h4>
                <ul>
                    <li><b>å¸§é—´éš” (æ¯«ç§’)ï¼š</b>æ¯ä¸€å¸§çš„æ’­æ”¾æ—¶é•¿ï¼Œå•ä½æ˜¯æ¯«ç§’ï¼ˆ1000æ¯«ç§’ = 1ç§’ï¼‰ã€‚æ•°å€¼è¶Šå°ï¼ŒåŠ¨ç”»æ’­æ”¾è¶Šå¿«ã€‚</li>
                    <li><b>è·³å¸§æ•°ï¼š</b>è®¾ç½®åŠ¨ç”»æ¯éš”å‡ å¸§æ’­æ”¾ä¸€æ¬¡ã€‚<code>0</code> è¡¨ç¤ºä¸è·³å¸§ï¼Œæ’­æ”¾æ‰€æœ‰å¸§ï¼›<code>1</code> è¡¨ç¤ºæ¯éš”1å¸§æ’­æ”¾1æ¬¡ï¼ˆå³æ’­æ”¾ç¬¬1ã€3ã€5...å¸§ï¼‰ï¼Œå¯ä»¥ç”¨äºæ•°æ®é‡å¤§æ—¶åŠ å¿«é¢„è§ˆé€Ÿåº¦ã€‚</li>
                    <li><b>X/Yè½´æœ€å°å€¼/æœ€å¤§å€¼ï¼š</b>æ‰‹åŠ¨è®¾å®šåæ ‡è½´çš„æ˜¾ç¤ºèŒƒå›´ã€‚é»˜è®¤å€¼ä¸º <code>auto</code>ï¼Œè¡¨ç¤ºæ ¹æ®æ•°æ®è‡ªåŠ¨è°ƒæ•´ã€‚å¦‚æœåŠ¨ç”»è¿‡ç¨‹ä¸­æ•°æ®æ³¢åŠ¨èŒƒå›´å˜åŒ–å¾ˆå¤§ï¼Œå»ºè®®æ‰‹åŠ¨è®¾ç½®ä¸€ä¸ªå›ºå®šçš„èŒƒå›´ä»¥è·å¾—æ›´å¥½çš„è§†è§‰æ•ˆæœã€‚</li>
                </ul>

                <h4>æ˜¾ç¤ºè®¾ç½®</h4>
                <ul>
                    <li><b>æ˜¾ç¤ºå›¾ä¾‹ï¼š</b>æ˜¯å¦åœ¨å›¾è¡¨ä¸Šæ˜¾ç¤ºå›¾ä¾‹ã€‚å¦‚æœè®¾ç½®äº†"å¸¸æ˜¾è¡Œ"ï¼Œå»ºè®®å¼€å¯æ­¤é¡¹ä»¥åŒºåˆ†ä¸åŒçš„æ•°æ®çº¿ã€‚</li>
                    <li><b>æµ®çª—æ˜¾ç¤ºæ¨¡å¼ï¼š</b>æ§åˆ¶é¼ æ ‡æ‚¬åœåœ¨å›¾è¡¨ä¸Šæ—¶æ˜¾ç¤ºçš„æ•°æ®æµ®çª—ï¼š
                        <ul>
                            <li><b>ç¼©ç•¥æ˜¾ç¤ºï¼ˆé»˜è®¤ï¼‰ï¼š</b>ä»…æ˜¾ç¤ºæ•°æ®ç‚¹çš„Yè½´æ•°å€¼ï¼Œç•Œé¢ç®€æ´ä¸é®æŒ¡æ•°æ®ã€‚</li>
                            <li><b>å®Œæ•´æ˜¾ç¤ºï¼š</b>æ˜¾ç¤ºæ–‡ä»¶åå’Œæ•°æ®å€¼ï¼Œé€‚åˆå¤šæ–‡ä»¶å¯¹æ¯”æ—¶è¯†åˆ«æ•°æ®æ¥æºã€‚</li>
                            <li><b>å…³é—­æ˜¾ç¤ºï¼š</b>å®Œå…¨ä¸æ˜¾ç¤ºæ•°æ®æµ®çª—ï¼Œè·å¾—æœ€å¹²å‡€çš„å›¾è¡¨è§†å›¾ã€‚</li>
                        </ul>
                    </li>
                    <li><b>Xè½´ç±»å‹ï¼š</b><code>æ•°å€¼(linear)</code> ç”¨äºè¿ç»­çš„æ•°å­—å‹Xè½´ï¼›<code>åˆ†ç±»(category)</code> ç”¨äºç¦»æ•£çš„ã€éæ•°å­—çš„Xè½´æ ‡ç­¾ã€‚</li>
                    <li><b>åŠ¨ç”»æ ‡é¢˜ / Xè½´æ ‡ç­¾ / Yè½´æ ‡ç­¾ï¼š</b>è‡ªå®šä¹‰å›¾è¡¨çš„æ ‡é¢˜å’Œåæ ‡è½´åç§°ã€‚</li>
                </ul>

                </ul>

                <h4>è§†é¢‘è®¾ç½®</h4>
                <ul>
                    <li><b>è§†é¢‘è´¨é‡ï¼š</b>é€šè¿‡"ä¿å­˜è§†é¢‘"æŒ‰é’®å³ä¾§çš„ä¸‹æ‹‰æ¡†é€‰æ‹©è¾“å‡ºè§†é¢‘è´¨é‡ï¼š
                        <ul>
                            <li><b>æ ‡æ¸… (480p)ï¼š</b>854Ã—480 åƒç´ ï¼Œ1 Mbpsï¼Œ30 fps - æ–‡ä»¶æœ€å°ï¼Œé€‚åˆå¿«é€Ÿé¢„è§ˆå’Œä½å¸¦å®½åœºæ™¯</li>
                            <li><b>é«˜æ¸… (720p)ï¼š</b>1280Ã—720 åƒç´ ï¼Œ2.5 Mbpsï¼Œ30 fps - å¹³è¡¡é€‰æ‹©ï¼Œæ¨èå¤§å¤šæ•°æ—¥å¸¸ä½¿ç”¨</li>
                            <li><b>è¶…æ¸… (1080p)ï¼š</b>1920Ã—1080 åƒç´ ï¼Œ5 Mbpsï¼Œ30 fps - æ ‡å‡†é«˜æ¸…ï¼Œé€‚åˆæ¼”ç¤ºå’Œåˆ†äº«</li>
                            <li><b>2Kï¼š</b>2560Ã—1440 åƒç´ ï¼Œ8 Mbpsï¼Œ30 fps - å‡†2Kç”»è´¨ï¼Œé€‚åˆé«˜è´¨é‡å±•ç¤º</li>
                            <li><b>4Kï¼š</b>3840Ã—2160 åƒç´ ï¼Œ15 Mbpsï¼Œ30 fps - æœ€ä½³ç”»è´¨ï¼Œé€‚åˆä¸“ä¸šç”¨é€”</li>
                        </ul>
                    </li>
                    <li><b>ä¿å­˜è§†é¢‘ï¼š</b>å®ŒæˆåŠ¨ç”»ç”Ÿæˆåï¼Œç‚¹å‡»"ä¿å­˜è§†é¢‘"æŒ‰é’®ï¼Œç³»ç»Ÿä¼šä½¿ç”¨å½“å‰é€‰æ‹©çš„è§†é¢‘è´¨é‡è®¾ç½®å¯¼å‡ºå®Œæ•´çš„åŠ¨ç”»è§†é¢‘ï¼ˆåŒ…å«æ‰€æœ‰æ•°æ®çº¿æ¡ï¼‰ã€‚</li>
                </ul>

                <h3>ç¼©æ”¾ä¸å¹³ç§»æ“ä½œ</h3>
                <p>å›¾è¡¨ç”Ÿæˆåï¼Œæ‚¨å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼è°ƒæ•´è§†å›¾èŒƒå›´ä»¥æ›´å¥½åœ°æŸ¥çœ‹æ•°æ®ç»†èŠ‚ï¼š</p>
                <h4>ç¼©æ”¾æ§åˆ¶</h4>
                <ul>
                    <li><b>ç¼©æ”¾ç›®æ ‡é€‰æ‹©ï¼š</b>å¯ä»¥é€‰æ‹©"XYè½´åŒæ­¥"ã€"ä»…Xè½´"æˆ–"ä»…Yè½´"ä½œä¸ºç¼©æ”¾å¯¹è±¡ï¼Œé»˜è®¤ä¸ºXYè½´åŒæ­¥ç¼©æ”¾ã€‚</li>
                    <li><b>ç¼©æ”¾æŒ‰é’®ï¼š</b>è®¾ç½®åŒºåŸŸçš„"æ”¾å¤§"ã€"ç¼©å°"ã€"é‡ç½®"æŒ‰é’®å¯ä»¥è°ƒæ•´åæ ‡è½´èŒƒå›´ã€‚æŒ‰é’®æ”¯æŒæœ€å¤§999999%ç¼©æ”¾ã€‚</li>
                    <li><b>ç¼©æ”¾æ»‘å—ï¼š</b>æ‹–æ‹½æ»‘å—å¯ä»¥ç²¾ç¡®æ§åˆ¶ç¼©æ”¾çº§åˆ«ï¼ˆ1%-1000%ï¼‰ï¼Œæ»‘å—ä»…é™åˆ¶æ»‘åŠ¨æ“ä½œã€‚</li>
                    <li><b>ç¼©æ”¾è¾“å…¥æ¡†ï¼š</b>ç›´æ¥è¾“å…¥ç¼©æ”¾ç™¾åˆ†æ¯”ï¼ˆ1%-999999%ï¼‰ï¼Œæ”¯æŒä»»æ„ç²¾ç¡®å€¼è®¾ç½®ã€‚</li>
                    <li><b>å¿«æ·é”®ï¼š</b>åœ¨å›¾è¡¨æ˜¾ç¤ºæ—¶ï¼ŒæŒ‰<code>+</code>é”®æ”¾å¤§ï¼ŒæŒ‰<code>-</code>é”®ç¼©å°ï¼ŒæŒ‰<code>0</code>é”®é‡ç½®è§†å›¾ã€‚</li>
                    <li><b>æ»šè½®ç¼©æ”¾ï¼š</b>åœ¨å›¾è¡¨åŒºåŸŸæŒ‰ä½<code>Ctrl</code>é”®ï¼ˆMacä¸º<code>Command</code>é”®ï¼‰+ æ»šè½®å‘ä¸Šæ»šåŠ¨æ”¾å¤§ï¼Œå‘ä¸‹æ»šåŠ¨ç¼©å°ã€‚</li>
                    <li><b>é¡µé¢æ»šåŠ¨ï¼š</b>åœ¨å›¾è¡¨åŒºåŸŸæ­£å¸¸ä½¿ç”¨é¼ æ ‡æ»šè½®å¯ä»¥æ»šåŠ¨é¡µé¢ï¼Œä¸ä¼šå½±å“å›¾è¡¨ç¼©æ”¾ã€‚</li>
                    <li><b>ä¿æŒæ¯”ä¾‹ï¼š</b>XYè½´åŒæ­¥ç¼©æ”¾æ—¶ä¼šè‡ªåŠ¨ä¿æŒXè½´å’ŒYè½´çš„åŸå§‹æ¯”ä¾‹ï¼Œç¡®ä¿æ•°æ®ä¸ä¼šå˜å½¢ã€‚</li>
                    <li><b>è‡ªåŠ¨èŒƒå›´å¤„ç†ï¼š</b>å½“Yè½´è®¾ç½®ä¸ºautoæ—¶ï¼Œç³»ç»Ÿä¼šè®°å½•åˆå§‹æ•°æ®èŒƒå›´ä½œä¸ºç¼©æ”¾é‡ç½®åŸç‚¹ã€‚æ‰‹åŠ¨è®¾ç½®ä¼˜å…ˆçº§é«˜äºautoè®¾ç½®ã€‚</li>
                </ul>
                <h4>å¹³ç§»æ“ä½œ</h4>
                <ul>
                    <li><b>é¼ æ ‡æ‹–æ‹½ï¼š</b>åœ¨å›¾è¡¨åŒºåŸŸæŒ‰ä½é¼ æ ‡å·¦é”®å¹¶æ‹–æ‹½ï¼Œå¯ä»¥å¹³ç§»è§†å›¾æŸ¥çœ‹ä¸åŒåŒºåŸŸçš„æ•°æ®ã€‚</li>
                </ul>
                <h4>å¸§å¯¼èˆªæ“ä½œ</h4>
                <ul>
                    <li><b>å·¦å³æ–¹å‘é”®ï¼š</b>æŒ‰<code>â†</code>é”®ä¸Šä¸€å¸§ï¼ŒæŒ‰<code>â†’</code>é”®ä¸‹ä¸€å¸§ã€‚</li>
                    <li><b>é•¿æŒ‰å¯¼èˆªï¼š</b>é•¿æŒ‰"ä¸Šä¸€å¸§"æˆ–"ä¸‹ä¸€å¸§"æŒ‰é’®0.5ç§’åå¼€å§‹è¿ç»­å¸§åˆ‡æ¢ï¼Œæ¯100æ¯«ç§’åˆ‡æ¢ä¸€å¸§ã€‚</li>
                    <li><b>é•¿æŒ‰æ–¹å‘é”®ï¼š</b>é•¿æŒ‰<code>â†</code>æˆ–<code>â†’</code>é”®åŒæ ·æ”¯æŒè¿ç»­å¸§åˆ‡æ¢åŠŸèƒ½ã€‚</li>
                </ul>

                <h3>æ—¶é—´åºåˆ—åˆ†æåŠŸèƒ½</h3>
                <p>é™¤äº†åŸºæœ¬çš„åŠ¨ç”»æ’­æ”¾å¤–ï¼Œæœ¬å·¥å…·è¿˜æä¾›äº†å¼ºå¤§çš„æ—¶é—´åºåˆ—åˆ†æåŠŸèƒ½ï¼Œè®©æ‚¨å¯ä»¥æ·±å…¥åˆ†æç‰¹å®šXä½ç½®çš„æ•°æ®å˜åŒ–è¶‹åŠ¿å¹¶è·å¾—è¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯ã€‚</p>
                <h4>ä½¿ç”¨æ–¹æ³•</h4>
                <ul>
                    <li><b>åŒå‡»è§¦å‘ï¼š</b>åœ¨åŠ¨ç”»æ’­æ”¾æˆ–æš‚åœçŠ¶æ€ä¸‹ï¼Œ<b>åŒå‡»å›¾è¡¨ç»˜å›¾åŒºåŸŸå†…çš„ä»»æ„ä½ç½®</b>ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ‰¾åˆ°è¯¥Xåæ ‡æœ€æ¥è¿‘çš„æ•°æ®ç‚¹å¹¶å¼¹å‡ºæ—¶é—´åºåˆ—åˆ†ææµ®çª—ã€‚</li>
                    <li><b>æŸ¥çœ‹æ—¶é—´åºåˆ—ï¼š</b>æµ®çª—ä¸­ä¼šæ˜¾ç¤ºè¯¥Xä½ç½®åœ¨æ‰€æœ‰æ—¶é—´å¸§ä¸­çš„æ•°æ®å˜åŒ–è¶‹åŠ¿å›¾ï¼ˆXè½´ï¼šæ—¶é—´ï¼ŒYè½´ï¼šæ•°å€¼ï¼‰ï¼Œé‡‡ç”¨æŠ˜çº¿å›¾æ˜¾ç¤ºã€‚</li>
                    <li><b>ç»Ÿè®¡ä¿¡æ¯ï¼š</b>æµ®çª—ä¼šè‡ªåŠ¨è®¡ç®—å¹¶æ˜¾ç¤ºè¯¥æ—¶é—´åºåˆ—çš„è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯ï¼ŒåŒ…æ‹¬æœ€å¤§å€¼ã€æœ€å°å€¼ã€å¹³å‡å€¼ã€æ ‡å‡†å·®ç­‰ã€‚</li>
                    <li><b>å…³é—­æµ®çª—ï¼š</b>ç‚¹å‡»æµ®çª—å³ä¸Šè§’çš„"Ã—"æŒ‰é’®ã€æŒ‰Escé”®æˆ–ç‚¹å‡»æµ®çª—å¤–éƒ¨åŒºåŸŸå‡å¯å…³é—­æ—¶é—´åºåˆ—æµ®çª—ã€‚</li>
                </ul>
                <h4>åŠŸèƒ½ç‰¹ç‚¹</h4>
                <ul>
                    <li><b>æ™ºèƒ½æ•°æ®æå–ï¼š</b>ç³»ç»Ÿä¼šè‡ªåŠ¨ä»CSVæ•°æ®ä¸­æå–åŒå‡»ä½ç½®Xåæ ‡å¯¹åº”çš„æ‰€æœ‰æ—¶é—´åºåˆ—æ•°æ®ï¼Œæ— éœ€ç²¾ç¡®ç‚¹å‡»æ•°æ®çº¿ã€‚</li>
                    <li><b>ç»Ÿè®¡ä¿¡æ¯åˆ†æï¼š</b>è‡ªåŠ¨è®¡ç®—6é¡¹å…³é”®ç»Ÿè®¡æŒ‡æ ‡ï¼Œå¸®åŠ©æ‚¨æ·±å…¥äº†è§£æ•°æ®ç‰¹å¾ï¼š
                        <ul>
                            <li><span style="color: #e74c3c;">æœ€å¤§å€¼</span> - æ•°æ®ä¸­çš„æœ€å¤§å€¼</li>
                            <li><span style="color: #27ae60;">æœ€å°å€¼</span> - æ•°æ®ä¸­çš„æœ€å°å€¼</li>
                            <li><span style="color: #3498db;">å¹³å‡å€¼</span> - æ•°æ®çš„ç®—æœ¯å¹³å‡å€¼</li>
                            <li><span style="color: #9b59b6;">æ ‡å‡†å·®</span> - æ•°æ®ç¦»æ•£ç¨‹åº¦çš„åº¦é‡</li>
                            <li><span style="color: #34495e;">æ•°æ®ç‚¹æ•°</span> - æœ‰æ•ˆæ•°æ®ç‚¹çš„æ•°é‡</li>
                            <li><span style="color: #f39c12;">å˜åŒ–èŒƒå›´</span> - æœ€å¤§å€¼ä¸æœ€å°å€¼çš„å·®</li>
                        </ul>
                    </li>
                    <li><b>äº¤äº’å¼å›¾è¡¨ï¼š</b>æ—¶é—´åºåˆ—å›¾è¡¨æ”¯æŒé¼ æ ‡æ‚¬åœæŸ¥çœ‹å…·ä½“æ•°å€¼ï¼Œä¾¿äºç²¾ç¡®åˆ†æã€‚é»˜è®¤é‡‡ç”¨ç¼©ç•¥æ˜¾ç¤ºæ¨¡å¼ï¼Œä»…æ˜¾ç¤ºæ•°æ®å€¼ï¼Œç•Œé¢ç®€æ´ã€‚</li>
                    <li><b>åŠ¨æ€æ ‡é¢˜ï¼š</b>æµ®çª—æ ‡é¢˜ä¼šæ˜¾ç¤ºXè½´æ ‡ç­¾å’Œä½ç½®ï¼Œä¾¿äºè¯†åˆ«ä¸åŒçš„æ—¶é—´åºåˆ—ã€‚</li>
                    <li><b>è‡ªåŠ¨æ•°æ®è¿‡æ»¤ï¼š</b>ç³»ç»Ÿä¼šè‡ªåŠ¨è¿‡æ»¤æ— æ•ˆæ•°æ®ï¼ˆnullã€undefinedã€NaNï¼‰ï¼Œç¡®ä¿ç»Ÿè®¡ç»“æœçš„å‡†ç¡®æ€§ã€‚</li>
                </ul>
                <h4>åº”ç”¨åœºæ™¯</h4>
                <ul>
                    <li><b>ä¿¡å·åˆ†æï¼š</b>åˆ†æç‰¹å®šé¢‘ç‡çš„ä¿¡å·å¼ºåº¦éšæ—¶é—´å˜åŒ–ï¼Œè¯†åˆ«ä¿¡å·ç‰¹å¾å’Œå¼‚å¸¸</li>
                    <li><b>å…‰è°±ç ”ç©¶ï¼š</b>è§‚å¯ŸæŸä¸ªæ³¢é•¿ä½ç½®çš„å…‰è°±å˜åŒ–è¶‹åŠ¿ï¼Œåˆ†æææ–™ç‰¹æ€§</li>
                    <li><b>æ¸©åº¦ç›‘æ§ï¼š</b>ç›‘æ§ç‰¹å®šæ¸©åº¦ç‚¹çš„å†å²æ•°æ®å˜åŒ–ï¼Œè¯„ä¼°ç³»ç»Ÿç¨³å®šæ€§</li>
                    <li><b>è´¨é‡æ§åˆ¶ï¼š</b>å¯¹æ¯”ä¸åŒä½ç½®çš„æ—¶é—´ç‰¹å¾ï¼Œå‘ç°ç”Ÿäº§è¿‡ç¨‹ä¸­çš„å¼‚å¸¸æ¨¡å¼</li>
                    <li><b>ç§‘å­¦ç ”ç©¶ï¼š</b>åˆ†æå®éªŒæ•°æ®ä¸­ç‰¹å®šå‚æ•°çš„æ—¶é—´æ¼”åŒ–è§„å¾‹</li>
                    <li><b>å·¥ç¨‹ç›‘æµ‹ï¼š</b>ç›‘æµ‹è®¾å¤‡è¿è¡Œå‚æ•°çš„å˜åŒ–è¶‹åŠ¿ï¼Œè¿›è¡Œé¢„æµ‹æ€§ç»´æŠ¤</li>
                </ul>

                <h3>å¿«æ·é”®å‚è€ƒ</h3>
                <ul>
                    <li><b>ç©ºæ ¼é”®ï¼š</b>æ’­æ”¾/æš‚åœåŠ¨ç”»</li>
                    <li><b>â†é”®ï¼š</b>ä¸Šä¸€å¸§ï¼ˆæ”¯æŒé•¿æŒ‰è¿ç»­åˆ‡æ¢ï¼‰</li>
                    <li><b>â†’é”®ï¼š</b>ä¸‹ä¸€å¸§ï¼ˆæ”¯æŒé•¿æŒ‰è¿ç»­åˆ‡æ¢ï¼‰</li>
                    <li><b>+ é”®ï¼š</b>æ”¾å¤§åæ ‡è½´</li>
                    <li><b>- é”®ï¼š</b>ç¼©å°åæ ‡è½´</li>
                    <li><b>0 é”®ï¼š</b>é‡ç½®åæ ‡è½´è§†å›¾</li>
                    <li><b>Ctrl+æ»šè½®ï¼š</b>åœ¨å›¾è¡¨åŒºåŸŸæŒ‰ä½Ctrl+æ»šè½®è¿›è¡Œç¼©æ”¾ï¼ˆMacä¸ºCommand+æ»šè½®ï¼‰</li>
                    <li><b>F1é”®ï¼š</b>æ‰“å¼€å¸®åŠ©çª—å£</li>
                    <li><b>F5é”®ï¼š</b>åˆ·æ–°ç½‘é¡µå¹¶å®Œå…¨é‡ç½®æ‰€æœ‰æ•°æ®ï¼ˆæ¸…é™¤å›¾è¡¨ã€è®¾ç½®ã€æ–‡ä»¶è®°å½•ç­‰ï¼‰</li>
                    <li><b>Ctrl+Rï¼š</b>åˆ·æ–°å½“å‰æ–‡ä»¶ï¼ˆé‡æ–°è¯»å–CSVæ•°æ®ï¼Œä¿æŒè®¾ç½®ä¸å˜ï¼‰</li>
                    <li><b>Ctrl+Oï¼š</b>æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨ï¼ˆå¯¼å…¥æ–°æ–‡ä»¶ï¼‰</li>
                    <li><b>Escé”®ï¼š</b>å…³é—­å¸®åŠ©çª—å£å’Œæ—¶é—´åºåˆ—æµ®çª—</li>
                </ul>

                <h4>é‡è¦è¯´æ˜</h4>
                <ul>
                    <li><b>F5 vs Ctrl+Rï¼š</b>F5ä¼šå®Œå…¨é‡ç½®é¡µé¢ï¼Œä¸¢å¤±æ‰€æœ‰å·¥ä½œï¼›Ctrl+Råªåˆ·æ–°æ–‡ä»¶æ•°æ®ï¼Œä¿æŒæ‚¨çš„è®¾ç½®ä¸å˜ã€‚</li>
                    <li><b>è¾“å…¥æ¡†ä¾‹å¤–ï¼š</b>æ‰€æœ‰å¿«æ·é”®åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥æ—¶éƒ½ä¸ä¼šç”Ÿæ•ˆï¼Œé¿å…å¹²æ‰°æ–‡æœ¬ç¼–è¾‘ã€‚</li>
                </ul>

                <h3>ä½œè€…ä¸ç‰ˆæœ¬ä¿¡æ¯</h3>
                <ul>
                    <li><b>ä½œè€…ï¼š</b>ç±³åšå®‡</li>
                    <li><b>é‚®ç®±ï¼š</b><a href="mailto:miboyu@yeah.net">miboyu@yeah.net</a></li>
                    <li><b>ç‰ˆæœ¬ï¼š</b>v1.0.2 (2025-01-08)</li>
                </ul>

                <h4>æ›´æ–°æ—¥å¿—</h4>
                <ul>
                    <li><b>v1.0.2 (2025-01-08)ï¼š</b>ä¼˜åŒ– CDN åŠ è½½æœºåˆ¶ - å®ç°å¤š CDN è‡ªåŠ¨åˆ‡æ¢åŠ è½½ç³»ç»Ÿï¼ˆæ”¯æŒ BootCDNã€Staticfileã€Baomitu ç­‰å›½å†… CDNï¼‰ï¼Œå½»åº•è§£å†³å›½å†…ç½‘ç»œç¯å¢ƒä¸‹ Chart.js åº“åŠ è½½å¤±è´¥é—®é¢˜ï¼›å¢å¼ºé”™è¯¯è¯Šæ–­åŠŸèƒ½ï¼Œæä¾›è¯¦ç»†çš„åŠ è½½çŠ¶æ€æç¤ºå’Œè§£å†³æ–¹æ¡ˆ</li>
                    <li><b>v1.0.1 (2025-12-16)ï¼š</b>ä¿®å¤ Windows å¹³å°å…¼å®¹æ€§é—®é¢˜ - å°†æ‰€æœ‰ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦çš„ Math.min/max è°ƒç”¨æ”¹ä¸ºå¾ªç¯å®ç°ï¼Œè§£å†³å¤§å‹ CSV æ–‡ä»¶åœ¨ Windows æµè§ˆå™¨ä¸­å› å‚æ•°æ•°é‡é™åˆ¶å¯¼è‡´çš„ RangeError å¼‚å¸¸</li>
                    <li><b>v1.0.0 (2025-09-25)ï¼š</b>æ­£å¼å‘å¸ƒç‰ˆæœ¬ï¼Œå®Œæ•´çš„å¤šæ–‡ä»¶å¯¹æ¯”ã€æ—¶é—´åºåˆ—åˆ†æã€è§†é¢‘å¯¼å‡ºåŠŸèƒ½ï¼Œæ”¯æŒé«˜çº§ç¼©æ”¾ç³»ç»Ÿã€æµ®çª—æ˜¾ç¤ºæ¨¡å¼ã€æ–‡ä»¶è·¯å¾„è®°å¿†ã€æ‰¹é‡åˆ·æ–°ç­‰æ ¸å¿ƒåŠŸèƒ½</li>
                </ul>
                <footer>
                    <small>Â© 2025 ç±³åšå®‡. ä¿ç•™æ‰€æœ‰æƒåˆ©ã€‚</small><br/>
                    <small>è®¸å¯æ¡æ¬¾ï¼šé™¤éå¦æœ‰å£°æ˜ï¼Œå¦åˆ™æœ¬å·¥å…·åŠå…¶ä»£ç å’Œå†…å®¹å—ç‰ˆæƒä¿æŠ¤ï¼Œæœªç»æˆæƒä¸å¾—å¤åˆ¶ã€ä¿®æ”¹æˆ–åˆ†å‘ã€‚</small><br/>
                    <small>å…è´£å£°æ˜ï¼šæ­¤å·¥å…·â€œæŒ‰ç°çŠ¶â€æä¾›ï¼Œä¸ä½œä»»ä½•æ˜ç¤ºæˆ–æš—ç¤ºä¿è¯ï¼›ä½œè€…ä¸å¯¹ä½¿ç”¨ç»“æœæ‰¿æ‹…è´£ä»»ã€‚</small>
                </footer>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // === é¡µé¢åˆå§‹åŒ–ï¼šå®Œå…¨é‡ç½®åˆ°åˆå§‹çŠ¶æ€ ===
            console.log('ğŸ”„ é¡µé¢åŠ è½½ï¼Œé‡ç½®æ‰€æœ‰çŠ¶æ€åˆ°åˆå§‹å€¼');

            // ç¡®ä¿bodyå¯ä»¥è·å¾—ç„¦ç‚¹ï¼Œè¿™æ˜¯å¿«æ·é”®æ­£å¸¸å·¥ä½œçš„å…³é”®
            document.body.setAttribute('tabindex', '0');
            document.body.style.outline = 'none';

            // é¡µé¢åŠ è½½å®Œæˆåç«‹å³å°†ç„¦ç‚¹è®¾ç½®åˆ°body
            window.addEventListener('load', () => {
                document.body.focus();
            });

            // å…¨å±€ç‚¹å‡»äº‹ä»¶ï¼šç¡®ä¿ç‚¹å‡»éè¾“å…¥å…ƒç´ åç„¦ç‚¹å›åˆ°body
            document.addEventListener('click', (e) => {
                // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯è¾“å…¥ç±»å…ƒç´ ï¼Œä¸”å½“å‰ç„¦ç‚¹ä¸åœ¨è¾“å…¥ç±»å…ƒç´ ä¸Šï¼Œåˆ™å°†ç„¦ç‚¹è®¾ç½®åˆ°body
                const activeElement = document.activeElement;
                const isInputElement = activeElement.tagName === 'INPUT' ||
                                     activeElement.tagName === 'TEXTAREA' ||
                                     activeElement.tagName === 'SELECT' ||
                                     activeElement.isContentEditable;

                const targetIsInput = e.target.tagName === 'INPUT' ||
                                    e.target.tagName === 'TEXTAREA' ||
                                    e.target.tagName === 'SELECT' ||
                                    e.target.isContentEditable;

                if (!targetIsInput && !isInputElement) {
                    // å»¶è¿Ÿä¸€ç‚¹è®¾ç½®ç„¦ç‚¹ï¼Œç¡®ä¿ä¸å½±å“æ­£å¸¸çš„ç‚¹å‡»è¡Œä¸º
                    setTimeout(() => {
                        document.body.focus();
                    }, 0);
                }
            });

            // å…¨å±€å˜é‡
            let csvData = [];
            let csvFiles = []; // å­˜å‚¨å¤šä¸ªCSVæ–‡ä»¶æ•°æ®ï¼Œæ¯ä¸ªæ–‡ä»¶åŒ…å«: {file, data, fileName, displayName, fileHandle}
            let currentFileIndex = 0; // å½“å‰é€‰ä¸­çš„æ–‡ä»¶ç´¢å¼•
            let rememberedFileHandle = null; // è®°ä½çš„æ–‡ä»¶å¥æŸ„
            let rememberedFileDirectory = null; // è®°ä½çš„æ–‡ä»¶ç›®å½•ç±»å‹
            let lastOpenedFileHandle = null; // è®°å½•æœ€åä¸€æ¬¡æ‰“å¼€çš„æ–‡ä»¶å¥æŸ„ï¼Œç”¨äºä¸‹æ¬¡æ‰“å¼€æ—¶æ¢å¤è·¯å¾„
            let chart = null;
            let animationTimer = null;
            let currentFrameIndex = 0;
            let isPlaying = false;
            let frameData = [];
            let allFilesFrameData = []; // å­˜å‚¨æ‰€æœ‰æ–‡ä»¶çš„å¸§æ•°æ®
            let constantRowsData = []; // å­˜å‚¨å¸¸æ˜¾è¡Œæ•°æ®ï¼ˆæ¥è‡ªæ‰€æœ‰æ–‡ä»¶ï¼‰
            let csvFileName = ''; // å­˜å‚¨æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰
            let parseAbortController = null; // ç”¨äºå–æ¶ˆæ–‡ä»¶è§£æ
            let isRecording = false; // è§†é¢‘å½•åˆ¶çŠ¶æ€
            let recordingAbortController = null; // ç”¨äºå–æ¶ˆå½•åˆ¶
            let recordingToast = null; // å½•åˆ¶è¿›åº¦Toastçš„å¼•ç”¨

            // é¡µé¢å®Œå…¨é‡ç½®å‡½æ•°
            function resetToInitialState() {
                console.log('ğŸ”„ æ‰§è¡Œå®Œå…¨é‡ç½®åˆ°åˆå§‹çŠ¶æ€');
                csvData = [];
                rememberedFileHandle = null;
                rememberedFileDirectory = null;
                lastOpenedFileHandle = null;
                chart = null;
                animationTimer = null;
                currentFrameIndex = 0;
                isPlaying = false;
                frameData = [];
                constantRowsData = [];
                csvFileName = '';
                parseAbortController = null;
                isRecording = false;
                recordingAbortController = null;
                recordingToast = null;

                // é‡ç½®ç¼©æ”¾ç›¸å…³å˜é‡
                axisZoomLevel = 1.0;
                xAxisZoomLevel = 1.0;
                yAxisZoomLevel = 1.0;
                axisPanOffset = { x: 0, y: 0 };
                originalAxisLimits = null;
                originalAxisRatio = null;
                isPanning = false;
                hasPanned = false;

                // é‡ç½®UIçŠ¶æ€
                uploadSection.classList.remove('has-file');
                uploadPrompt.classList.remove('hidden');
                dataPreviewSection.classList.add('hidden');
                configSection.classList.add('hidden');
                chartSection.classList.add('hidden');

                // æ¸…ç©ºé¢„è§ˆæ•°æ®
                dataPreview.innerHTML = '';
                fileName.textContent = '';

                console.log('âœ… é¡µé¢çŠ¶æ€å·²å®Œå…¨é‡ç½®');
            }

            // é¡µé¢åŠ è½½æ—¶ä¸æ‰§è¡Œå®Œå…¨é‡ç½®ï¼Œè®©ç”¨æˆ·å¯ä»¥æ­£å¸¸å¯¼å…¥æ–‡ä»¶
            // resetToInitialState();

            // åæ ‡è½´ç¼©æ”¾ç›¸å…³å˜é‡
            let axisZoomLevel = 1.0; // åæ ‡è½´ç¼©æ”¾çº§åˆ« (1.0 = 100%)
            let xAxisZoomLevel = 1.0; // Xè½´ç‹¬ç«‹ç¼©æ”¾çº§åˆ«
            let yAxisZoomLevel = 1.0; // Yè½´ç‹¬ç«‹ç¼©æ”¾çº§åˆ«
            let axisPanOffset = { x: 0, y: 0 }; // åæ ‡è½´å¹³ç§»åç§»é‡
            let originalAxisLimits = null; // åŸå§‹åæ ‡è½´èŒƒå›´
            let originalAxisRatio = null; // åŸå§‹åæ ‡è½´æ¯”ä¾‹ (width/height)
            let isPanning = false; // æ˜¯å¦æ­£åœ¨å¹³ç§»
            let panStartPos = { x: 0, y: 0 }; // å¹³ç§»èµ·å§‹ä½ç½®
            let hasPanned = false; // æ˜¯å¦å·²ç»å¹³ç§»è¿‡


            // é•¿æŒ‰ç›¸å…³å˜é‡
            let frameNavTimer = null; // å¸§å¯¼èˆªå®šæ—¶å™¨

            // æ£€æµ‹æ–‡ä»¶ç›®å½•ç±»å‹
            function detectFileDirectory(fileName) {
                if (!fileName) return 'documents';

                const lowerName = fileName.toLowerCase();

                // æ£€æŸ¥å®Œæ•´è·¯å¾„ä¸­çš„ç›®å½•æç¤ºï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                if (lowerName.includes('/users/') || lowerName.includes('\\users\\')) {
                    const pathParts = lowerName.split(/[/\\]/);

                    // æ£€æŸ¥ç”¨æˆ·ç›®å½•ä¸‹çš„å­ç›®å½•
                    for (let i = 0; i < pathParts.length; i++) {
                        const part = pathParts[i];
                        if (part.includes('desktop') || part.includes('æ¡Œé¢')) {
                            return 'desktop';
                        }
                        if (part.includes('download') || part.includes('ä¸‹è½½')) {
                            return 'downloads';
                        }
                        if (part.includes('document') || part.includes('æ–‡æ¡£')) {
                            return 'documents';
                        }
                        if (part.includes('picture') || part.includes('å›¾ç‰‡') || part.includes('image')) {
                            return 'pictures';
                        }
                        if (part.includes('video') || part.includes('è§†é¢‘') || part.includes('movie')) {
                            return 'videos';
                        }
                        if (part.includes('music') || part.includes('éŸ³ä¹') || part.includes('audio')) {
                            return 'music';
                        }
                    }
                }

                // æ£€æŸ¥æ–‡ä»¶åä¸­çš„ç›®å½•æç¤º
                if (lowerName.includes('desktop') || lowerName.includes('æ¡Œé¢')) {
                    return 'desktop';
                }
                if (lowerName.includes('download') || lowerName.includes('ä¸‹è½½')) {
                    return 'downloads';
                }
                if (lowerName.includes('document') || lowerName.includes('æ–‡æ¡£')) {
                    return 'documents';
                }
                if (lowerName.includes('picture') || lowerName.includes('å›¾ç‰‡') || lowerName.includes('image')) {
                    return 'pictures';
                }
                if (lowerName.includes('video') || lowerName.includes('è§†é¢‘') || lowerName.includes('movie')) {
                    return 'videos';
                }
                if (lowerName.includes('music') || lowerName.includes('éŸ³ä¹') || lowerName.includes('audio')) {
                    return 'music';
                }

                // æ ¹æ®æ–‡ä»¶åæ¨¡å¼æ¨æ–­ç›®å½•ç±»å‹
                const baseName = fileName.replace(/\.[^/.]+$/, "");

                // å¦‚æœæ–‡ä»¶ååŒ…å«å¯¼å‡ºã€æ•°æ®ã€æŠ¥å‘Šç­‰å…³é”®è¯ï¼Œå¾ˆå¯èƒ½åœ¨ä¸‹è½½æˆ–æ–‡æ¡£ç›®å½•
                if (baseName.includes('export') || baseName.includes('å¯¼å‡º') ||
                    baseName.includes('data') || baseName.includes('æ•°æ®') ||
                    baseName.includes('report') || baseName.includes('æŠ¥å‘Š') ||
                    baseName.includes('output') || baseName.includes('è¾“å‡º') ||
                    baseName.includes('result') || baseName.includes('ç»“æœ')) {
                    // ä¼˜å…ˆè¿”å›ä¸‹è½½ç›®å½•ï¼Œå› ä¸ºå¯¼å‡ºæ–‡ä»¶é€šå¸¸å…ˆåœ¨ä¸‹è½½ç›®å½•
                    return 'downloads';
                }

                // å¦‚æœæ–‡ä»¶ååŒ…å«é¡¹ç›®ã€å·¥ä½œç­‰å…³é”®è¯ï¼Œå¾ˆå¯èƒ½åœ¨æ–‡æ¡£ç›®å½•
                if (baseName.includes('project') || baseName.includes('é¡¹ç›®') ||
                    baseName.includes('work') || baseName.includes('å·¥ä½œ') ||
                    baseName.includes('task') || baseName.includes('ä»»åŠ¡')) {
                    return 'documents';
                }

                // å¦‚æœæ–‡ä»¶ååŒ…å«ä¸´æ—¶ã€æµ‹è¯•ç­‰å…³é”®è¯ï¼Œå¯èƒ½åœ¨æ¡Œé¢
                if (baseName.includes('temp') || baseName.includes('ä¸´æ—¶') ||
                    baseName.includes('test') || baseName.includes('æµ‹è¯•') ||
                    baseName.includes('demo') || baseName.includes('æ¼”ç¤º')) {
                    return 'desktop';
                }

                // æ ¹æ®æ–‡ä»¶æ‰©å±•åæ¨æ–­ç›®å½•ç±»å‹
                if (lowerName.endsWith('.csv') || lowerName.endsWith('.xlsx') || lowerName.endsWith('.xls')) {
                    return 'documents'; // æ•°æ®æ–‡ä»¶é€šå¸¸åœ¨æ–‡æ¡£ç›®å½•
                }
                if (lowerName.endsWith('.jpg') || lowerName.endsWith('.jpeg') || lowerName.endsWith('.png') ||
                    lowerName.endsWith('.gif') || lowerName.endsWith('.bmp')) {
                    return 'pictures';
                }
                if (lowerName.endsWith('.mp4') || lowerName.endsWith('.avi') || lowerName.endsWith('.mov') ||
                    lowerName.endsWith('.wmv') || lowerName.endsWith('.flv')) {
                    return 'videos';
                }
                if (lowerName.endsWith('.mp3') || lowerName.endsWith('.wav') || lowerName.endsWith('.flac') ||
                    lowerName.endsWith('.aac')) {
                    return 'music';
                }

                // é»˜è®¤è¿”å›æ–‡æ¡£ç›®å½•
                return 'documents';
            }

                  let frameNavDirection = 0; // å¸§å¯¼èˆªæ–¹å‘ (-1: ä¸Šä¸€å¸§, 1: ä¸‹ä¸€å¸§, 0: æ— )
            let longPressDelay = 500; // é•¿æŒ‰å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
            let frameNavInterval = 100; // å¸§å¯¼èˆªé—´éš”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

            // æ—¶é—´åºåˆ—æµ®çª—ç›¸å…³å˜é‡
            let timeSeriesChart = null; // æ—¶é—´åºåˆ—å›¾è¡¨å®ä¾‹
            let clickedDataPoint = null; // ç‚¹å‡»çš„æ•°æ®ç‚¹ä¿¡æ¯

            // è®°å½•å“ªäº›å­—æ®µè¢«æ‰‹åŠ¨ä¿®æ”¹è¿‡
            let manuallyModified = new Set();

            // DOMå…ƒç´ 
            const uploadSection = document.getElementById('uploadSection');
            const uploadPrompt = document.getElementById('uploadPrompt');
            const globalDropOverlay = document.getElementById('globalDropOverlay');
            const initialUploadBtn = document.getElementById('initialUploadBtn');
            const uploadBtn = document.getElementById('uploadBtn');
            const fileInput = document.getElementById('fileInput');
            const refreshFileBtn = document.getElementById('refreshFileBtn');
            const clearFilesBtn = document.getElementById('clearFilesBtn');
            const fileName = document.getElementById('fileName');
            const dataPreviewSection = document.getElementById('dataPreviewSection');
            const dataPreview = document.getElementById('dataPreview');
            const configSection = document.getElementById('configSection');

            // æ–‡ä»¶ç®¡ç†ç›¸å…³å…ƒç´ 
            const addFileBtn = document.getElementById('addFileBtn');
            const fileTabsContainer = document.getElementById('fileTabsContainer');
            const fileTabs = document.getElementById('fileTabs');

            const generateChartBtn = document.getElementById('generateChartBtn');
            const saveVideoBtn = document.getElementById('saveVideoBtn');
            const resetBtn = document.getElementById('resetBtn');
            const chartSection = document.getElementById('chartSection');
            const chartContainer = document.getElementById('chartContainer');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const prevFrameBtn = document.getElementById('prevFrameBtn');
            const nextFrameBtn = document.getElementById('nextFrameBtn');
            const currentFrameSpan = document.getElementById('currentFrame');
            const totalFramesSpan = document.getElementById('totalFrames');
            const progressBar = document.getElementById('progressBar');
            const progressContainer = document.getElementById('progressContainer');
            const toastContainer = document.getElementById('toastContainer');
            const mainContainer = document.getElementById('mainContainer');

            // --- å¸®åŠ©æµ®çª—å…ƒç´  ---
            const helpBtn = document.getElementById('helpBtn');
            const helpModal = document.getElementById('helpModal');
            const helpModalClose = document.getElementById('helpModalClose');

            // æ—¶é—´åºåˆ—æµ®çª—å…ƒç´ 
            const timeSeriesModal = document.getElementById('timeSeriesModal');
            const timeSeriesModalClose = document.getElementById('timeSeriesModalClose');
            const timeSeriesModalTitle = document.getElementById('timeSeriesModalTitle');
            const clickedPosition = document.getElementById('clickedPosition');
            const timeSeriesStats = document.getElementById('timeSeriesStats');
            const statsMax = document.getElementById('statsMax');
            const statsMin = document.getElementById('statsMin');
            const statsAvg = document.getElementById('statsAvg');
            const statsStd = document.getElementById('statsStd');
            const statsCount = document.getElementById('statsCount');
            const statsRange = document.getElementById('statsRange');
            const timeSeriesChartContainer = document.getElementById('timeSeriesChart');

            // è®¾ç½®å…ƒç´ 
            const xAxisRowInput = document.getElementById('xAxisRow');
            const startRowInput = document.getElementById('startRow');
            const endRowInput = document.getElementById('endRow');
            const startColInput = document.getElementById('startCol');
            const endColInput = document.getElementById('endCol');
            const constantRowsInput = document.getElementById('constantRows');
            const frameIntervalInput = document.getElementById('frameInterval');
            const skipFramesInput = document.getElementById('skipFrames');
            const xMinInput = document.getElementById('xMin');
            const xMaxInput = document.getElementById('xMax');
            const yMinInput = document.getElementById('yMin');
            const yMaxInput = document.getElementById('yMax');
            const showLegendSelect = document.getElementById('showLegend');
            const tooltipModeSelect = document.getElementById('tooltipMode');
            const xAxisTypeSelect = document.getElementById('xAxisType');
            const chartTitleInput = document.getElementById('chartTitle');
            const xAxisLabelInput = document.getElementById('xAxisLabel');
            const yAxisLabelInput = document.getElementById('yAxisLabel');

            // è§†é¢‘è´¨é‡è®¾ç½®å…ƒç´ 
            const videoQualitySelect = document.getElementById('videoQuality');

            // åæ ‡è½´ç¼©æ”¾æ§åˆ¶å…ƒç´ 
            const axisZoomTarget = document.getElementById('axisZoomTarget');
            const axisZoomInBtn = document.getElementById('axisZoomInBtn');
            const axisZoomOutBtn = document.getElementById('axisZoomOutBtn');
            const axisResetBtn = document.getElementById('axisResetBtn');
            const axisZoomSlider = document.getElementById('axisZoomSlider');
            const axisZoomInput = document.getElementById('axisZoomInput');

            // --- å¸®åŠ©æµ®çª—é€»è¾‘ ---
            helpBtn.onclick = function() {
                helpModal.style.display = "block";
            }
            helpModalClose.onclick = function() {
                helpModal.style.display = "none";
            }
            window.onclick = function(event) {
                if (event.target == helpModal) {
                    helpModal.style.display = "none";
                }
                if (event.target == timeSeriesModal) {
                    closeTimeSeriesModal();
                }
            }
            // æ—¶é—´åºåˆ—æµ®çª—äº‹ä»¶ç›‘å¬å™¨
            timeSeriesModalClose.onclick = function() {
                closeTimeSeriesModal();
            }

            window.onkeydown = function(event) {
                if (event.key === "Escape") {
                     helpModal.style.display = "none";
                     closeTimeSeriesModal();
                }

                // æ£€æŸ¥æ˜¯å¦åœ¨è¾“å…¥æ¡†ä¸­ï¼Œå¦‚æœæ˜¯åˆ™ä¸å¤„ç†å¿«æ·é”®
                const activeElement = document.activeElement;
                const isInputElement = activeElement.tagName === 'INPUT' ||
                                     activeElement.tagName === 'TEXTAREA' ||
                                     activeElement.tagName === 'SELECT' ||
                                     activeElement.isContentEditable;

                // å…¨å±€å¿«æ·é”®ï¼ˆä¸åœ¨è¾“å…¥æ¡†ä¸­æ—¶ç”Ÿæ•ˆï¼‰
                if (!isInputElement) {
                    // F1 - æ‰“å¼€å¸®åŠ©
                    if (event.key === 'F1') {
                        event.preventDefault();
                        helpModal.style.display = "block";
                        return;
                    }

                    // F5 - åˆ·æ–°ç½‘é¡µé‡ç½®
                    if (event.key === 'F5') {
                        event.preventDefault();
                        if (confirm('ç¡®å®šè¦åˆ·æ–°é¡µé¢å¹¶é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
                            window.location.reload();
                        }
                        return;
                    }

                    // Ctrl+R - åˆ·æ–°å½“å‰æ–‡ä»¶
                    if (event.ctrlKey && event.key === 'r') {
                        event.preventDefault();
                        refreshCurrentFile();
                        return;
                    }

                    // Ctrl+O - æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨
                    if (event.ctrlKey && event.key === 'o') {
                        event.preventDefault();
                        selectFileWithPermission();
                        return;
                    }
                }

                // ç©ºæ ¼é”®æ’­æ”¾/æš‚åœï¼šåªè¦å›¾è¡¨å·²ç”Ÿæˆä¸”ä¸åœ¨è¾“å…¥æ¡†ä¸­å°±ç”Ÿæ•ˆ
                if (chart && !isInputElement && event.key === ' ') {
                    event.preventDefault();
                    togglePlayPause();
                }

                // å¸§å¯¼èˆªå¿«æ·é”®ï¼ˆä»…åœ¨å›¾è¡¨æ˜¾ç¤ºæ—¶ç”Ÿæ•ˆä¸”ä¸åœ¨è¾“å…¥æ¡†ä¸­ï¼‰
                if (!chartSection.classList.contains('hidden') && !isInputElement) {
                    switch(event.key) {
                        case 'ArrowLeft':
                            if (chart && !event.ctrlKey && !event.altKey) {
                                event.preventDefault();
                                // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œå…ˆæš‚åœ
                                if (isPlaying) {
                                    togglePlayPause();
                                }
                                navigateFrame(-1);
                            }
                            break;
                        case 'ArrowRight':
                            if (chart && !event.ctrlKey && !event.altKey) {
                                event.preventDefault();
                                // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œå…ˆæš‚åœ
                                if (isPlaying) {
                                    togglePlayPause();
                                }
                                navigateFrame(1);
                            }
                            break;
                        case '+':
                        case '=':
                            if (chart && !event.ctrlKey && !event.altKey) {
                                event.preventDefault();
                                axisZoomIn();
                            }
                            break;
                        case '-':
                        case '_':
                            if (chart && !event.ctrlKey && !event.altKey) {
                                event.preventDefault();
                                axisZoomOut();
                            }
                            break;
                        case '0':
                            if (chart && !event.ctrlKey && !event.altKey) {
                                event.preventDefault();
                                resetAxisZoom();
                            }
                            break;
                    }
                }
            }
            // Toasté€šçŸ¥ç³»ç»Ÿ
            function showToast(message, type = 'info', options = {}) {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;

                const content = document.createElement('div');
                content.className = 'toast-content';
                content.innerHTML = message;

                const actions = document.createElement('div');
                actions.className = 'toast-actions';

                // æ·»åŠ å–æ¶ˆæŒ‰é’®ï¼ˆå¦‚æœéœ€è¦ï¼‰
                if (options.showCancel && options.onCancel) {
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'toast-cancel-btn';
                    cancelBtn.textContent = options.cancelText || 'å–æ¶ˆ';
                    cancelBtn.onclick = () => {
                        options.onCancel();
                        removeToast(toast);
                    };
                    actions.appendChild(cancelBtn);
                }

                // æ·»åŠ å…³é—­æŒ‰é’®
                if (!options.persistent) {
                    const closeBtn = document.createElement('button');
                    closeBtn.className = 'toast-close';
                    closeBtn.innerHTML = 'Ã—';
                    closeBtn.onclick = () => removeToast(toast);
                    actions.appendChild(closeBtn);
                }

                toast.appendChild(content);
                toast.appendChild(actions);
                toast.contentElement = content; // ä¿å­˜contentå…ƒç´ çš„å¼•ç”¨ä»¥ä¾¿æ›´æ–°
                toast.actionsElement = actions; // ä¿å­˜actionså…ƒç´ çš„å¼•ç”¨ä»¥ä¾¿æ›´æ–°
                toastContainer.appendChild(toast);

                // è§¦å‘æ˜¾ç¤ºåŠ¨ç”»
                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);

                // è‡ªåŠ¨ç§»é™¤ï¼ˆé™¤éæ˜¯æŒä¹…çš„ï¼‰
                if (!options.persistent) {
                    setTimeout(() => {
                        removeToast(toast);
                    }, options.duration || 3000);
                }

                return toast;
            }

            // æ›´æ–°Toastå†…å®¹
            function updateToast(toast, message, options = {}) {
                if (toast && toast.contentElement) {
                    toast.contentElement.innerHTML = message;

                    // æ›´æ–°å–æ¶ˆæŒ‰é’®ï¼ˆå¦‚æœéœ€è¦ï¼‰
                    if (options.showCancel !== undefined) {
                        const existingCancelBtn = toast.actionsElement.querySelector('.toast-cancel-btn');

                        if (options.showCancel && options.onCancel) {
                            if (!existingCancelBtn) {
                                const cancelBtn = document.createElement('button');
                                cancelBtn.className = 'toast-cancel-btn';
                                cancelBtn.textContent = options.cancelText || 'å–æ¶ˆ';
                                cancelBtn.onclick = () => {
                                    options.onCancel();
                                    removeToast(toast);
                                };
                                // æ’å…¥åˆ°å…³é—­æŒ‰é’®ä¹‹å‰
                                const closeBtn = toast.actionsElement.querySelector('.toast-close');
                                if (closeBtn) {
                                    toast.actionsElement.insertBefore(cancelBtn, closeBtn);
                                } else {
                                    toast.actionsElement.appendChild(cancelBtn);
                                }
                            } else {
                                existingCancelBtn.textContent = options.cancelText || 'å–æ¶ˆ';
                                existingCancelBtn.onclick = () => {
                                    options.onCancel();
                                    removeToast(toast);
                                };
                            }
                        } else if (existingCancelBtn) {
                            existingCancelBtn.remove();
                        }
                    }
                }
            }

            function removeToast(toast) {
                if (toast && toast.parentNode) {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }
            }

            function clearToasts() {
                const toasts = toastContainer.querySelectorAll('.toast');
                toasts.forEach(removeToast);
            }

            // æ·»åŠ è¾“å…¥äº‹ä»¶ç›‘å¬å™¨æ¥åˆ‡æ¢æ ·å¼
            function addInputListener(element, fieldName) {
                element.addEventListener('input', function() {
                    // åªåœ¨è¾“å…¥è¿‡ç¨‹ä¸­æ ‡è®°ä¸ºæ‰‹åŠ¨ä¿®æ”¹ï¼Œä¸å¼ºåˆ¶å¡«å……é»˜è®¤å€¼
                    manuallyModified.add(fieldName);
                    element.classList.remove('default-value');
                    element.classList.add('manual-value');

                    // ç‰¹æ®Šå¤„ç†ï¼šå¸¸æ˜¾è¡Œæ”¹å˜æ—¶è‡ªåŠ¨è°ƒæ•´æ˜¾ç¤ºå›¾ä¾‹
                    if (fieldName === 'constantRows') {
                        updateLegendDisplay();
                    }
                });

                // å¤±å»ç„¦ç‚¹æ—¶æ£€æŸ¥æ˜¯å¦éœ€è¦æ¢å¤é»˜è®¤å€¼
                element.addEventListener('blur', function() {
                    if (element.value.trim() === '') {
                        // è°ƒç”¨ç›¸åº”çš„æ›´æ–°å‡½æ•°æ¥æ¢å¤åŠ¨æ€é»˜è®¤å€¼
                        restoreDefaultValue(fieldName);
                        manuallyModified.delete(fieldName);
                    }
                });

                // å¯¹äºå¸¸æ˜¾è¡Œè¾“å…¥æ¡†ï¼Œè¿˜éœ€è¦ç›‘å¬changeäº‹ä»¶
                if (fieldName === 'constantRows') {
                    element.addEventListener('change', function() {
                        updateLegendDisplay();
                    });
                }
            }

            // æ ¹æ®å­—æ®µåæ¢å¤å¯¹åº”çš„åŠ¨æ€é»˜è®¤å€¼
            function restoreDefaultValue(fieldName) {
                switch(fieldName) {
                    case 'xMin':
                    case 'xMax':
                        updateXAxisRange();
                        break;
                    case 'xAxisLabel':
                        updateXAxisLabel();
                        break;
                    case 'chartTitle':
                        chartTitleInput.value = csvFileName || 'æ•°æ®åŠ¨ç”»';
                        chartTitleInput.classList.remove('manual-value');
                        chartTitleInput.classList.add('default-value');
                        break;
                    case 'yAxisLabel':
                        yAxisLabelInput.value = 'Yè½´';
                        yAxisLabelInput.classList.remove('manual-value');
                        yAxisLabelInput.classList.add('default-value');
                        break;
                    // å…¶ä»–å›ºå®šé»˜è®¤å€¼çš„å­—æ®µ
                    case 'xAxisRow':
                        xAxisRowInput.value = '1';
                        xAxisRowInput.classList.remove('manual-value');
                        xAxisRowInput.classList.add('default-value');
                        break;
                    case 'startRow':
                        const defaultStartRow = (parseInt(xAxisRowInput.value) || 1) + 1;
                        startRowInput.value = defaultStartRow.toString();
                        startRowInput.classList.remove('manual-value');
                        startRowInput.classList.add('default-value');
                        break;
                    case 'endRow':
                        endRowInput.value = '-1';
                        endRowInput.classList.remove('manual-value');
                        endRowInput.classList.add('default-value');
                        break;
                    case 'startCol':
                        startColInput.value = '2';
                        startColInput.classList.remove('manual-value');
                        startColInput.classList.add('default-value');
                        break;
                    case 'endCol':
                        endColInput.value = '-1';
                        endColInput.classList.remove('manual-value');
                        endColInput.classList.add('default-value');
                        break;
                    case 'constantRows':
                        constantRowsInput.value = '';
                        constantRowsInput.classList.remove('manual-value');
                        constantRowsInput.classList.add('default-value');
                        updateLegendDisplay();
                        break;
                    case 'frameInterval':
                        frameIntervalInput.value = '50';
                        frameIntervalInput.classList.remove('manual-value');
                        frameIntervalInput.classList.add('default-value');
                        break;
                    case 'skipFrames':
                        skipFramesInput.value = '0';
                        skipFramesInput.classList.remove('manual-value');
                        skipFramesInput.classList.add('default-value');
                        break;
                    case 'yMin':
                        yMinInput.value = 'auto';
                        yMinInput.classList.remove('manual-value');
                        yMinInput.classList.add('default-value');
                        break;
                    case 'yMax':
                        yMaxInput.value = 'auto';
                        yMaxInput.classList.remove('manual-value');
                        yMaxInput.classList.add('default-value');
                        break;
                    case 'showLegend':
                        showLegendSelect.value = 'false';
                        showLegendSelect.classList.remove('manual-value');
                        showLegendSelect.classList.add('default-value');
                        break;
                    case 'tooltipMode':
                        tooltipModeSelect.value = 'compact';
                        tooltipModeSelect.classList.remove('manual-value');
                        tooltipModeSelect.classList.add('default-value');
                        break;
                    case 'xAxisType':
                        xAxisTypeSelect.value = 'linear';
                        xAxisTypeSelect.classList.remove('manual-value');
                        xAxisTypeSelect.classList.add('default-value');
                        break;
                    case 'videoQuality':
                        videoQualitySelect.value = 'medium';
                        videoQualitySelect.classList.remove('manual-value');
                        videoQualitySelect.classList.add('default-value');
                        break;
                    case 'axisZoomTarget':
                        axisZoomTarget.value = 'xy';
                        axisZoomTarget.classList.remove('manual-value');
                        axisZoomTarget.classList.add('default-value');
                        break;
                    case 'axisZoomInput':
                        axisZoomInput.value = '100';
                        axisZoomInput.classList.remove('manual-value');
                        axisZoomInput.classList.add('default-value');
                        axisZoomSlider.value = '100';
                        break;
                }
            }

            // ä¸ºæ‰€æœ‰è®¾ç½®å­—æ®µæ·»åŠ ç›‘å¬å™¨
            addInputListener(xAxisRowInput, 'xAxisRow');
            addInputListener(startRowInput, 'startRow');
            addInputListener(endRowInput, 'endRow');
            addInputListener(startColInput, 'startCol');
            addInputListener(endColInput, 'endCol');
            addInputListener(constantRowsInput, 'constantRows');
            addInputListener(frameIntervalInput, 'frameInterval');
            addInputListener(skipFramesInput, 'skipFrames');
            addInputListener(xMinInput, 'xMin');
            addInputListener(xMaxInput, 'xMax');
            addInputListener(yMinInput, 'yMin');
            addInputListener(yMaxInput, 'yMax');
            addInputListener(showLegendSelect, 'showLegend');
            addInputListener(tooltipModeSelect, 'tooltipMode');
            addInputListener(xAxisTypeSelect, 'xAxisType');
            addInputListener(chartTitleInput, 'chartTitle');
            addInputListener(xAxisLabelInput, 'xAxisLabel');
            addInputListener(yAxisLabelInput, 'yAxisLabel');
            addInputListener(videoQualitySelect, 'videoQuality');
            addInputListener(axisZoomInput, 'axisZoomInput');

            // === å¤šæ–‡ä»¶ç®¡ç†åŠŸèƒ½ ===

            // æ·»åŠ æ–‡ä»¶æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
            addFileBtn.addEventListener('click', () => {
                fileInput.click();
            });

            // æ–‡ä»¶ç®¡ç†åŠŸèƒ½å‡½æ•°
            function addCsvFile(file, fileData, fileName) {
                const fileIndex = csvFiles.length;
                const fileInfo = {
                    file: file,
                    data: fileData,
                    fileName: fileName,
                    displayName: fileName, // åˆå§‹æ˜¾ç¤ºåç§°ä¸æ–‡ä»¶åç›¸åŒ
                    fileHandle: file,
                    constantRows: "" // æ¯ä¸ªæ–‡ä»¶ç‹¬ç«‹çš„å¸¸æ˜¾è¡Œè®¾ç½®
                };

                csvFiles.push(fileInfo);

                // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼Œè®¾ç½®ä¸ºä¸»æ–‡ä»¶å¹¶æ˜¾ç¤ºå¸¸æ˜¾è¡Œ
                if (fileIndex === 0) {
                    csvData = fileData;
                    currentFileIndex = 0;
                }

                // åˆ›å»ºæ ‡ç­¾é¡µ
                createFileTab(fileInfo, fileIndex);

                // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼Œè‡ªåŠ¨é€‰ä¸­
                if (fileIndex === 0) {
                    selectFile(0);
                }

                // æ˜¾ç¤ºæ–‡ä»¶ç®¡ç†ç•Œé¢
                fileTabsContainer.style.display = 'block';
                addFileBtn.style.display = 'inline-block';

                // å¦‚æœæœ‰æ–‡ä»¶ï¼Œæ˜¾ç¤ºæ¸…é™¤æ–‡ä»¶æŒ‰é’®
                if (csvFiles.length > 0) {
                    clearFilesBtn.style.display = 'inline-block';
                }

                // æ›´æ–°å›¾ä¾‹æ˜¾ç¤ºè®¾ç½®
                updateLegendDisplay();

                showToast(`æ–‡ä»¶ "${fileName}" å·²æ·»åŠ `, 'success', { duration: 3000 });
            }

            // åˆ›å»ºæ–‡ä»¶æ ‡ç­¾é¡µ
            function createFileTab(fileInfo, index) {
                const tab = document.createElement('div');
                tab.className = 'file-tab';
                tab.dataset.fileIndex = index;

                const displayName = fileInfo.displayName;
                const rowCount = fileInfo.data.length;
                const colCount = fileInfo.data.length > 0 ? fileInfo.data[0].length : 0;
                const fileSize = formatFileSize(fileInfo.file.size);

                tab.innerHTML = `
                    <div class="file-name" contenteditable="true" title="ç‚¹å‡»ç¼–è¾‘åç§°">${displayName}</div>
                    <div class="file-info">${fileSize} | ${rowCount}Ã—${colCount}</div>
                    <div class="file-config">
                        <input type="text" class="constant-rows-input" placeholder="å•ç‹¬è®¾ç½®å¸¸æ˜¾è¡Œ(ç•™ç©ºåˆ™ä½¿ç”¨å…¨å±€è®¾ç½®)"
                               value="${fileInfo.constantRows || ''}" title="ä¸ºæ­¤æ–‡ä»¶å•ç‹¬è®¾ç½®å¸¸æ˜¾è¡Œï¼Œç•™ç©ºåˆ™ä½¿ç”¨å…¨å±€è®¾ç½®">
                    </div>
                    <button class="close-tab" data-file-index="${index}" title="ç§»é™¤æ–‡ä»¶">Ã—</button>
                `;

                const fileNameElement = tab.querySelector('.file-name');

                // é‡å‘½ååŠŸèƒ½
                fileNameElement.addEventListener('blur', () => {
                    const newName = fileNameElement.textContent.trim();
                    if (newName && newName !== fileInfo.displayName) {
                        renameFile(index, newName);
                    } else {
                        fileNameElement.textContent = fileInfo.displayName; // æ¢å¤åŸåç§°
                    }
                });

                fileNameElement.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        fileNameElement.blur();
                    }
                });

                // é˜»æ­¢ç‚¹å‡»ç¼–è¾‘åŒºåŸŸæ—¶è§¦å‘æ–‡ä»¶é€‰æ‹©
                fileNameElement.addEventListener('click', (e) => {
                    e.stopPropagation();
                });

                // å…³é—­æŒ‰é’®äº‹ä»¶
                const closeBtn = tab.querySelector('.close-tab');
                closeBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    removeFile(index);
                });

                // å¸¸æ˜¾è¡Œè®¾ç½®äº‹ä»¶
                const constantRowsInput = tab.querySelector('.constant-rows-input');
                const handleConstantRowsChange = () => {
                    const newValue = constantRowsInput.value.trim();
                    fileInfo.constantRows = newValue;

                    // å¦‚æœè®¾ç½®äº†å¸¸æ˜¾è¡Œï¼Œè‡ªåŠ¨å¯ç”¨å›¾ä¾‹
                    if (newValue !== '' && showLegendSelect.value !== 'true') {
                        showLegendSelect.value = 'true';
                    }

                    // å¸¸æ˜¾è¡Œè®¾ç½®å·²æ›´æ–°ï¼Œéœ€è¦ç‚¹å‡»"ç”ŸæˆåŠ¨ç”»"æŒ‰é’®åº”ç”¨æ›´æ”¹
                };

                constantRowsInput.addEventListener('change', handleConstantRowsChange);
                constantRowsInput.addEventListener('input', handleConstantRowsChange);

                // é˜»æ­¢å¸¸æ˜¾è¡Œè¾“å…¥æ¡†ç‚¹å‡»æ—¶è§¦å‘æ–‡ä»¶é€‰æ‹©
                constantRowsInput.addEventListener('click', (e) => {
                    e.stopPropagation();
                });

                tab.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('close-tab') && e.target !== fileNameElement) {
                        selectFile(index);
                    }
                });

                fileTabs.appendChild(tab);
            }

            // é‡å‘½åæ–‡ä»¶
            function renameFile(index, newName) {
                if (index < 0 || index >= csvFiles.length) return;

                const fileInfo = csvFiles[index];
                const oldName = fileInfo.displayName;

                // æ›´æ–°æ˜¾ç¤ºåç§°
                fileInfo.displayName = newName;

                // å¦‚æœå›¾è¡¨å·²ç”Ÿæˆï¼Œæ›´æ–°å›¾ä¾‹
                if (chart && allFilesFrameData.length > index) {
                    chart.data.datasets[index].label = newName;
                    chart.update();
                }

                showToast(`æ–‡ä»¶ "${oldName}" å·²é‡å‘½åä¸º "${newName}"`, 'success', { duration: 3000 });
            }

            // é€‰æ‹©æ–‡ä»¶
            function selectFile(index) {
                if (index < 0 || index >= csvFiles.length) return;

                // æ›´æ–°å½“å‰æ–‡ä»¶ç´¢å¼•
                currentFileIndex = index;

                // æ›´æ–°æ ‡ç­¾é¡µçŠ¶æ€
                document.querySelectorAll('.file-tab').forEach((tab, i) => {
                    tab.classList.toggle('active', i === index);
                });

                // æ›´æ–°å½“å‰æ˜¾ç¤ºçš„æ•°æ®
                const fileInfo = csvFiles[index];
                csvData = fileInfo.data;
                csvFileName = fileInfo.fileName;

                // æ›´æ–°æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º
                const rowCount = fileInfo.data.length;
                const colCount = fileInfo.data.length > 0 ? fileInfo.data[0].length : 0;
                fileName.innerHTML = `é¢„è§ˆ: ${fileInfo.fileName} <span style="color: #666; font-size: 0.9em; font-weight: normal;">(${formatFileSize(fileInfo.file.size)} | ${rowCount}è¡Œ Ã— ${colCount}åˆ—)</span>`;

                // é¢„è§ˆæ•°æ®
                previewData();
            }

            // ç§»é™¤æ–‡ä»¶
            function removeFile(index) {
                if (csvFiles.length === 0) {
                    showToast('æ²¡æœ‰æ–‡ä»¶å¯ä»¥ç§»é™¤', 'warning', { duration: 3000 });
                    return;
                }

                const fileInfo = csvFiles[index];
                if (confirm(`ç¡®å®šè¦ç§»é™¤æ–‡ä»¶ "${fileInfo.fileName}" å—ï¼Ÿ`)) {
                    // ä»æ•°ç»„ä¸­ç§»é™¤
                    csvFiles.splice(index, 1);

                    // é‡æ–°åˆ›å»ºæ ‡ç­¾é¡µ
                    fileTabs.innerHTML = '';
                    csvFiles.forEach((file, i) => {
                        createFileTab(file, i);
                    });

                    // å¦‚æœç§»é™¤çš„æ˜¯å½“å‰æ–‡ä»¶ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªæ–‡ä»¶
                    if (currentFileIndex >= index) {
                        currentFileIndex = Math.max(0, currentFileIndex - 1);
                    }

                    // å¦‚æœè¿˜æœ‰æ–‡ä»¶ï¼Œé€‰ä¸­ä¸€ä¸ª
                    if (csvFiles.length > 0) {
                        selectFile(currentFileIndex);
                        // æ›´æ–°å›¾ä¾‹æ˜¾ç¤ºè®¾ç½®
                        updateLegendDisplay();

                        // æ¸…é™¤æ–‡ä»¶æŒ‰é’®å§‹ç»ˆæ˜¾ç¤º
                        clearFilesBtn.style.display = 'inline-block';
                    } else {
                        // æ²¡æœ‰æ–‡ä»¶äº†ï¼Œéšè—ç•Œé¢å¹¶æ¸…é™¤ç»˜å›¾åŒºåŸŸ
                        fileTabsContainer.style.display = 'none';
                        addFileBtn.style.display = 'none';
                        clearFilesBtn.style.display = 'inline-block'; // æ¸…é™¤æ–‡ä»¶æŒ‰é’®å§‹ç»ˆæ˜¾ç¤º
                        uploadPrompt.classList.remove('hidden');
                        uploadSection.classList.remove('has-file');
                        dataPreviewSection.classList.add('hidden');
                        configSection.classList.add('hidden');

                        // æ¸…é™¤ç»˜å›¾åŒºåŸŸ
                        if (chart) {
                            chart.destroy();
                            chart = null;
                        }
                        // æ¸…é™¤canvaså†…å®¹
                        const canvas = document.getElementById('chartCanvas');
                        if (canvas) {
                            const ctx = canvas.getContext('2d');
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                        }

                        // é‡ç½®æ–‡ä»¶åæ˜¾ç¤º
                        document.getElementById('fileName').textContent = 'é¢„è§ˆ: æœªé€‰æ‹©æ–‡ä»¶';
                    }

                    showToast(`æ–‡ä»¶ "${fileInfo.fileName}" å·²ç§»é™¤`, 'info', { duration: 3000 });
                }
            }

            // å¤„ç†å¤šæ–‡ä»¶é€‰æ‹©
            function handleMultipleFiles(files) {
                let filesProcessed = 0;
                let firstFileAdded = false;

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (file.name.endsWith('.csv')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const fileContent = e.target.result;
                                const fileData = parseCSV(fileContent);

                                if (fileData.length === 0) {
                                    showToast(`æ–‡ä»¶ "${file.name}" ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®`, 'warning', { duration: 4000 });
                                    return;
                                }

                                const fileName = file.name.replace(/\.[^/.]+$/, "");
                                addCsvFile(file, fileData, fileName);

                                filesProcessed++;

                                // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªæˆåŠŸæ·»åŠ çš„æ–‡ä»¶ï¼Œæ›´æ–°UIæ˜¾ç¤º
                                if (!firstFileAdded && filesProcessed === 1) {
                                    firstFileAdded = true;
                                    updateUIForFirstFile(file, fileData, fileName);
                                }

                            } catch (error) {
                                showToast(`è§£ææ–‡ä»¶ "${file.name}" æ—¶å‡ºé”™: ${error.message}`, 'error', { duration: 6000 });
                            }
                        };
                        reader.readAsText(file);
                    }
                }
            }

            // è·å–åŠ¨æ€æ•°æ®é¢œè‰²
            function getDynamicDataColor(fileIndex) {
                const dynamicDataColors = ['#E74C3C', '#F39C12', '#27AE60', '#8E44AD', '#E67E22', '#16A085', '#D35400', '#C0392B'];
                return dynamicDataColors[fileIndex % dynamicDataColors.length];
            }

            // è·å–å¸¸æ˜¾è¡Œé¢œè‰²
            function getConstantRowColor(fileIndex, rowIndex, totalRows) {
                const constantRowColors = ['#5DADE2', '#48C9B0', '#45B7D1', '#7FB3D5', '#85C1E9', '#76D7C4', '#5499C7', '#2E86AB'];
                const globalIndex = fileIndex * totalRows + rowIndex;
                return constantRowColors[globalIndex % constantRowColors.length];
            }

            // æ¸…é™¤æ‰€æœ‰æ–‡ä»¶
            function clearAllFiles() {
                if (csvFiles.length === 0) {
                    showToast('æ²¡æœ‰æ–‡ä»¶éœ€è¦æ¸…é™¤', 'info', { duration: 3000 });
                    return;
                }

                if (confirm(`ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ ${csvFiles.length} ä¸ªæ–‡ä»¶å—ï¼Ÿ`)) {
                    // æ¸…é™¤æ‰€æœ‰æ–‡ä»¶
                    csvFiles = [];
                    currentFileIndex = -1;

                    // æ¸…ç©ºæ ‡ç­¾é¡µ
                    fileTabs.innerHTML = '';

                    // æ¸…é™¤æ–‡ä»¶æŒ‰é’®å§‹ç»ˆæ˜¾ç¤º
                    clearFilesBtn.style.display = 'inline-block';

                    // æ›´æ–°å›¾ä¾‹æ˜¾ç¤ºè®¾ç½®
                    updateLegendDisplay();

                    // é‡ç½®ä¸ºåˆå§‹çŠ¶æ€
                    uploadPrompt.classList.remove('hidden');
                    uploadSection.classList.remove('has-file');
                    dataPreviewSection.classList.add('hidden');
                    configSection.classList.add('hidden');
                    document.getElementById('fileTabsContainer').style.display = 'none';

                    // é‡ç½®æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€
                    document.getElementById('initialUploadBtn').style.display = 'inline-block';
                    document.getElementById('addFileBtn').style.display = 'none';

                    // é‡ç½®æ–‡ä»¶åæ˜¾ç¤º
                    document.getElementById('fileName').textContent = 'é¢„è§ˆ: æœªé€‰æ‹©æ–‡ä»¶';

                    // æ¸…é™¤ç»˜å›¾åŒºåŸŸ
                    if (chart) {
                        chart.destroy();
                        chart = null;
                    }
                    // æ¸…é™¤canvaså†…å®¹
                    const canvas = document.getElementById('chartCanvas');
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                    }

                    showToast('å·²æ¸…é™¤æ‰€æœ‰æ–‡ä»¶å’Œç»˜å›¾åŒºåŸŸ', 'info', { duration: 3000 });
                }
            }

            // ä¸ºæ–‡ä»¶æ›´æ–°UIæ˜¾ç¤º
            function updateUIForFirstFile(file, fileData, fileName) {
                // æ›´æ–°UI
                uploadPrompt.classList.add('hidden');
                uploadSection.classList.add('has-file');
                fileName.textContent = `é¢„è§ˆ: ${file.name}`;
                dataPreviewSection.classList.remove('hidden');

                // æ¸…é™¤æ–‡ä»¶æŒ‰é’®å§‹ç»ˆæ˜¾ç¤º
                clearFilesBtn.style.display = 'inline-block';

                // é¢„è§ˆæ•°æ®
                previewData();

                // æ›´æ–°æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º
                updateFileInfo(file, fileData);

                // æ˜¾ç¤ºè®¾ç½®åŒºåŸŸ
                configSection.classList.remove('hidden');

                // åªé‡ç½®é»˜è®¤è®¾ç½®ï¼Œä¿ç•™æ‰‹åŠ¨è®¾ç½®
                setDefaultConfigOnly();
            }

            // Xè½´æ•°æ®è¡Œå·æ”¹å˜æ—¶çš„ç‰¹æ®Šå¤„ç†
            xAxisRowInput.addEventListener('input', function() {
                updateRelatedDefaults();
            });

            // æ›´æ–°å›¾ä¾‹æ˜¾ç¤ºè®¾ç½®
            function updateLegendDisplay() {
                // åªåœ¨æœªæ‰‹åŠ¨è®¾ç½®æ˜¾ç¤ºå›¾ä¾‹æ—¶è‡ªåŠ¨è°ƒæ•´
                if (!manuallyModified.has('showLegend')) {
                    const hasConstantRows = constantRowsInput.value.trim() !== '';
                    const hasMultipleFiles = csvFiles.length > 1;
                    // å¦‚æœæœ‰å¸¸æ˜¾è¡Œæˆ–å¤šä¸ªæ–‡ä»¶ï¼Œè‡ªåŠ¨æ˜¾ç¤ºå›¾ä¾‹
                    showLegendSelect.value = (hasConstantRows || hasMultipleFiles) ? 'true' : 'false';
                }
            }

            // å…¨å±€æ‹–æ”¾æ£€æµ‹å’Œå¤„ç†
            let isDraggingFile = false;

            document.addEventListener('dragover', (e) => {
                // æ£€æŸ¥æ˜¯å¦æ‹–æ‹½çš„æ˜¯æ–‡ä»¶
                if (e.dataTransfer.types.includes('Files')) {
                    e.preventDefault();
                    e.stopPropagation();

                    if (!isDraggingFile) {
                        isDraggingFile = true;
                        globalDropOverlay.classList.add('active');
                        uploadSection.classList.add('global-drop-highlight');
                    }
                }
            });

            document.addEventListener('dragleave', (e) => {
                // å½“é¼ æ ‡ç¦»å¼€é¡µé¢æ—¶éšè—è¦†ç›–å±‚
                if (e.clientX === 0 && e.clientY === 0) {
                    hideGlobalDropOverlay();
                }
            });

            document.addEventListener('drop', (e) => {
                // å¤„ç†å…¨å±€æ–‡ä»¶æ‹–æ”¾
                if (e.dataTransfer.types.includes('Files')) {
                    e.preventDefault();
                    e.stopPropagation();

                    hideGlobalDropOverlay();

                    if (e.dataTransfer.files.length > 0) {
                        // ç»Ÿä¸€ä½¿ç”¨å¤šæ–‡ä»¶å¤„ç†é€»è¾‘
                        const csvFiles = Array.from(e.dataTransfer.files).filter(file => file.name.endsWith('.csv'));
                        if (csvFiles.length > 0) {
                            handleMultipleFiles(csvFiles);
                        } else {
                            showToast('è¯·ä¸Šä¼  CSV æ ¼å¼çš„æ–‡ä»¶', 'error', { duration: 4000 });
                        }
                    }
                }
            });

            // è¦†ç›–å±‚çš„æ‹–æ”¾äº‹ä»¶å¤„ç†
            globalDropOverlay.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });

            globalDropOverlay.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                hideGlobalDropOverlay();

                if (e.dataTransfer.files.length > 0) {
                    // ç»Ÿä¸€ä½¿ç”¨å¤šæ–‡ä»¶å¤„ç†é€»è¾‘
                    const csvFiles = Array.from(e.dataTransfer.files).filter(file => file.name.endsWith('.csv'));
                    if (csvFiles.length > 0) {
                        handleMultipleFiles(csvFiles);
                    } else {
                        showToast('è¯·ä¸Šä¼  CSV æ ¼å¼çš„æ–‡ä»¶', 'error', { duration: 4000 });
                    }
                }
            });

            // éšè—å…¨å±€æ‹–æ”¾è¦†ç›–å±‚çš„å‡½æ•°
            function hideGlobalDropOverlay() {
                isDraggingFile = false;
                globalDropOverlay.classList.remove('active');
                uploadSection.classList.remove('global-drop-highlight');
            }

            // æ–‡ä»¶ä¸Šä¼ å¤„ç†
            initialUploadBtn.addEventListener('click', selectMultipleFilesWithPermission);
            uploadBtn.addEventListener('click', selectMultipleFilesWithPermission);
            refreshFileBtn.addEventListener('click', refreshAllFiles);
            clearFilesBtn.addEventListener('click', clearAllFiles);

            fileInput.addEventListener('change', handleFileSelect);

            // æ‹–æ‹½ä¸Šä¼ 
            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                uploadSection.classList.add('dragover');
            });

            uploadSection.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                uploadSection.classList.remove('dragover');
            });

            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                uploadSection.classList.remove('dragover');

                if (e.dataTransfer.files.length) {
                    // ç»Ÿä¸€ä½¿ç”¨å¤šæ–‡ä»¶å¤„ç†é€»è¾‘
                    const files = Array.from(e.dataTransfer.files).filter(file => file.name.endsWith('.csv'));
                    if (files.length > 0) {
                        handleMultipleFiles(files);
                    }
                }
            });

            // ç”ŸæˆåŠ¨ç”»æŒ‰é’®
            generateChartBtn.addEventListener('click', generateChart);

            // ä¿å­˜è§†é¢‘æŒ‰é’®
            saveVideoBtn.addEventListener('click', saveVideo);

            // é‡ç½®æŒ‰é’®
            resetBtn.addEventListener('click', resetConfig);

            // åæ ‡è½´ç¼©æ”¾æ§åˆ¶äº‹ä»¶ç›‘å¬å™¨
            axisZoomInBtn.addEventListener('click', (e) => {
                if (chart) {
                    axisZoomIn();
                }
                e.target.blur(); // é˜²æ­¢æŒ‰é’®è·å¾—ç„¦ç‚¹
            });

            axisZoomOutBtn.addEventListener('click', (e) => {
                if (chart) {
                    axisZoomOut();
                }
                e.target.blur(); // é˜²æ­¢æŒ‰é’®è·å¾—ç„¦ç‚¹
            });

            axisResetBtn.addEventListener('click', (e) => {
                if (chart) {
                    resetAxisZoom();
                }
                e.target.blur(); // é˜²æ­¢æŒ‰é’®è·å¾—ç„¦ç‚¹
            });

            // ç¼©æ”¾ç›®æ ‡é€‰æ‹©äº‹ä»¶ç›‘å¬å™¨
            axisZoomTarget.addEventListener('change', (e) => {
                updateZoomDisplay(); // åˆ‡æ¢ç›®æ ‡æ—¶æ›´æ–°æ˜¾ç¤º
                e.target.blur(); // é˜²æ­¢è·å¾—ç„¦ç‚¹
            });

            // ç¼©æ”¾è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬å™¨
            axisZoomInput.addEventListener('input', (e) => {
                if (chart) {
                    const target = axisZoomTarget.value;
                    let inputValue = parseInt(e.target.value);

                    // éªŒè¯è¾“å…¥å€¼
                    if (isNaN(inputValue) || inputValue < 1) {
                        inputValue = 1;
                    } else if (inputValue > 999999) {
                        inputValue = 999999;
                    }

                    const newZoomLevel = inputValue / 100;

                    if (target === 'xy') {
                        axisZoomLevel = newZoomLevel;
                        xAxisZoomLevel = newZoomLevel;
                        yAxisZoomLevel = newZoomLevel;
                    } else if (target === 'x') {
                        xAxisZoomLevel = newZoomLevel;
                    } else if (target === 'y') {
                        yAxisZoomLevel = newZoomLevel;
                    }

                    updateAxisZoom();
                    updateZoomDisplay();
                }
            });

            // ç¼©æ”¾æ»‘å—äº‹ä»¶ç›‘å¬å™¨
            axisZoomSlider.addEventListener('input', (e) => {
                if (chart) {
                    const target = axisZoomTarget.value;
                    const newZoomLevel = parseInt(e.target.value) / 100;

                    if (target === 'xy') {
                        axisZoomLevel = newZoomLevel;
                        xAxisZoomLevel = newZoomLevel;
                        yAxisZoomLevel = newZoomLevel;
                    } else if (target === 'x') {
                        xAxisZoomLevel = newZoomLevel;
                    } else if (target === 'y') {
                        yAxisZoomLevel = newZoomLevel;
                    }

                    updateAxisZoom();
                    updateZoomDisplay();
                    e.target.blur(); // é˜²æ­¢æ»‘å—è·å¾—ç„¦ç‚¹
                }
            });

            // æ›´æ–°ç¼©æ”¾æ˜¾ç¤º
            function updateZoomDisplay() {
                const target = axisZoomTarget.value;
                let zoomPercent;

                if (target === 'xy') {
                    zoomPercent = Math.round(axisZoomLevel * 100);
                } else if (target === 'x') {
                    zoomPercent = Math.round(xAxisZoomLevel * 100);
                } else if (target === 'y') {
                    zoomPercent = Math.round(yAxisZoomLevel * 100);
                }

                // æ›´æ–°è¾“å…¥æ¡†å’Œæ»‘å—
                axisZoomInput.value = zoomPercent;

                // å¦‚æœç¼©æ”¾å€¼è¶…è¿‡æ»‘å—èŒƒå›´ï¼Œä¸æ›´æ–°æ»‘å—ï¼Œå¦åˆ™åŒæ­¥
                if (zoomPercent <= 1000) {
                    axisZoomSlider.value = zoomPercent;
                }
            }

            // é˜²æ­¢å›¾è¡¨å®¹å™¨è·å¾—ç„¦ç‚¹
            chartContainer.setAttribute('tabindex', '-1'); // é˜²æ­¢é€šè¿‡tabé”®è·å¾—ç„¦ç‚¹
            chartContainer.style.outline = 'none'; // ç§»é™¤ç„¦ç‚¹è½®å»“

            // å›¾è¡¨æ‹–æ‹½å¹³ç§»äº‹ä»¶ç›‘å¬å™¨
            chartContainer.addEventListener('mousedown', (e) => {
                // é˜²æ­¢å›¾è¡¨å®¹å™¨è·å¾—ç„¦ç‚¹
                e.preventDefault();
                handleAxisPanStart(e);
            });
            chartContainer.addEventListener('mousemove', handleAxisPanMove);
            chartContainer.addEventListener('mouseup', (e) => {
                handleAxisPanEnd(e);
                // ç¡®ä¿å›¾è¡¨å®¹å™¨ä¸ä¼šä¿æŒç„¦ç‚¹
                e.target.blur();
                if (document.activeElement === chartContainer) {
                    document.body.focus(); // å°†ç„¦ç‚¹è½¬ç§»åˆ°body
                }
            });
            chartContainer.addEventListener('mouseleave', handleAxisPanEnd);

            // æ·»åŠ åŒå‡»äº‹ä»¶ç”¨äºæ—¶é—´åºåˆ—åˆ†æï¼ˆé¿å…ä¸æ‹–æ‹½å†²çªï¼‰
            chartContainer.addEventListener('dblclick', handleChartDoubleClick);

            // å›¾è¡¨åŒºé¼ æ ‡æ»šè½®å¤„ç†ï¼šå…è®¸é¡µé¢æ»šåŠ¨ï¼ŒCtrl+æ»šè½®è¿›è¡Œç¼©æ”¾
            chartContainer.addEventListener('wheel', (e) => {
                // åªæœ‰æŒ‰ä½Ctrlé”®æ—¶æ‰è¿›è¡Œç¼©æ”¾
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();

                    // æ ¹æ®æ»šè½®æ–¹å‘è¿›è¡Œç¼©æ”¾
                    if (e.deltaY < 0) {
                        // å‘ä¸Šæ»šåŠ¨ï¼Œæ”¾å¤§
                        axisZoomIn();
                    } else {
                        // å‘ä¸‹æ»šåŠ¨ï¼Œç¼©å°
                        axisZoomOut();
                    }
                }
                // ä¸æŒ‰Ctrlé”®æ—¶ï¼Œå…è®¸æ­£å¸¸çš„é¡µé¢æ»šåŠ¨è¡Œä¸ºï¼ˆä¸é˜»æ­¢é»˜è®¤äº‹ä»¶ï¼‰
            });


            // æ’­æ”¾/æš‚åœæŒ‰é’®
            playPauseBtn.addEventListener('click', (e) => {
                togglePlayPause();
                e.target.blur(); // é˜²æ­¢æŒ‰é’®è·å¾—ç„¦ç‚¹
            });

            // ä¸Šä¸€å¸§/ä¸‹ä¸€å¸§æŒ‰é’®é•¿æŒ‰äº‹ä»¶
            prevFrameBtn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                // é˜²æ­¢æŒ‰é’®è·å¾—ç„¦ç‚¹
                e.target.blur();
                if (isPlaying) togglePlayPause();
                startFrameNavigation(-1);
            });

            prevFrameBtn.addEventListener('mouseup', () => {
                stopFrameNavigation();
            });

            prevFrameBtn.addEventListener('mouseleave', () => {
                stopFrameNavigation();
            });

            prevFrameBtn.addEventListener('click', () => {
                // å•å‡»æ—¶å·²ç»åœ¨mousedownä¸­å¤„ç†äº†ï¼Œè¿™é‡Œä¸éœ€è¦é¢å¤–å¤„ç†
            });

            nextFrameBtn.addEventListener('mousedown', (e) => {
                e.preventDefault();
                // é˜²æ­¢æŒ‰é’®è·å¾—ç„¦ç‚¹
                e.target.blur();
                if (isPlaying) togglePlayPause();
                startFrameNavigation(1);
            });

            nextFrameBtn.addEventListener('mouseup', () => {
                stopFrameNavigation();
            });

            nextFrameBtn.addEventListener('mouseleave', () => {
                stopFrameNavigation();
            });

            nextFrameBtn.addEventListener('click', () => {
                // å•å‡»æ—¶å·²ç»åœ¨mousedownä¸­å¤„ç†äº†ï¼Œè¿™é‡Œä¸éœ€è¦é¢å¤–å¤„ç†
            });

            // è¿›åº¦æ¡
            progressBar.addEventListener('input', (e) => {
                currentFrameIndex = parseInt(progressBar.value);
                updateChart();
                updateFrameInfo();
                // é˜²æ­¢è¿›åº¦æ¡è·å¾—ç„¦ç‚¹
                e.target.blur();
            });

            // é˜²æ­¢è¿›åº¦æ¡åœ¨ç‚¹å‡»æ—¶è·å¾—ç„¦ç‚¹
            progressBar.addEventListener('mousedown', (e) => {
                // ä¸é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œå…è®¸æ­£å¸¸æ‹–æ‹½
                // ç„¦ç‚¹æ§åˆ¶å°†åœ¨inputäº‹ä»¶ä¸­å¤„ç†
            });

            progressBar.addEventListener('change', (e) => {
                e.target.blur(); // ç¡®ä¿åœ¨å€¼æ”¹å˜åå¤±å»ç„¦ç‚¹
            });

            // æ›´æ–°ç›¸å…³é»˜è®¤å€¼
            function updateRelatedDefaults() {
                const xAxisRow = parseInt(xAxisRowInput.value);

                // æ›´æ–°Yè½´èµ·å§‹è¡Œï¼ˆå¦‚æœæœªæ‰‹åŠ¨ä¿®æ”¹ï¼‰
                if (!manuallyModified.has('startRow')) {
                    startRowInput.value = xAxisRow + 1;
                }

                // æ›´æ–°Xè½´èŒƒå›´ï¼ˆå¦‚æœæœªæ‰‹åŠ¨ä¿®æ”¹ï¼‰
                if (!manuallyModified.has('xMin') || !manuallyModified.has('xMax')) {
                    updateXAxisRange();
                }

                // æ€»æ˜¯æ›´æ–°Xè½´æ ‡ç­¾çš„å€¼ï¼ˆå½“Xè½´è¡Œå·æ”¹å˜æ—¶ï¼‰
                updateXAxisLabelValue();
            }

            // æ›´æ–°Xè½´èŒƒå›´ - ä¿®æ”¹ä¸ºä½¿ç”¨æ‰€æœ‰æ–‡ä»¶çš„æ•°æ®
            function updateXAxisRange() {
                const xAxisRow = parseInt(xAxisRowInput.value) - 1;
                if (csvFiles.length > 0) {
                    let allMinValues = [];
                    let allMaxValues = [];

                    // æ”¶é›†æ‰€æœ‰æ–‡ä»¶çš„æœ‰æ•ˆXè½´æ•°æ®
                    for (const file of csvFiles) {
                        if (xAxisRow >= 0 && xAxisRow < file.data.length) {
                            const xData = file.data[xAxisRow].filter(val => val !== '' && !isNaN(parseFloat(val)));
                            if (xData.length > 0) {
                                const numericData = xData.map(val => parseFloat(val));
                                // ä½¿ç”¨å¾ªç¯ä»£æ›¿æ‰©å±•è¿ç®—ç¬¦,é¿å…Windowsä¸‹å‚æ•°æ•°é‡é™åˆ¶å¼‚å¸¸
                                let minVal = numericData[0];
                                let maxVal = numericData[0];
                                for (let i = 1; i < numericData.length; i++) {
                                    if (numericData[i] < minVal) minVal = numericData[i];
                                    if (numericData[i] > maxVal) maxVal = numericData[i];
                                }
                                allMinValues.push(minVal);
                                allMaxValues.push(maxVal);
                            }
                        }
                    }

                    // ä½¿ç”¨æ‰€æœ‰æ–‡ä»¶ä¸­çš„æœ€å°/æœ€å¤§å€¼
                    if (allMinValues.length > 0) {
                        // ä½¿ç”¨å¾ªç¯ä»£æ›¿æ‰©å±•è¿ç®—ç¬¦,é¿å…Windowsä¸‹å‚æ•°æ•°é‡é™åˆ¶å¼‚å¸¸
                        let min = allMinValues[0];
                        let max = allMaxValues[0];
                        for (let i = 1; i < allMinValues.length; i++) {
                            if (allMinValues[i] < min) min = allMinValues[i];
                            if (allMaxValues[i] > max) max = allMaxValues[i];
                        }

                        if (!manuallyModified.has('xMin')) {
                            xMinInput.value = min;
                            xMinInput.classList.remove('manual-value');
                            xMinInput.classList.add('default-value');
                        }
                        if (!manuallyModified.has('xMax')) {
                            xMaxInput.value = max;
                            xMaxInput.classList.remove('manual-value');
                            xMaxInput.classList.add('default-value');
                        }
                    }
                }
            }

            // æ›´æ–°Xè½´æ ‡ç­¾ï¼ˆåŒ…å«æ ·å¼è®¾ç½®ï¼‰
            function updateXAxisLabel() {
                const xAxisRow = parseInt(xAxisRowInput.value) - 1;
                if (csvFiles.length > 0 && xAxisRow >= 0 && xAxisRow < csvFiles[0].data.length && csvFiles[0].data[xAxisRow].length > 0) {
                    xAxisLabelInput.value = csvFiles[0].data[xAxisRow][0];
                    // åªæœ‰åœ¨éæ‰‹åŠ¨ä¿®æ”¹æ—¶æ‰è®¾ç½®é»˜è®¤æ ·å¼
                    if (!manuallyModified.has('xAxisLabel')) {
                        xAxisLabelInput.classList.remove('manual-value');
                        xAxisLabelInput.classList.add('default-value');
                    }
                }
            }

            // åªæ›´æ–°Xè½´æ ‡ç­¾çš„å€¼ï¼Œä¸æ”¹å˜æ‰‹åŠ¨ä¿®æ”¹çŠ¶æ€
            function updateXAxisLabelValue() {
                const xAxisRow = parseInt(xAxisRowInput.value) - 1;
                if (csvFiles.length > 0 && xAxisRow >= 0 && xAxisRow < csvFiles[0].data.length && csvFiles[0].data[xAxisRow].length > 0) {
                    const newLabel = csvFiles[0].data[xAxisRow][0];
                    // åªæœ‰åœ¨å€¼ç¡®å®æ”¹å˜æ—¶æ‰æ›´æ–°
                    if (xAxisLabelInput.value !== newLabel) {
                        xAxisLabelInput.value = newLabel;
                        // å¦‚æœä¹‹å‰æ˜¯é»˜è®¤çŠ¶æ€ï¼Œä¿æŒé»˜è®¤çŠ¶æ€ï¼›å¦‚æœæ˜¯æ‰‹åŠ¨ä¿®æ”¹çŠ¶æ€ï¼Œä¿æŒæ‰‹åŠ¨ä¿®æ”¹çŠ¶æ€
                        if (!manuallyModified.has('xAxisLabel')) {
                            xAxisLabelInput.classList.remove('manual-value');
                            xAxisLabelInput.classList.add('default-value');
                        }
                    }
                }
            }

            // å¤„ç†æ–‡ä»¶é€‰æ‹©
            function handleFileSelect(e) {
                if (e.target.files.length) {
                    // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰æ–‡ä»¶
                    if (csvFiles.length === 0) {
                        // ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼Œä½¿ç”¨åŸæœ‰é€»è¾‘
                        handleFile(e.target.files[0], false); // é€šè¿‡é€‰æ‹©å™¨å¯¼å…¥ï¼Œä¸æ˜¯æ‹–æ‹½
                    } else {
                        // å·²æœ‰æ–‡ä»¶ï¼Œä½¿ç”¨å¤šæ–‡ä»¶å¤„ç†é€»è¾‘
                        const files = Array.from(e.target.files).filter(file => file.name.endsWith('.csv'));
                        if (files.length > 0) {
                            handleMultipleFiles(files);
                        }
                    }
                }
            }

            // ä½¿ç”¨ File System Access API é€‰æ‹©æ–‡ä»¶ï¼ˆå¸¦æŒä¹…æƒé™ï¼‰
            // é€‰æ‹©å¤šä¸ªæ–‡ä»¶ï¼ˆå¸¦æƒé™ï¼‰
            async function selectMultipleFilesWithPermission() {
                try {
                    if ('showOpenFilePicker' in window) {
                        // ä½¿ç”¨ç°ä»£ File System Access API æ”¯æŒå¤šæ–‡ä»¶é€‰æ‹©
                        const pickerOptions = {
                            types: [
                                {
                                    description: 'CSV files',
                                    accept: {
                                        'text/csv': ['.csv'],
                                        'application/vnd.ms-excel': ['.csv'],
                                        'text/plain': ['.csv']
                                    },
                                },
                            ],
                            multiple: true, // å…è®¸å¤šé€‰
                        };

                        // è®¾ç½®é»˜è®¤æ‰“å¼€ç›®å½•
                        if (lastOpenedFileHandle) {
                            // å¦‚æœæœ‰ä¸Šæ¬¡æ‰“å¼€çš„æ–‡ä»¶ï¼Œä»è¯¥æ–‡ä»¶æ‰€åœ¨ç›®å½•å¼€å§‹
                            pickerOptions.startIn = lastOpenedFileHandle;
                        } else {
                            // å¦åˆ™é»˜è®¤æ‰“å¼€Downloadsç›®å½•
                            pickerOptions.startIn = 'downloads';
                        }

                        const fileHandles = await window.showOpenFilePicker(pickerOptions);

                        if (fileHandles.length === 0) {
                            return; // ç”¨æˆ·æ²¡æœ‰é€‰æ‹©æ–‡ä»¶
                        }

                        showToast(`æ­£åœ¨å¯¼å…¥ ${fileHandles.length} ä¸ªæ–‡ä»¶...`, 'info', { duration: 3000 });

                        // å¤„ç†å¤šä¸ªæ–‡ä»¶
                        let successCount = 0;
                        let skipCount = 0;

                        for (let i = 0; i < fileHandles.length; i++) {
                            const fileHandle = fileHandles[i];
                            try {
                                const file = await fileHandle.getFile();

                                // æ£€æŸ¥æ–‡ä»¶ç±»å‹
                                if (!file.name.toLowerCase().endsWith('.csv')) {
                                    showToast(`è·³è¿‡éCSVæ–‡ä»¶: ${file.name}`, 'warning', { duration: 2000 });
                                    skipCount++;
                                    continue;
                                }

                                // æ£€æŸ¥æ–‡ä»¶å¤§å°
                                if (file.size > 100 * 1024 * 1024) { // 100MB limit
                                    showToast(`æ–‡ä»¶è¿‡å¤§ï¼Œè·³è¿‡: ${file.name}`, 'warning', { duration: 2000 });
                                    skipCount++;
                                    continue;
                                }

                                // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼Œä¿å­˜å¥æŸ„ç”¨äºåç»­åˆ·æ–°
                                if (i === 0) {
                                    rememberedFileHandle = fileHandle;
                                }

                                // å¤„ç†æ–‡ä»¶
                                await handleFileAsync(file, fileHandle);
                                successCount++;

                            } catch (fileError) {
                                console.error(`å¤„ç†æ–‡ä»¶ ${fileHandle.name} æ—¶å‡ºé”™:`, fileError);
                                showToast(`æ–‡ä»¶ ${fileHandle.name} å¤„ç†å¤±è´¥`, 'error', { duration: 3000 });
                                skipCount++;
                            }
                        }

                        // æ˜¾ç¤ºå¯¼å…¥ç»“æœ
                        if (successCount > 0) {
                            showToast(`âœ… æˆåŠŸå¯¼å…¥ ${successCount} ä¸ªæ–‡ä»¶${skipCount > 0 ? `ï¼Œè·³è¿‡ ${skipCount} ä¸ª` : ''}`, 'success', { duration: 4000 });

                            // è®°å½•æœ€åæ‰“å¼€çš„æ–‡ä»¶è·¯å¾„ï¼ˆä½¿ç”¨ç¬¬ä¸€ä¸ªæˆåŠŸå¯¼å…¥çš„æ–‡ä»¶ï¼‰
                            if (fileHandles.length > 0) {
                                lastOpenedFileHandle = fileHandles[0];
                                console.log('å·²è®°å½•æœ€åæ‰“å¼€æ–‡ä»¶è·¯å¾„:', lastOpenedFileHandle.name);
                            }
                        } else {
                            showToast('âŒ æ²¡æœ‰æˆåŠŸå¯¼å…¥ä»»ä½•æ–‡ä»¶', 'error', { duration: 4000 });
                        }

                    } else {
                        // å›é€€åˆ°ä¼ ç»Ÿæ–¹å¼ï¼ˆå•æ–‡ä»¶ï¼‰
                        fileInput.click();
                    }
                } catch (error) {
                    if (error.name === 'AbortError') {
                        // ç”¨æˆ·å–æ¶ˆäº†é€‰æ‹©
                        return;
                    }
                    console.error('æ–‡ä»¶é€‰æ‹©é”™è¯¯:', error);
                    showToast('âŒ æ–‡ä»¶é€‰æ‹©å¤±è´¥ï¼Œè¯·é‡è¯•', 'error', { duration: 6000 });
                }
            }

            // å¼‚æ­¥å¤„ç†å•ä¸ªæ–‡ä»¶ï¼ˆç”¨äºå¤šæ–‡ä»¶å¯¼å…¥ï¼‰
            async function handleFileAsync(file, fileHandle = null) {
                try {
                    const fileContent = await file.text();
                    const fileData = parseCSV(fileContent);

                    if (!fileData || fileData.length === 0) {
                        throw new Error('CSVæ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');
                    }

                    const fileName = file.name.replace(/\.[^/.]+$/, "");

                    // ä½¿ç”¨ addCsvFile å‡½æ•°æ·»åŠ æ–‡ä»¶
                    addCsvFile(file, fileData, fileName);

                    // å¦‚æœæä¾›äº†æ–‡ä»¶å¥æŸ„ï¼Œæ›´æ–°æ–‡ä»¶ä¿¡æ¯
                    if (fileHandle && csvFiles.length > 0) {
                        const lastIndex = csvFiles.length - 1;
                        csvFiles[lastIndex].fileHandle = fileHandle;
                    }

                    // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼Œæ›´æ–°UIæ˜¾ç¤º
                    if (csvFiles.length === 1) {
                        updateUIForFirstFile(file, fileData, fileName);
                    }

                } catch (error) {
                    console.error('å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™:', error);
                    throw error;
                }
            }

            // é€‰æ‹©æ–‡ä»¶ï¼ˆå¸¦æƒé™ï¼‰- ä¿æŒå‘åå…¼å®¹
            async function selectFileWithPermission() {
                try {
                    if ('showOpenFilePicker' in window) {
                        // ä½¿ç”¨ç°ä»£ File System Access API
                        const pickerOptions = {
                            types: [
                                {
                                    description: 'CSV files',
                                    accept: {
                                        'text/csv': ['.csv'],
                                    },
                                },
                            ],
                            multiple: false,
                        };

                        // è®¾ç½®é»˜è®¤æ‰“å¼€ç›®å½•
                        if (lastOpenedFileHandle) {
                            // å¦‚æœæœ‰ä¸Šæ¬¡æ‰“å¼€çš„æ–‡ä»¶ï¼Œä»è¯¥æ–‡ä»¶æ‰€åœ¨ç›®å½•å¼€å§‹
                            pickerOptions.startIn = lastOpenedFileHandle;
                        } else {
                            // å¦åˆ™é»˜è®¤æ‰“å¼€Downloadsç›®å½•
                            pickerOptions.startIn = 'downloads';
                        }

                        const [fileHandle] = await window.showOpenFilePicker(pickerOptions);

                        // è·å–æ–‡ä»¶å¹¶å¤„ç†
                        const file = await fileHandle.getFile();

                        // ä¿å­˜æ–‡ä»¶å¥æŸ„
                        rememberedFileHandle = fileHandle;

                        // å¤„ç†æ–‡ä»¶
                        handleFile(file, false);

                        // è®°å½•æœ€åæ‰“å¼€çš„æ–‡ä»¶è·¯å¾„
                        lastOpenedFileHandle = fileHandle;
                        console.log('å·²è®°å½•æœ€åæ‰“å¼€æ–‡ä»¶è·¯å¾„:', lastOpenedFileHandle.name);

                        showToast('âœ… æ–‡ä»¶å¯¼å…¥æˆåŠŸ', 'success', { duration: 4000 });
                    } else {
                        // å›é€€åˆ°ä¼ ç»Ÿæ–¹å¼
                        fileInput.click();
                    }
                } catch (error) {
                    if (error.name === 'AbortError') {
                        // ç”¨æˆ·å–æ¶ˆäº†é€‰æ‹©
                        return;
                    }
                    console.error('æ–‡ä»¶é€‰æ‹©é”™è¯¯:', error);
                    showToast('âŒ æ–‡ä»¶é€‰æ‹©å¤±è´¥ï¼Œè¯·é‡è¯•', 'error', { duration: 6000 });
                }
            }

            // åˆ·æ–°æ‰€æœ‰æ–‡ä»¶
            async function refreshAllFiles() {
                if (csvFiles.length === 0) {
                    showToast('æ²¡æœ‰å¯åˆ·æ–°çš„æ–‡ä»¶', 'warning', { duration: 3000 });
                    return;
                }

                showToast(`æ­£åœ¨åˆ·æ–° ${csvFiles.length} ä¸ªæ–‡ä»¶...`, 'info', { duration: 3000 });

                // æ”¶é›†éœ€è¦é‡æ–°æˆæƒçš„æ–‡ä»¶
                const filesNeedingPermission = [];
                const refreshedFiles = [];
                const failedFiles = [];

                // é€ä¸ªæ£€æŸ¥æ–‡ä»¶æƒé™
                for (let i = 0; i < csvFiles.length; i++) {
                    const fileInfo = csvFiles[i];

                    try {
                        if (typeof fileInfo.fileHandle.getFile === 'function') {
                            // è¿™æ˜¯ FileSystemFileHandleï¼Œæœ‰æŒä¹…æƒé™
                            const file = await fileInfo.fileHandle.getFile();
                            const fileContent = await file.text();

                            // é‡æ–°è§£æCSVæ•°æ®
                            const parsedData = parseCSV(fileContent);

                            // éªŒè¯æ–°æ•°æ®ç»“æ„æ˜¯å¦ä¸åŸæ•°æ®ä¸€è‡´
                            if (validateDataStructure(parsedData, fileInfo.data)) {
                                fileInfo.data = parsedData;
                                refreshedFiles.push({
                                    index: i,
                                    name: fileInfo.displayName,
                                    success: true
                                });

                                // å¦‚æœæ˜¯å½“å‰é€‰ä¸­çš„æ–‡ä»¶ï¼Œæ›´æ–°é¢„è§ˆ
                                if (i === currentFileIndex) {
                                    csvData = parsedData;
                                    previewData();
                                }
                            } else {
                                failedFiles.push({
                                    index: i,
                                    name: fileInfo.displayName,
                                    reason: 'æ•°æ®ç»“æ„å‘ç”Ÿå˜åŒ–'
                                });
                            }
                        } else {
                            // è¿™æ˜¯æ™®é€š File å¯¹è±¡ï¼ˆæ‹–æ‹½å¯¼å…¥çš„ï¼‰ï¼Œéœ€è¦é‡æ–°æˆæƒ
                            filesNeedingPermission.push({
                                index: i,
                                name: fileInfo.displayName,
                                fileInfo: fileInfo
                            });
                        }
                    } catch (error) {
                        console.error(`åˆ·æ–°æ–‡ä»¶ ${fileInfo.displayName} æ—¶å‡ºé”™:`, error);

                        let reason = 'åˆ·æ–°å¤±è´¥';
                        if (error.name === 'NotAllowedError' || error.message.includes('permission')) {
                            reason = 'æƒé™ä¸è¶³';
                        } else if (error.name === 'NotFoundError') {
                            reason = 'æ–‡ä»¶ä¸å­˜åœ¨';
                        } else if (error.message.includes('read')) {
                            reason = 'æ— æ³•è¯»å–æ–‡ä»¶';
                        }

                        failedFiles.push({
                            index: i,
                            name: fileInfo.displayName,
                            reason: reason
                        });
                    }
                }

                // æ˜¾ç¤ºåˆ·æ–°ç»“æœ
                let resultMessage = '';

                if (refreshedFiles.length > 0) {
                    resultMessage += `æˆåŠŸåˆ·æ–° ${refreshedFiles.length} ä¸ªæ–‡ä»¶\n`;
                    refreshedFiles.forEach(file => {
                        resultMessage += `âœ“ ${file.name}\n`;
                    });
                }

                if (filesNeedingPermission.length > 0) {
                    resultMessage += `\néœ€è¦é‡æ–°æˆæƒçš„æ–‡ä»¶:\n`;
                    filesNeedingPermission.forEach(file => {
                        resultMessage += `âš  ${file.name}\n`;
                    });

                    // æ˜¾ç¤ºæˆæƒå¯¹è¯æ¡†
                    setTimeout(() => {
                        requestFilesPermission(filesNeedingPermission);
                    }, 1000);
                }

                if (failedFiles.length > 0) {
                    resultMessage += `\nåˆ·æ–°å¤±è´¥çš„æ–‡ä»¶:\n`;
                    failedFiles.forEach(file => {
                        resultMessage += `âœ— ${file.name} (${file.reason})\n`;
                    });
                }

                // å¦‚æœæœ‰æˆåŠŸåˆ·æ–°çš„æ–‡ä»¶ï¼Œé‡æ–°ç”Ÿæˆå›¾è¡¨
                if (refreshedFiles.length > 0 && chart) {
                    showToast('æ­£åœ¨é‡æ–°ç”Ÿæˆå›¾è¡¨...', 'info', { duration: 2000 });
                    setTimeout(() => {
                        generateChart();
                    }, 500);
                }

                showToast(resultMessage.trim(),
                    failedFiles.length === 0 && filesNeedingPermission.length === 0 ? 'success' :
                    refreshedFiles.length > 0 ? 'warning' : 'error',
                    { duration: Math.max(5000, resultMessage.length * 50) }
                );
            }

            // éªŒè¯æ•°æ®ç»“æ„æ˜¯å¦ä¸€è‡´
            function validateDataStructure(newData, originalData) {
                if (!newData || !Array.isArray(newData) || newData.length === 0) {
                    return false;
                }

                // æ£€æŸ¥è¡Œæ•°å’Œåˆ—æ•°æ˜¯å¦ä¸€è‡´
                if (newData.length !== originalData.length) {
                    return false;
                }

                if (originalData.length > 0 && newData[0].length !== originalData[0].length) {
                    return false;
                }

                return true;
            }

            // è¯·æ±‚å¤šä¸ªæ–‡ä»¶çš„æƒé™
            async function requestFilesPermission(filesNeedingPermission) {
                if (!('showOpenFilePicker' in window)) {
                    showToast('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ­¤åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chromeæˆ–Edgeæµè§ˆå™¨', 'warning', { duration: 6000 });
                    return;
                }

                try {
                    // ä¸ºæ¯ä¸ªéœ€è¦æˆæƒçš„æ–‡ä»¶åˆ›å»ºæ–‡ä»¶é€‰æ‹©å™¨
                    const handles = [];

                    for (const file of filesNeedingPermission) {
                        showToast(`è¯·é€‰æ‹©æ–‡ä»¶ä»¥æ›¿æ¢ "${file.name}"`, 'info', { duration: 3000 });

                        const pickerOptions = {
                            multiple: false,
                            types: [
                                {
                                    description: 'CSV files',
                                    accept: {
                                        'text/csv': ['.csv'],
                                        'application/vnd.ms-excel': ['.csv'],
                                        'text/plain': ['.csv']
                                    }
                                }
                            ]
                        };

                        // è®¾ç½®é»˜è®¤æ‰“å¼€ç›®å½•
                        if (lastOpenedFileHandle) {
                            pickerOptions.startIn = lastOpenedFileHandle;
                        } else {
                            pickerOptions.startIn = 'downloads';
                        }

                        const fileHandles = await window.showOpenFilePicker(pickerOptions);

                        if (fileHandles.length > 0) {
                            handles.push({
                                originalIndex: file.index,
                                handle: fileHandles[0]
                            });
                        }
                    }

                    // å¤„ç†è·å–åˆ°çš„æ–°æ–‡ä»¶å¥æŸ„
                    for (const { originalIndex, handle } of handles) {
                        const file = await handle.getFile();
                        const fileContent = await file.text();
                        const parsedData = parseCSV(fileContent);

                        // éªŒè¯æ•°æ®ç»“æ„
                        if (validateDataStructure(parsedData, csvFiles[originalIndex].data)) {
                            // æ›´æ–°æ–‡ä»¶ä¿¡æ¯
                            csvFiles[originalIndex].data = parsedData;
                            csvFiles[originalIndex].fileHandle = handle;
                            csvFiles[originalIndex].file = file;
                            csvFiles[originalIndex].fileName = file.name;

                            // å¦‚æœæ˜¯å½“å‰é€‰ä¸­çš„æ–‡ä»¶ï¼Œæ›´æ–°é¢„è§ˆ
                            if (originalIndex === currentFileIndex) {
                                csvData = parsedData;
                                previewData();
                            }

                            showToast(`æ–‡ä»¶ "${csvFiles[originalIndex].displayName}" å·²é‡æ–°æˆæƒå¹¶åˆ·æ–°`, 'success', { duration: 3000 });
                        } else {
                            showToast(`æ–‡ä»¶ "${file.name}" çš„æ•°æ®ç»“æ„ä¸åŸæ–‡ä»¶ä¸åŒ¹é…`, 'error', { duration: 5000 });
                        }
                    }

                    // å¦‚æœæœ‰æ–‡ä»¶è¢«æˆåŠŸé‡æ–°æˆæƒï¼Œé‡æ–°ç”Ÿæˆå›¾è¡¨
                    if (handles.length > 0) {
                        setTimeout(() => {
                            generateChart();
                        }, 500);
                    }

                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.error('è·å–æ–‡ä»¶æƒé™æ—¶å‡ºé”™:', error);
                        showToast('è·å–æ–‡ä»¶æƒé™å¤±è´¥', 'error', { duration: 5000 });
                    }
                }
            }

            // åˆ·æ–°å½“å‰æ–‡ä»¶ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
            async function refreshCurrentFile() {
                if (!rememberedFileHandle) {
                    showToast('æ²¡æœ‰è®°ä½çš„æ–‡ä»¶ï¼Œè¯·å…ˆå¯¼å…¥æ–‡ä»¶', 'error', { duration: 7000 });
                    return;
                }

                showToast('æ­£åœ¨é‡æ–°è¯»å–æ–‡ä»¶...', 'info', { duration: 3000 });

                try {
                    // æ£€æŸ¥æ–‡ä»¶å¥æŸ„ç±»å‹
                    if (typeof rememberedFileHandle.getFile === 'function') {
                        // è¿™æ˜¯ FileSystemFileHandleï¼Œæœ‰æŒä¹…æƒé™
                        console.log('ä½¿ç”¨æœ‰æƒé™çš„æ–‡ä»¶å¥æŸ„åˆ·æ–°æ–‡ä»¶');
                        const file = await rememberedFileHandle.getFile();
                        const fileContent = await file.text();
                        processFileData(file.name, fileContent);
                        showToast('æ–‡ä»¶åˆ·æ–°æˆåŠŸ', 'success', { duration: 4000 });
                        return;
                    } else {
                        // è¿™æ˜¯æ™®é€š File å¯¹è±¡ï¼ˆæ‹–æ‹½å¯¼å…¥çš„ï¼‰ï¼Œæ— æ³•åˆ·æ–°
                        console.log('æ£€æµ‹åˆ°æ‹–æ‹½å¯¼å…¥çš„æ–‡ä»¶ï¼Œéœ€è¦é‡æ–°æˆæƒ');
                        showToast('å½“å‰æ–‡ä»¶æ˜¯æ‹–æ‹½å¯¼å…¥çš„ï¼Œéœ€è¦é‡æ–°è·å–æƒé™æ‰èƒ½åˆ·æ–°', 'info', { duration: 2000 });
                        // ç«‹å³è¯·æ±‚æƒé™ï¼Œæ— éœ€ç­‰å¾…
                        requestFilePermission();
                        return;
                    }

                } catch (error) {
                    console.error('æ–‡ä»¶åˆ·æ–°é”™è¯¯:', error);

                    // åˆ†æé”™è¯¯ç±»å‹å¹¶ç»™å‡ºç›¸åº”æç¤º
                    if (error.name === 'NotAllowedError' || error.message.includes('permission')) {
                        showToast('æ–‡ä»¶è®¿é—®æƒé™ä¸è¶³ï¼Œéœ€è¦é‡æ–°æˆæƒ', 'warning', { duration: 3000 });
                        // ç«‹å³è¯·æ±‚æƒé™ï¼Œæ— éœ€ç­‰å¾…
                        requestFilePermission();
                    } else if (error.name === 'NotFoundError') {
                        showToast('åŸæ–‡ä»¶å·²ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°å¯¼å…¥æ–‡ä»¶', 'error', { duration: 8000 });
                        rememberedFileHandle = null; // æ¸…é™¤æ— æ•ˆçš„æ–‡ä»¶å¼•ç”¨
                    } else if (error.message.includes('read')) {
                        showToast('æ— æ³•è¯»å–æ–‡ä»¶ï¼Œå¯èƒ½æ–‡ä»¶å·²è¢«ç§»åŠ¨æˆ–åˆ é™¤', 'error', { duration: 8000 });
                    } else {
                        showToast(`åˆ·æ–°æ–‡ä»¶æ—¶å‡ºé”™: ${error.message}`, 'error', { duration: 10000 });
                    }
                }
            }

            // è¯·æ±‚æ–‡ä»¶æƒé™
            async function requestFilePermission() {
                if (!('showOpenFilePicker' in window)) {
                    showToast('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ­¤åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chromeæˆ–Edgeæµè§ˆå™¨', 'warning', { duration: 6000 });
                    return;
                }

                try {
                    showToast('æ­£åœ¨è¯·æ±‚æ–‡ä»¶è®¿é—®æƒé™...', 'info', { duration: 3000 });

                    // è·å–åŸæ–‡ä»¶å
                    const fileName = rememberedFileHandle.name || rememberedFileHandle;
                    if (!fileName) {
                        throw new Error('æ— æ³•è·å–æ–‡ä»¶åä¿¡æ¯');
                    }

                    // ç¡®å®šèµ·å§‹ç›®å½•ï¼šä¼˜å…ˆä½¿ç”¨æœ€åæ‰“å¼€çš„æ–‡ä»¶è·¯å¾„ï¼Œå…¶æ¬¡ä½¿ç”¨è®°ä½çš„ç›®å½•ç±»å‹ï¼Œæœ€åä½¿ç”¨Downloads
                    let startInDirectory;
                    if (lastOpenedFileHandle) {
                        startInDirectory = lastOpenedFileHandle;
                    } else if (rememberedFileDirectory && rememberedFileDirectory !== 'documents') {
                        startInDirectory = rememberedFileDirectory;
                    } else {
                        startInDirectory = 'downloads';
                    }

                    // è·å–ç›®å½•çš„ä¸­æ–‡åç§°
                    const directoryNames = {
                        'desktop': 'æ¡Œé¢',
                        'downloads': 'ä¸‹è½½',
                        'documents': 'æ–‡æ¡£',
                        'pictures': 'å›¾ç‰‡',
                        'videos': 'è§†é¢‘',
                        'music': 'éŸ³ä¹'
                    };

                    let directoryName;
                    if (startInDirectory === lastOpenedFileHandle) {
                        directoryName = 'ä¸Šæ¬¡æ‰“å¼€æ–‡ä»¶æ‰€åœ¨ç›®å½•';
                    } else {
                        directoryName = directoryNames[startInDirectory] || 'ä¸‹è½½';
                    }

                    showToast(`è¯·é‡æ–°é€‰æ‹©åŒä¸€ä¸ªæ–‡ä»¶ä»¥è·å–æƒé™:<br><strong>${fileName}</strong><br><small>æ–‡ä»¶é€‰æ‹©å™¨å°†è‡ªåŠ¨æ‰“å¼€ <strong>${directoryName}</strong> ç›®å½•</small>`, 'info', { duration: 10000 });

                    const pickerOptions = {
                        types: [
                            {
                                description: 'CSV files',
                                accept: {
                                    'text/csv': ['.csv'],
                                },
                            },
                        ],
                        multiple: false,
                        startIn: startInDirectory
                    };

                    const [fileHandle] = await window.showOpenFilePicker(pickerOptions);

                    // éªŒè¯é€‰æ‹©çš„æ–‡ä»¶æ˜¯å¦ä¸åŸæ–‡ä»¶åŒ¹é…
                    if (fileHandle.name !== fileName) {
                        const directoryNames = {
                            'desktop': 'æ¡Œé¢',
                            'downloads': 'ä¸‹è½½',
                            'documents': 'æ–‡æ¡£',
                            'pictures': 'å›¾ç‰‡',
                            'videos': 'è§†é¢‘',
                            'music': 'éŸ³ä¹'
                        };

                        const currentDirectory = directoryNames[startInDirectory] || 'æ–‡æ¡£';
                        showToast('æ–‡ä»¶åä¸åŒ¹é…<br><small>è¯·é‡æ–°é€‰æ‹©ï¼Œæ–‡ä»¶åä¸ºï¼š<strong>' + fileName + '</strong><br>åº”è¯¥åœ¨ <strong>' + currentDirectory + '</strong> ç›®å½•ä¸­</small>', 'warning', { duration: 12000 });
                        return;
                    }

                    // è¯·æ±‚æŒä¹…åŒ–æƒé™
                    let hasPermission = false;
                    if ('requestPermission' in fileHandle) {
                        try {
                            const permission = await fileHandle.requestPermission({ mode: 'read' });
                            hasPermission = (permission === 'granted');
                        } catch (permError) {
                            console.warn('æƒé™è¯·æ±‚å¤±è´¥:', permError);
                            hasPermission = false;
                        }
                    }

                    // ä¿å­˜æ–°çš„æ–‡ä»¶å¥æŸ„ï¼ˆæœ‰æƒé™æˆ–æ— æƒé™ï¼‰
                    rememberedFileHandle = fileHandle;
                    rememberedFileDirectory = detectFileDirectory(fileHandle.name);
                    lastOpenedFileHandle = fileHandle; // åŒæ—¶æ›´æ–°æœ€åæ‰“å¼€çš„æ–‡ä»¶è·¯å¾„

                    // é‡æ–°è¯»å–æ–‡ä»¶
                    const file = await fileHandle.getFile();
                    const fileContent = await file.text();
                    processFileData(file.name, fileContent);

                    // æ ¹æ®æƒé™æƒ…å†µæ˜¾ç¤ºæç¤º
                    if (hasPermission) {
                        showToast('æƒé™è·å–æˆåŠŸï¼Œæ–‡ä»¶å·²åˆ·æ–°ï¼Œä¸‹æ¬¡åˆ·æ–°æ— éœ€é‡æ–°æˆæƒ', 'success', { duration: 5000 });
                    } else {
                        showToast('æ–‡ä»¶å·²åˆ·æ–°ï¼Œä½†ä¸‹æ¬¡åˆ·æ–°å¯èƒ½ä»éœ€æˆæƒ', 'warning', { duration: 6000 });
                    }

                } catch (error) {
                    console.error('è¯·æ±‚æ–‡ä»¶æƒé™å¤±è´¥:', error);
                    if (error.name !== 'AbortError') {
                        showToast('è¯·æ±‚æ–‡ä»¶æƒé™å¤±è´¥ï¼Œè¯·é‡è¯•', 'error', { duration: 7000 });
                    }
                }
            }

            // å¤„ç†æ–‡ä»¶æ•°æ®ï¼ˆç”¨äºåˆ·æ–°ï¼‰
            function processFileData(fileName, fileContent) {
                try {
                    console.log('å¼€å§‹å¤„ç†æ–‡ä»¶:', fileName);
                    console.log('æ–‡ä»¶å†…å®¹é•¿åº¦:', fileContent.length);

                    // è®¾ç½®æ–‡ä»¶å
                    csvFileName = fileName.replace(/\.[^/.]+$/, "");

                    // è§£æCSVæ•°æ®
                    csvData = parseCSV(fileContent);
                    console.log('è§£æåçš„CSVæ•°æ®è¡Œæ•°:', csvData.length);

                    if (csvData.length === 0) {
                        throw new Error('CSVæ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');
                    }

                    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºä¸Šä¼ åŒºåŸŸ
                    if (uploadPrompt.classList.contains('hidden')) {
                        // æ›´æ–°æ–‡ä»¶åæ˜¾ç¤ºå’Œæ–‡ä»¶ä¿¡æ¯
                        updateFileInfoForRefresh(fileName, csvData);
                    } else {
                        // é¦–æ¬¡åŠ è½½ï¼Œæ˜¾ç¤ºä¸Šä¼ åŒºåŸŸ
                        uploadPrompt.classList.add('hidden');
                        uploadSection.classList.add('has-file');
                        document.getElementById('fileName').textContent = `é¢„è§ˆ: ${fileName}`;
                        dataPreviewSection.classList.remove('hidden');
                        configSection.classList.remove('hidden');
                        setDefaultConfigOnly();
                    }


                    // é¢„è§ˆæ•°æ®
                    previewData();

                    // å¦‚æœå›¾è¡¨å·²ç”Ÿæˆï¼Œè‡ªåŠ¨é‡æ–°ç”ŸæˆåŠ¨ç”»
                    if (chart && !chartSection.classList.contains('hidden')) {
                        setTimeout(() => {
                            generateChart();
                        }, 500);
                    }
                } catch (error) {
                    console.error('æ–‡ä»¶å¤„ç†é”™è¯¯è¯¦æƒ…:', error);
                    showToast(`å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™: ${error.message}`, 'error', { duration: 10000 });
                }
            }

            // å¤„ç†æ–‡ä»¶
            function handleFile(file, isDragged = false) {
                if (!file.name.endsWith('.csv')) {
                    showToast('è¯·ä¸Šä¼  CSVæ ¼å¼çš„æ–‡ä»¶', 'error', { duration: 4000 });
                    return;
                }

                // å–æ¶ˆä¹‹å‰çš„è§£æä»»åŠ¡
                if (parseAbortController) {
                    parseAbortController.abort();
                }
                parseAbortController = new AbortController();

                // ç¦ç”¨é¡µé¢å¹¶æ˜¾ç¤ºè§£æè¿›åº¦
                mainContainer.classList.add('page-disabled');
                const parseToast = showToast('æ­£åœ¨è§£ææ–‡ä»¶ï¼Œè¯·ç¨å€™...', 'info', {
                    persistent: true,
                    showCancel: true,
                    onCancel: () => {
                        if (parseAbortController) {
                            parseAbortController.abort();
                            parseAbortController = null;
                        }
                        mainContainer.classList.remove('page-disabled');
                    }
                });

                // å­˜å‚¨æ–‡ä»¶å
                const rawFileName = file.name;
                csvFileName = rawFileName.replace(/\.[^/.]+$/, "");

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        // æ£€æŸ¥æ˜¯å¦å·²å–æ¶ˆ
                        if (parseAbortController.signal.aborted) {
                            return;
                        }

                        const fileContent = e.target.result;

                        // æ›´æ–°CSVè§£æå‡½æ•°ï¼Œå¤„ç†æœ«å°¾ç©ºå€¼
                        csvData = parseCSV(fileContent);

                        if (csvData.length === 0) {
                            throw new Error('CSVæ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®');
                        }

                        // æ·»åŠ ç¬¬ä¸€ä¸ªæ–‡ä»¶åˆ°å¤šæ–‡ä»¶ç³»ç»Ÿ
                        const fileName = rawFileName.replace(/\.[^/.]+$/, "");
                        addCsvFile(file, csvData, fileName);

                        // æ›´æ–°UI
                        uploadPrompt.classList.add('hidden');
                        uploadSection.classList.add('has-file');
                        fileName.textContent = `é¢„è§ˆ: ${rawFileName}`;
                        dataPreviewSection.classList.remove('hidden');

                        // é¢„è§ˆæ•°æ®
                        previewData();

                        // æ›´æ–°æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º
                        updateFileInfo(file, csvData);

                        // æ˜¾ç¤ºè®¾ç½®åŒºåŸŸ
                        configSection.classList.remove('hidden');

                        // åªé‡ç½®é»˜è®¤è®¾ç½®ï¼Œä¿ç•™æ‰‹åŠ¨è®¾ç½®
                        setDefaultConfigOnly();

                        // æ‹–æ‹½æ–‡ä»¶æ—¶çš„ç‰¹æ®Šå¤„ç†ï¼ˆåªæœ‰æ‹–æ‹½æ–‡ä»¶æ—¶æ‰éœ€è¦æ£€æŸ¥æƒé™å†²çªï¼‰
                        if (isDragged && rememberedFileHandle && typeof rememberedFileHandle.getFile === 'function') {
                            // å½“å‰å·²æœ‰æˆæƒæ–‡ä»¶ï¼ˆFileSystemFileHandleï¼‰ï¼Œè¯¢é—®ç”¨æˆ·æ˜¯å¦è¦æ›¿æ¢
                            const currentFileName = rememberedFileHandle.name;
                            const newFileName = file.name;

                            const message = `âš ï¸ æ£€æµ‹åˆ°é‡è¦æé†’ï¼š\n\n` +
                                `å½“å‰æ–‡ä»¶ "${currentFileName}" å…·æœ‰æŒä¹…è®¿é—®æƒé™ï¼Œåˆ·æ–°æ—¶æ— éœ€é‡æ–°é€‰æ‹©ã€‚\n\n` +
                                `æ‹–å…¥æ–°æ–‡ä»¶ "${newFileName}" å°†ï¼š\n` +
                                `â€¢ å¤±å»æŒä¹…è®¿é—®æƒé™\n` +
                                `â€¢ åˆ·æ–°æ—¶éœ€è¦é‡æ–°é€‰æ‹©æ–‡ä»¶\n\n` +
                                `æ˜¯å¦è¦ç»§ç»­æ‹–å…¥æ“ä½œï¼Ÿ\n\n` +
                                `â€¢ ç¡®å®šï¼šä½¿ç”¨æ–°æ–‡ä»¶ï¼ˆå¤±å»æŒä¹…æƒé™ï¼‰\n` +
                                `â€¢ å–æ¶ˆï¼šä¿ç•™åŸæ–‡ä»¶ï¼ˆç»´æŒæŒä¹…æƒé™ï¼‰`;

                            if (!confirm(message)) {
                                // ç”¨æˆ·å–æ¶ˆï¼Œä¿ç•™åŸæˆæƒæ–‡ä»¶
                                showToast(`âœ… å·²ä¿ç•™åŸæ–‡ä»¶: ${currentFileName}`, 'success', { duration: 4000 });
                                removeToast(parseToast);
                                mainContainer.classList.remove('page-disabled');
                                parseAbortController = null;
                                return;
                            }

                            // ç”¨æˆ·ç¡®è®¤ï¼Œæ›¿æ¢ä¸ºæ‹–å…¥æ–‡ä»¶
                            showToast(`âš ï¸ å·²åˆ‡æ¢åˆ°æ‹–å…¥æ–‡ä»¶: ${newFileName}ï¼ŒæŒä¹…æƒé™å·²æ¸…é™¤`, 'warning', { duration: 6000 });
                        }

                        // åªæœ‰æ‹–æ‹½æ–‡ä»¶æ—¶æ‰ä¿å­˜æ–‡ä»¶å¼•ç”¨ï¼ˆæŒ‰é’®å¯¼å…¥çš„æ–‡ä»¶å·²åœ¨ selectFileWithPermission ä¸­ä¿å­˜ï¼‰
                        if (isDragged) {
                            rememberedFileHandle = file;
                            rememberedFileDirectory = detectFileDirectory(file.name);
                            console.log('æ‹–å…¥æ–‡ä»¶å·²ä¿å­˜:', file.name);
                            console.log('æ–‡ä»¶å¥æŸ„ç±»å‹:', file.constructor.name);
                        }

                        // ç§»é™¤è§£æè¿›åº¦æç¤º
                        removeToast(parseToast);
                        mainContainer.classList.remove('page-disabled');
                        parseAbortController = null;

                        showToast('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œè¯·è®¾ç½®å‚æ•°', 'success', { duration: 4000 });

                        // å¦‚æœå›¾è¡¨å·²ç”Ÿæˆï¼Œè‡ªåŠ¨é‡æ–°ç”ŸæˆåŠ¨ç”»
                        if (chart && !chartSection.classList.contains('hidden')) {
                            setTimeout(() => {
                                generateChart();
                            }, 500);
                        }
                    } catch (error) {
                        console.error('æ–‡ä»¶å¤„ç†é”™è¯¯è¯¦æƒ…:', error);
                        // ç§»é™¤è§£æè¿›åº¦æç¤º
                        removeToast(parseToast);
                        mainContainer.classList.remove('page-disabled');
                        parseAbortController = null;

                        let errorMessage = `è§£æCSVæ–‡ä»¶æ—¶å‡ºé”™: ${error.message}`;

                        // å¦‚æœæ˜¯æƒé™é”™è¯¯ï¼Œæä¾›æ›´è¯¦ç»†çš„è¯´æ˜
                        if (error.name === 'NotAllowedError') {
                            errorMessage = 'æ–‡ä»¶è®¿é—®æƒé™è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æƒé™æˆ–é‡æ–°é€‰æ‹©æ–‡ä»¶';
                        } else if (error.message.includes('permission')) {
                            errorMessage = 'æ–‡ä»¶æƒé™ä¸è¶³ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æƒé™æˆ–é‡æ–°é€‰æ‹©æ–‡ä»¶';
                        }

                        showToast(errorMessage, 'error', { duration: 10000 });
                    }
                };

                reader.onerror = function() {
                    console.error('æ–‡ä»¶è¯»å–é”™è¯¯:', reader.error);
                    removeToast(parseToast);
                    mainContainer.classList.remove('page-disabled');
                    parseAbortController = null;

                    let errorMessage = 'æ–‡ä»¶è¯»å–å¤±è´¥';
                    if (reader.error) {
                        errorMessage += `: ${reader.error.message}`;
                    }

                    // å¦‚æœæ˜¯æƒé™é”™è¯¯ï¼Œæä¾›æ›´è¯¦ç»†çš„è¯´æ˜
                    if (reader.error && reader.error.name === 'NotAllowedError') {
                        errorMessage = 'æ–‡ä»¶è®¿é—®æƒé™è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æƒé™æˆ–é‡æ–°é€‰æ‹©æ–‡ä»¶';
                    } else if (reader.error && reader.error.message.includes('permission')) {
                        errorMessage = 'æ–‡ä»¶æƒé™ä¸è¶³ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æƒé™æˆ–é‡æ–°é€‰æ‹©æ–‡ä»¶';
                    }

                    showToast(errorMessage, 'error', { duration: 10000 });
                };

                reader.readAsText(file);
            }

            // ä¿®æ”¹åçš„CSVè§£æå‡½æ•° - å¤„ç†æœ«å°¾ç©ºå€¼
            function parseCSV(text) {
                const rows = text.split('\n').map(row => {
                    // åˆ†å‰²è¡Œå¹¶å»é™¤ç©ºæ ¼
                    let cells = row.split(',').map(cell => cell.trim());

                    // ç§»é™¤è¡Œæœ«å°¾çš„ç©ºå€¼ï¼ˆç”±äºé€—å·å¯¼è‡´çš„ç©ºå€¼ï¼‰
                    while (cells.length > 0 && (cells[cells.length - 1] === '' || cells[cells.length - 1] === 'NaN')) {
                        cells.pop();
                    }

                    return cells;
                });

                // è¿‡æ»¤æ‰ç©ºè¡Œ
                return rows.filter(row => row.length > 0);
            }

            // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°æ˜¾ç¤º
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';

                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));

                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // æ›´æ–°æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤ºï¼ˆåˆ·æ–°æ—¶ä½¿ç”¨ï¼Œæ— æ–‡ä»¶å¤§å°ä¿¡æ¯ï¼‰
            function updateFileInfoForRefresh(fileName, data) {
                // è®¡ç®—æ–‡ä»¶ä¿¡æ¯
                const rowCount = data.length;
                const colCount = data.length > 0 ? data[0].length : 0;

                // æ›´æ–°æ–‡ä»¶åæ˜¾ç¤ºï¼Œæ·»åŠ æ–‡ä»¶ä¿¡æ¯ï¼ˆä¸å«æ–‡ä»¶å¤§å°ï¼‰
                fileName.innerHTML = `é¢„è§ˆ: ${fileName} <span style="color: #666; font-size: 0.9em; font-weight: normal;">(${rowCount}è¡Œ Ã— ${colCount}åˆ—)</span>`;
            }

            // æ›´æ–°æ–‡ä»¶ä¿¡æ¯æ˜¾ç¤º
            function updateFileInfo(file, data) {
                // è®¡ç®—æ–‡ä»¶ä¿¡æ¯
                const fileSize = formatFileSize(file.size);
                const rowCount = data.length;
                const colCount = data.length > 0 ? data[0].length : 0;

                // æ›´æ–°æ–‡ä»¶åæ˜¾ç¤ºï¼Œæ·»åŠ æ–‡ä»¶ä¿¡æ¯
                fileName.innerHTML = `é¢„è§ˆ: ${file.name} <span style="color: #666; font-size: 0.9em; font-weight: normal;">(${fileSize} | ${rowCount}è¡Œ Ã— ${colCount}åˆ—)</span>`;
            }

            // é¢„è§ˆæ•°æ® - ä¿®æ”¹è¡Œå·åˆ—æ ·å¼
            function previewData() {
                const previewRows = csvData.slice(0, 50); // åªæ˜¾ç¤ºå‰50è¡Œ

                let html = '<table><thead><tr>';
                // æ·»åŠ è¡Œå·è¡¨å¤´ï¼Œåº”ç”¨å›ºå®šæ ·å¼
                html += '<th class="row-number-header"></th>';
                // è¡¨å¤´
                if (previewRows.length > 0) {
                    for (let i = 0; i < previewRows[0].length; i++) {
                        html += `<th>åˆ— ${i + 1}</th>`;
                    }
                }
                html += '</tr></thead><tbody>';

                // æ•°æ®è¡Œ
                for (let i = 0; i < previewRows.length; i++) {
                    html += '<tr>';
                    // æ·»åŠ è¡Œå·ï¼Œåº”ç”¨å›ºå®šæ ·å¼
                    html += `<td class="row-number">è¡Œ${i + 1}</td>`;
                    for (let j = 0; j < previewRows[i].length; j++) {
                        html += `<td>${previewRows[i][j]}</td>`;
                    }
                    html += '</tr>';
                }

                html += '</tbody></table>';
                dataPreview.innerHTML = html;
            }

            // é»˜è®¤è®¾ç½®
            function setDefaultConfig() {
                // é‡ç½®æ‰‹åŠ¨ä¿®æ”¹æ ‡è®°
                manuallyModified.clear();

                // è®¾ç½®é»˜è®¤å€¼å¹¶åº”ç”¨é»˜è®¤æ ·å¼
                function setDefaultValue(element, value) {
                    element.value = value;
                    element.classList.remove('manual-value');
                    element.classList.add('default-value');
                }

                setDefaultValue(xAxisRowInput, '1');
                setDefaultValue(startRowInput, '2');
                setDefaultValue(endRowInput, '-1');
                setDefaultValue(startColInput, '2');
                setDefaultValue(endColInput, '-1');
                setDefaultValue(constantRowsInput, '');
                setDefaultValue(frameIntervalInput, '50');
                setDefaultValue(skipFramesInput, '0');
                setDefaultValue(xMinInput, 'auto');
                setDefaultValue(xMaxInput, 'auto');
                setDefaultValue(yMinInput, 'auto');
                setDefaultValue(yMaxInput, 'auto');
                setDefaultValue(showLegendSelect, 'false');
                setDefaultValue(tooltipModeSelect, 'compact');
                setDefaultValue(xAxisTypeSelect, 'linear');
                setDefaultValue(chartTitleInput, csvFileName || 'æ•°æ®åŠ¨ç”»');
                setDefaultValue(yAxisLabelInput, 'Yè½´');

                // æ›´æ–°Xè½´ç›¸å…³çš„é»˜è®¤å€¼
                updateXAxisRange();
                updateXAxisLabel();
            }

            // åªé‡ç½®é»˜è®¤è®¾ç½®ï¼Œä¿ç•™æ‰‹åŠ¨è®¾ç½®
            function setDefaultConfigOnly() {
                // è®¾ç½®é»˜è®¤å€¼çš„å‡½æ•°ï¼ˆåªå¯¹æœªæ‰‹åŠ¨ä¿®æ”¹çš„å­—æ®µè¿›è¡Œè®¾ç½®ï¼‰
                function setDefaultValueIfNotModified(element, fieldName, value) {
                    if (!manuallyModified.has(fieldName)) {
                        element.value = value;
                        element.classList.remove('manual-value');
                        element.classList.add('default-value');
                    }
                }

                setDefaultValueIfNotModified(xAxisRowInput, 'xAxisRow', '1');
                setDefaultValueIfNotModified(startRowInput, 'startRow', '2');
                setDefaultValueIfNotModified(endRowInput, 'endRow', '-1');
                setDefaultValueIfNotModified(startColInput, 'startCol', '2');
                setDefaultValueIfNotModified(endColInput, 'endCol', '-1');
                setDefaultValueIfNotModified(constantRowsInput, 'constantRows', '');
                setDefaultValueIfNotModified(frameIntervalInput, 'frameInterval', '50');
                setDefaultValueIfNotModified(skipFramesInput, 'skipFrames', '0');
                setDefaultValueIfNotModified(xMinInput, 'xMin', 'auto');
                setDefaultValueIfNotModified(xMaxInput, 'xMax', 'auto');
                setDefaultValueIfNotModified(yMinInput, 'yMin', 'auto');
                setDefaultValueIfNotModified(yMaxInput, 'yMax', 'auto');
                setDefaultValueIfNotModified(showLegendSelect, 'showLegend', 'false');
                setDefaultValueIfNotModified(tooltipModeSelect, 'tooltipMode', 'compact');
                setDefaultValueIfNotModified(xAxisTypeSelect, 'xAxisType', 'linear');
                setDefaultValueIfNotModified(chartTitleInput, 'chartTitle', csvFileName || 'æ•°æ®åŠ¨ç”»');
                setDefaultValueIfNotModified(yAxisLabelInput, 'yAxisLabel', 'Yè½´');

                // æ›´æ–°Xè½´ç›¸å…³çš„é»˜è®¤å€¼ï¼ˆå¦‚æœæœªæ‰‹åŠ¨ä¿®æ”¹ï¼‰
                if (!manuallyModified.has('xMin') || !manuallyModified.has('xMax')) {
                    updateXAxisRange();
                }
                if (!manuallyModified.has('xAxisLabel')) {
                    updateXAxisLabel();
                }

                // æ›´æ–°å›¾ä¾‹æ˜¾ç¤ºè®¾ç½®
                updateLegendDisplay();
            }

            // é‡ç½®è®¾ç½®
            function resetConfig() {
                setDefaultConfig();
                showToast('è®¾ç½®å·²é‡ç½®', 'success', { duration: 4000 });
            }

            // è§£æå¸¸æ˜¾è¡Œè®¾ç½®
            function parseConstantRows(constantRowsStr) {
                if (!constantRowsStr.trim()) {
                    return [];
                }

                return constantRowsStr.split(',')
                    .map(s => s.trim())
                    .filter(s => s !== '')
                    .map(s => parseInt(s))
                    .filter(n => !isNaN(n))
                    .map(n => {
                        // å¤„ç†è´Ÿæ•°ç´¢å¼•ï¼ˆå€’æ•°ï¼‰
                        if (n < 0) {
                            return csvData.length + n; // è½¬æ¢ä¸ºæ­£ç´¢å¼•
                        } else {
                            return n - 1; // è½¬æ¢ä¸º0-basedç´¢å¼•
                        }
                    })
                    .filter(n => n >= 0 && n < csvData.length); // éªŒè¯ç´¢å¼•æœ‰æ•ˆæ€§
            }

            // ç”ŸæˆåŠ¨ç”»
            function generateChart() {
                try {
                    // æ£€æŸ¥ Chart.js æ˜¯å¦å·²åŠ è½½
                    if (typeof Chart === 'undefined') {
                        // æä¾›è¯¦ç»†çš„è¯Šæ–­ä¿¡æ¯
                        const errorMsg = 'Chart.js åº“æœªåŠ è½½å®Œæˆ\n\n' +
                            'å¯èƒ½çš„åŸå› ï¼š\n' +
                            '1. å›½å†…ç½‘ç»œè®¿é—® CDN å—é™\n' +
                            '2. ç½‘ç»œï¼ˆå…¬å¸/å­¦æ ¡ï¼‰é™åˆ¶äº†å¤–éƒ¨èµ„æº\n' +
                            '3. é˜²ç«å¢™æˆ–å®‰å…¨è½¯ä»¶ï¼ˆ360ã€ç«ç»’ç­‰ï¼‰é˜»æ­¢äº†åŠ è½½\n' +
                            '4. ç½‘ç»œè¿æ¥ä¸ç¨³å®šæˆ– DNS è§£æå¤±è´¥\n\n' +
                            'è§£å†³æ–¹æ¡ˆï¼š\n' +
                            'â€¢ ç­‰å¾…å‡ ç§’åå†è¯•\n' +
                            'â€¢ åˆ·æ–°é¡µé¢ (F5)\n' +
                            'â€¢ åˆ‡æ¢ç½‘ç»œï¼ˆå¦‚ä½¿ç”¨æ‰‹æœºçƒ­ç‚¹ï¼‰\n' +
                            'â€¢ æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å° (F12) äº†è§£è¯¦ç»†ä¿¡æ¯\n' +
                            'â€¢ æš‚æ—¶å…³é—­é˜²ç«å¢™/å®‰å…¨è½¯ä»¶æµ‹è¯•';

                        showToast('Chart.js åº“åŠ è½½å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°', 'error', { duration: 10000 });
                        console.error(errorMsg);
                        throw new Error(errorMsg);
                    }

                    // æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶
                    if (csvFiles.length === 0) {
                        throw new Error('è¯·å…ˆä¸Šä¼ CSVæ–‡ä»¶');
                    }

                    // è·å–è®¾ç½®
                    const xAxisRow = parseInt(xAxisRowInput.value) - 1; // è½¬æ¢ä¸º0-basedç´¢å¼•
                    const startRow = parseInt(startRowInput.value) - 1;
                    const endRow = parseInt(endRowInput.value);
                    const startCol = parseInt(startColInput.value) - 1;
                    const endCol = parseInt(endColInput.value);
                    const constantRowsStr = constantRowsInput.value;
                    const frameInterval = parseInt(frameIntervalInput.value);
                    const skipFrames = parseInt(skipFramesInput.value) || 0;
                    const xMin = xMinInput.value === 'auto' ? null : parseFloat(xMinInput.value);
                    const xMax = xMaxInput.value === 'auto' ? null : parseFloat(xMaxInput.value);
                    const yMin = yMinInput.value === 'auto' ? null : parseFloat(yMinInput.value);
                    const yMax = yMaxInput.value === 'auto' ? null : parseFloat(yMaxInput.value);

                    // è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦éœ€è¦æ˜¾ç¤ºå›¾ä¾‹
                    let shouldShowLegend = showLegendSelect.value === 'true';

                    // æ£€æŸ¥æ˜¯å¦æœ‰å¸¸æ˜¾è¡Œéœ€è¦æ˜¾ç¤º
                    const hasGlobalConstantRows = constantRowsStr.trim() !== '';
                    const hasFileConstantRows = csvFiles.some(file => file.constantRows && file.constantRows.trim() !== '');

                    // å¦‚æœæœ‰å¸¸æ˜¾è¡Œè®¾ç½®æˆ–å¤šä¸ªæ–‡ä»¶ï¼Œè‡ªåŠ¨å¯ç”¨å›¾ä¾‹
                    if ((hasGlobalConstantRows || hasFileConstantRows || csvFiles.length > 1) && !shouldShowLegend) {
                        shouldShowLegend = true;
                        showLegendSelect.value = 'true';
                    }

                    const showLegend = shouldShowLegend;
                    const xAxisType = xAxisTypeSelect.value;
                    const chartTitle = chartTitleInput.value;
                    const xAxisLabel = xAxisLabelInput.value;
                    const yAxisLabel = yAxisLabelInput.value;

                    // è®¡ç®—Xè½´çš„å®é™…èŒƒå›´ï¼ˆå¤šæ–‡ä»¶ï¼‰
                    let xMinForAuto = xMin;
                    let xMaxForAuto = xMax;
                    if (xAxisType === 'linear' && (isNaN(xMin) || isNaN(xMax))) {
                        // è®¡ç®—æ‰€æœ‰æ–‡ä»¶çš„Xè½´èŒƒå›´
                        let allXValues = [];
                        for (const file of csvFiles) {
                            const fileXAxisData = file.data[xAxisRow].slice(startCol, endCol);
                            for (const val of fileXAxisData) {
                                if (val !== '' && !isNaN(parseFloat(val))) {
                                    allXValues.push(parseFloat(val));
                                }
                            }
                        }
                        if (allXValues.length > 0) {
                            // ä½¿ç”¨å¾ªç¯ä»£æ›¿æ‰©å±•è¿ç®—ç¬¦,é¿å…Windowsä¸‹å‚æ•°æ•°é‡é™åˆ¶å¼‚å¸¸
                            if (isNaN(xMin)) {
                                xMinForAuto = allXValues[0];
                                for (let i = 1; i < allXValues.length; i++) {
                                    if (allXValues[i] < xMinForAuto) xMinForAuto = allXValues[i];
                                }
                            }
                            if (isNaN(xMax)) {
                                xMaxForAuto = allXValues[0];
                                for (let i = 1; i < allXValues.length; i++) {
                                    if (allXValues[i] > xMaxForAuto) xMaxForAuto = allXValues[i];
                                }
                            }
                        }
                    }

                    // éªŒè¯æ‰€æœ‰æ–‡ä»¶çš„ç»“æ„å…¼å®¹æ€§
                    const firstFile = csvFiles[0].data;
                    for (let i = 1; i < csvFiles.length; i++) {
                        const fileData = csvFiles[i].data;
                        if (fileData.length !== firstFile.length || fileData[0].length !== firstFile[0].length) {
                            throw new Error(`æ–‡ä»¶ "${csvFiles[i].fileName}" çš„ç»“æ„ä¸ç¬¬ä¸€ä¸ªæ–‡ä»¶ä¸å…¼å®¹`);
                        }
                    }

                    // éªŒè¯è®¾ç½®
                    if (xAxisRow < 0 || xAxisRow >= firstFile.length) {
                        throw new Error('Xè½´æ•°æ®è¡Œå·è¶…å‡ºèŒƒå›´');
                    }

                    // è®¡ç®—å®é™…ç»“æŸè¡Œ/åˆ—
                    const actualEndRow = endRow < 0 ? firstFile.length + endRow : endRow;
                    const actualEndCol = endCol < 0 ? firstFile[0].length + endCol : endCol;

                    if (startRow < 0 || startRow >= firstFile.length || actualEndRow < 0 || actualEndRow >= firstFile.length || startRow > actualEndRow) {
                        throw new Error('Yè½´è¡ŒèŒƒå›´æ— æ•ˆ');
                    }

                    if (startCol < 0 || startCol >= firstFile[0].length || actualEndCol < 0 || actualEndCol >= firstFile[0].length || startCol > actualEndCol) {
                        throw new Error('Yè½´åˆ—èŒƒå›´æ— æ•ˆ');
                    }

                    // å‡†å¤‡å¸¸æ˜¾è¡Œæ•°æ®ï¼ˆæ¥è‡ªæ‰€æœ‰æ–‡ä»¶ï¼‰
                    constantRowsData = [];
                    // å¸¸æ˜¾è¡Œè‰²ç³»ï¼šä½¿ç”¨å†·è‰²è°ƒï¼Œè¾ƒä¸ºæŸ”å’Œï¼Œé€‚åˆä½œä¸ºå‚è€ƒçº¿
                    const constantRowColors = ['#5DADE2', '#48C9B0', '#45B7D1', '#7FB3D5', '#85C1E9', '#76D7C4', '#5499C7', '#2E86AB'];
                    // åŠ¨æ€æ•°æ®è‰²ç³»ï¼šä½¿ç”¨é²œæ˜å¯¹æ¯”è‰²ï¼Œçªå‡ºåŠ¨æ€å˜åŒ–
                    const dynamicDataColors = ['#E74C3C', '#F39C12', '#27AE60', '#8E44AD', '#E67E22', '#16A085', '#D35400', '#C0392B'];
                    for (let fileIndex = 0; fileIndex < csvFiles.length; fileIndex++) {
                        const fileInfo = csvFiles[fileIndex];
                        const fileData = fileInfo.data;

                        // æå–å½“å‰æ–‡ä»¶çš„Xè½´æ•°æ®
                        const fileXAxisData = fileData[xAxisRow].slice(startCol, actualEndCol + 1);

                        // è§£æå½“å‰æ–‡ä»¶çš„å¸¸æ˜¾è¡Œï¼ˆä¼˜å…ˆä½¿ç”¨æ–‡ä»¶ç‹¬ç«‹è®¾ç½®ï¼‰
                        let constantRowIndices = [];
                        if (fileInfo.constantRows && fileInfo.constantRows.trim()) {
                            // æ–‡ä»¶æœ‰ç‹¬ç«‹è®¾ç½®ï¼Œä½¿ç”¨æ–‡ä»¶è®¾ç½®
                            constantRowIndices = parseConstantRows(fileInfo.constantRows.trim());
                        } else {
                            // æ–‡ä»¶æ²¡æœ‰ç‹¬ç«‹è®¾ç½®ï¼Œä½¿ç”¨å…¨å±€è®¾ç½®
                            constantRowIndices = parseConstantRows(constantRowsStr);
                        }

                        for (let constRowIndex of constantRowIndices) {
                            if (constRowIndex < 0 || constRowIndex >= fileData.length) {
                                continue; // è·³è¿‡æ— æ•ˆçš„è¡Œç´¢å¼•
                            }

                            const rowData = fileData[constRowIndex].slice(startCol, actualEndCol + 1);
                            const datasets = [];

                            for (let j = 0; j < rowData.length; j++) {
                                // è·³è¿‡ç©ºå€¼å’ŒNaN
                                if (rowData[j] === '' || rowData[j] === 'NaN' || isNaN(parseFloat(rowData[j]))) {
                                    continue;
                                }

                                datasets.push({
                                    x: xAxisType === 'linear' ? parseFloat(fileXAxisData[j]) : fileXAxisData[j],
                                    y: parseFloat(rowData[j])
                                });
                            }

                            if (datasets.length > 0) {
                                const rowLabel = fileData[constRowIndex][0] || `è¡Œ ${constRowIndex + 1}`;
                                // ä¸ºæ¯ä¸ªå¸¸æ˜¾è¡Œåˆ†é…ç‹¬ç«‹é¢œè‰²ï¼šåŸºäºå¸¸æ˜¾è¡Œåœ¨å…¨å±€ä¸­çš„ä½ç½®
                                const globalConstRowIndex = fileIndex * constantRowIndices.length + constantRowIndices.indexOf(constRowIndex);
                                const colorIndex = globalConstRowIndex % constantRowColors.length;
                                constantRowsData.push({
                                    label: `${fileInfo.displayName} - ${rowLabel}`, // åŒ…å«æ–‡ä»¶åçš„æ ‡ç­¾
                                    data: datasets,
                                    fileName: fileInfo.displayName,
                                    fileIndex: fileIndex,
                                    color: constantRowColors[colorIndex] // ä½¿ç”¨å¸¸æ˜¾è¡Œè‰²ç³»
                                });
                            }
                        }
                    }

                    // æå–Yè½´æ•°æ®å¹¶å‡†å¤‡å¸§æ•°æ®ï¼ˆåº”ç”¨è·³å¸§è®¾ç½®ï¼‰- å¤šæ–‡ä»¶ç‰ˆæœ¬
                    allFilesFrameData = []; // å­˜å‚¨æ‰€æœ‰æ–‡ä»¶çš„å¸§æ•°æ®

                    for (let fileIndex = 0; fileIndex < csvFiles.length; fileIndex++) {
                        const fileData = csvFiles[fileIndex].data;
                        const fileFrameData = [];

                        // æå–å½“å‰æ–‡ä»¶çš„Xè½´æ•°æ®
                        const fileXAxisData = fileData[xAxisRow].slice(startCol, actualEndCol + 1);

                        for (let i = startRow; i <= actualEndRow; i += (skipFrames + 1)) {
                            const rowData = fileData[i].slice(startCol, actualEndCol + 1);
                            const datasets = [];

                            for (let j = 0; j < rowData.length; j++) {
                                // è·³è¿‡ç©ºå€¼å’ŒNaN
                                if (rowData[j] === '' || rowData[j] === 'NaN' || isNaN(parseFloat(rowData[j]))) {
                                    continue;
                                }

                                datasets.push({
                                    x: xAxisType === 'linear' ? parseFloat(fileXAxisData[j]) : fileXAxisData[j],
                                    y: parseFloat(rowData[j])
                                });
                            }

                            fileFrameData.push(datasets);
                        }

                        allFilesFrameData.push({
                            fileName: csvFiles[fileIndex].fileName,
                            frameData: fileFrameData,
                            color: dynamicDataColors[fileIndex % dynamicDataColors.length] // ä½¿ç”¨åŠ¨æ€æ•°æ®è‰²ç³»
                        });
                    }

                    // ä¿æŒå‘åå…¼å®¹æ€§ï¼Œè®¾ç½®ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„æ•°æ®ä¸ºé»˜è®¤frameData
                    frameData = allFilesFrameData[0].frameData;

                    if (frameData.length === 0) {
                        throw new Error('æ²¡æœ‰æœ‰æ•ˆçš„æ•°æ®å¯æ˜¾ç¤º');
                    }

                    // æ˜¾ç¤ºåŠ¨ç”»åŒºåŸŸ
                    chartSection.classList.remove('hidden');

                    // åˆ›å»ºåŠ¨ç”»
                    if (chart) {
                        chart.destroy();
                    }

                    const ctx = document.createElement('canvas');
                    chartContainer.innerHTML = '';
                    chartContainer.appendChild(ctx);

                    // è·å–ç¬¬ä¸€å¸§çš„æ—¶é—´ï¼ˆç”¨äºåˆå§‹æ ‡é¢˜ï¼‰
                    const firstFrameTime = firstFile[startRow][0];

                    // å‡†å¤‡æ•°æ®é›† - å¤šæ–‡ä»¶ç‰ˆæœ¬
                    const datasets = [];

                    // æ·»åŠ æ‰€æœ‰æ–‡ä»¶çš„åŠ¨æ€æ•°æ®é›†
                    for (let fileIndex = 0; fileIndex < allFilesFrameData.length; fileIndex++) {
                        const fileInfo = allFilesFrameData[fileIndex];
                        const csvFileInfo = csvFiles[fileIndex];
                        datasets.push({
                            label: csvFileInfo.displayName, // ä½¿ç”¨æ˜¾ç¤ºåç§°
                            data: fileInfo.frameData[0], // ç¬¬ä¸€å¸§æ•°æ®
                            borderColor: fileInfo.color,
                            backgroundColor: fileInfo.color + '20', // æ·»åŠ é€æ˜åº¦
                            borderWidth: 2.5, // åŠ¨æ€æ•°æ®çº¿æ¡é€‚ä¸­ç²—ç»†
                            pointRadius: 0, // å»æ‰ç‚¹æ ‡è®°
                            pointHoverRadius: 5, // é¼ æ ‡æ‚¬æµ®æ—¶æ˜¾ç¤ºç‚¹
                            tension: 0.1,
                            borderDash: [] // ç¡®ä¿ä½¿ç”¨å®çº¿
                        });
                    }

                    // æ·»åŠ å¸¸æ˜¾è¡Œæ•°æ®é›†ï¼ˆæ¥è‡ªæ‰€æœ‰æ–‡ä»¶ï¼‰
                    for (let i = 0; i < constantRowsData.length; i++) {
                        const constRowData = constantRowsData[i];
                        datasets.push({
                            label: constRowData.label,
                            data: constRowData.data,
                            borderColor: constRowData.color,
                            backgroundColor: constRowData.color + '20',
                            borderWidth: 1.5, // å¸¸æ˜¾è¡Œä½¿ç”¨ç»†å®çº¿
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            tension: 0.1,
                            borderDash: [] // ä½¿ç”¨å®çº¿
                        });
                    }

                    chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            datasets: datasets
                        },
                        plugins: [{
                            id: 'crosshair',
                            afterDraw: (chart) => {
                                // ä»…å½“tooltipæ¿€æ´»æ—¶ï¼ˆå³é¼ æ ‡åœ¨å›¾è¡¨ä¸Šï¼‰æ‰ç»˜åˆ¶
                                if (chart.tooltip?.getActiveElements().length) {
                                    const activePoint = chart.tooltip.getActiveElements()[0];
                                    const ctx = chart.ctx;
                                    const x = activePoint.element.x;
                                    const topY = chart.scales.y.top;
                                    const bottomY = chart.scales.y.bottom;

                                    ctx.save();
                                    ctx.beginPath();
                                    ctx.moveTo(x, topY);
                                    ctx.lineTo(x, bottomY);
                                    ctx.lineWidth = 1;
                                    ctx.strokeStyle = 'grey'; // è®¾ç½®çº¿æ¡ä¸ºç°è‰²
                                    ctx.setLineDash([5, 5]); // è®¾ç½®ä¸ºè™šçº¿
                                    ctx.stroke();
                                    ctx.restore();
                                }
                            }
                        }],
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 0 // ç¦ç”¨æ‰€æœ‰åŠ¨ç”»
                            },
                            interaction: {
                                intersect: false, // é¼ æ ‡ä¸éœ€è¦ç²¾ç¡®ç§»åŠ¨åˆ°ç‚¹ä¸Š
                                mode: 'index',    // æŒ‰Xè½´ç´¢å¼•æŸ¥æ‰¾æœ€è¿‘çš„ç‚¹
                            },
                            plugins: {
                                tooltip: {
                                    animation: false,
                                    enabled: function(context) {
                                        return tooltipModeSelect.value !== 'off';
                                    },
                                    callbacks: {
                                        title: function(context) {
                                            const xAxisLabel = xAxisLabelInput.value || 'Xè½´';
                                            return `${xAxisLabel}: ${context[0].label}`;
                                        },
                                        label: function(context) {
                                            const tooltipMode = tooltipModeSelect.value;
                                            if (tooltipMode === 'compact') {
                                                // ç¼©ç•¥æ˜¾ç¤ºï¼šåªæ˜¾ç¤ºæ•°æ®å€¼
                                                return `${context.parsed.y.toFixed(4)}`;
                                            } else if (tooltipMode === 'full') {
                                                // å®Œæ•´æ˜¾ç¤ºï¼šæ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯å’Œæ•°æ®å€¼
                                                return `${context.dataset.label}: ${context.parsed.y.toFixed(4)}`;
                                            } else {
                                                // å…³é—­æ˜¾ç¤ºï¼šè¿”å›ç©ºå­—ç¬¦ä¸²
                                                return '';
                                            }
                                        }
                                    }
                                },
                                title: {
                                    display: true,
                                    text: [chartTitle, `${firstFrameTime}`],
                                    font: {
                                        size: 16
                                    }
                                },
                                legend: {
                                    display: showLegend // ä½¿ç”¨è®¾ç½®çš„æ˜¾ç¤ºå›¾ä¾‹è®¾ç½®
                                }
                            },
                            scales: {
                                x: {
                                    type: xAxisType,
                                    title: {
                                        display: true,
                                        text: xAxisLabel
                                    },
                                    min: xAxisType === 'linear' ? xMinForAuto : undefined,
                                    max: xAxisType === 'linear' ? xMaxForAuto : undefined
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: yAxisLabel
                                    },
                                    min: yMin,
                                    max: yMax
                                }
                            }
                        }
                    });

                    // é‡ç½®åŠ¨ç”»çŠ¶æ€
                    currentFrameIndex = 0;
                    isPlaying = false;
                    playPauseBtn.textContent = 'æ’­æ”¾';

                    // åˆå§‹åŒ–åæ ‡è½´ç¼©æ”¾çŠ¶æ€
                    axisZoomLevel = 1.0;
                    xAxisZoomLevel = 1.0;
                    yAxisZoomLevel = 1.0;
                    axisPanOffset = { x: 0, y: 0 };
                    hasPanned = false;

                    // ä¿å­˜åŸå§‹åæ ‡è½´èŒƒå›´
                    setTimeout(() => {
                        if (chart && chart.scales && chart.scales.x && chart.scales.y) {
                            originalAxisLimits = {
                                xMin: chart.scales.x.min,
                                xMax: chart.scales.x.max,
                                yMin: chart.scales.y.min,
                                yMax: chart.scales.y.max
                            };

                            // ä¿å­˜åŸå§‹åæ ‡è½´æ¯”ä¾‹
                            const chartArea = chart.chartArea;
                            if (chartArea) {
                                originalAxisRatio = chartArea.width / chartArea.height;
                            }
                        }
                    }, 100);


                    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                    if (animationTimer) {
                        clearInterval(animationTimer);
                        animationTimer = null;
                    }

                    // æ›´æ–°å¸§ä¿¡æ¯
                    totalFramesSpan.textContent = frameData.length; // ä¿æŒå‘åå…¼å®¹æ€§
                    updateFrameInfo();
                    setupProgressBar(); // è®¾ç½®è¿›åº¦æ¡èŒƒå›´å’Œå®½åº¦
                    updateProgress();

                    // å¯ç”¨ä¿å­˜è§†é¢‘æŒ‰é’®
                    saveVideoBtn.disabled = false;

                    showToast('åŠ¨ç”»ç”ŸæˆæˆåŠŸ', 'success', { duration: 4000 });

                    // tooltipæ¨¡å¼è®¾ç½®å·²æ›´æ–°ï¼Œéœ€è¦ç‚¹å‡»"ç”ŸæˆåŠ¨ç”»"æŒ‰é’®åº”ç”¨æ›´æ”¹
                } catch (error) {
                    showToast(`ç”ŸæˆåŠ¨ç”»æ—¶å‡ºé”™: ${error.message}`, 'error', { duration: 8000 });
                }
            }

            // åˆ‡æ¢æ’­æ”¾/æš‚åœ
            function togglePlayPause() {
                if (isPlaying) {
                    // æš‚åœ
                    clearInterval(animationTimer);
                    animationTimer = null;
                    isPlaying = false;
                    playPauseBtn.textContent = 'æ’­æ”¾';
                } else {
                    // æ’­æ”¾
                    isPlaying = true;
                    playPauseBtn.textContent = 'æš‚åœ';

                    const frameInterval = parseInt(frameIntervalInput.value);
                    animationTimer = setInterval(() => {
                        currentFrameIndex++;
                        if (currentFrameIndex >= frameData.length) {
                            currentFrameIndex = 0; // å¾ªç¯æ’­æ”¾
                        }
                        updateChart();
                        updateProgress();
                    }, frameInterval);
                }
            }

            // æ›´æ–°åŠ¨ç”»
            function updateChart() {
                if (!chart || allFilesFrameData.length === 0) return;

                // æ›´æ–°æ‰€æœ‰æ–‡ä»¶çš„åŠ¨ç”»æ•°æ®
                for (let fileIndex = 0; fileIndex < allFilesFrameData.length; fileIndex++) {
                    chart.data.datasets[fileIndex].data = allFilesFrameData[fileIndex].frameData[currentFrameIndex];
                }

                // è·å–å½“å‰å¸§å¯¹åº”çš„æ—¶é—´ï¼ˆè€ƒè™‘è·³å¸§è®¾ç½®ï¼‰- ä»ç¬¬ä¸€ä¸ªæ–‡ä»¶è·å–
                const startRow = parseInt(startRowInput.value) - 1;
                const skipFrames = parseInt(skipFramesInput.value) || 0;
                const actualRowIndex = startRow + currentFrameIndex * (skipFrames + 1);
                const currentTime = csvFiles[0].data[actualRowIndex][0];

                // æ›´æ–°åŠ¨ç”»æ ‡é¢˜ï¼ˆåŒ…å«æ—¶é—´ä¿¡æ¯ï¼‰
                chart.options.plugins.title.text = [chartTitleInput.value, `${currentTime}`];

                chart.update();
                updateFrameInfo();
            }

            // æ›´æ–°å¸§ä¿¡æ¯
            function updateFrameInfo() {
                currentFrameSpan.textContent = currentFrameIndex + 1;
            }

            // æ›´æ–°è¿›åº¦æ¡
            function updateProgress() {
                progressBar.value = currentFrameIndex;
            }

            // è®¾ç½®è¿›åº¦æ¡èŒƒå›´
            function setupProgressBar() {
                if (frameData.length > 0) {
                    progressBar.max = frameData.length - 1;
                    progressBar.value = 0;
                }
            }

            // å¸§å¯¼èˆªå‡½æ•°
            function navigateFrame(direction) {
                if (frameData.length === 0) return;

                if (direction === -1 && currentFrameIndex > 0) {
                    currentFrameIndex--;
                    updateChart();
                    updateProgress();
                } else if (direction === 1 && currentFrameIndex < frameData.length - 1) {
                    currentFrameIndex++;
                    updateChart();
                    updateProgress();
                }
            }

            // å¼€å§‹é•¿æŒ‰å¯¼èˆª
            function startFrameNavigation(direction) {
                if (frameNavTimer) return; // å·²ç»åœ¨å¯¼èˆªä¸­

                frameNavDirection = direction;

                // ç«‹å³æ‰§è¡Œä¸€æ¬¡
                navigateFrame(direction);

                // è®¾ç½®å®šæ—¶å™¨ï¼Œå»¶è¿Ÿåå¼€å§‹è¿ç»­å¯¼èˆª
                frameNavTimer = setTimeout(() => {
                    // å¼€å§‹è¿ç»­å¯¼èˆª
                    frameNavTimer = setInterval(() => {
                        navigateFrame(direction);
                    }, frameNavInterval);
                }, longPressDelay);
            }

            // åœæ­¢é•¿æŒ‰å¯¼èˆª
            function stopFrameNavigation() {
                if (frameNavTimer) {
                    clearTimeout(frameNavTimer);
                    clearInterval(frameNavTimer);
                    frameNavTimer = null;
                }
                frameNavDirection = 0;
            }

            // åæ ‡è½´ç¼©æ”¾åŠŸèƒ½å®ç°å‡½æ•°
            function axisZoomIn() {
                const target = axisZoomTarget.value;
                const zoomFactor = 1.2; // æ”¾å¤§20%

                if (target === 'xy') {
                    axisZoomLevel *= zoomFactor;
                    xAxisZoomLevel *= zoomFactor;
                    yAxisZoomLevel *= zoomFactor;
                } else if (target === 'x') {
                    xAxisZoomLevel *= zoomFactor;
                } else if (target === 'y') {
                    yAxisZoomLevel *= zoomFactor;
                }

                // åªé™åˆ¶æœ€å°å€¼ï¼Œä¸é™åˆ¶æœ€å¤§å€¼
                axisZoomLevel = Math.max(axisZoomLevel, 0.01);
                xAxisZoomLevel = Math.max(xAxisZoomLevel, 0.01);
                yAxisZoomLevel = Math.max(yAxisZoomLevel, 0.01);

                updateAxisZoom();
                updateZoomDisplay();
            }

            function axisZoomOut() {
                const target = axisZoomTarget.value;
                const zoomFactor = 1.2; // ç¼©å°20%

                if (target === 'xy') {
                    axisZoomLevel /= zoomFactor;
                    xAxisZoomLevel /= zoomFactor;
                    yAxisZoomLevel /= zoomFactor;
                } else if (target === 'x') {
                    xAxisZoomLevel /= zoomFactor;
                } else if (target === 'y') {
                    yAxisZoomLevel /= zoomFactor;
                }

                // åªé™åˆ¶æœ€å°å€¼ï¼Œä¸é™åˆ¶æœ€å¤§å€¼
                axisZoomLevel = Math.max(axisZoomLevel, 0.01);
                xAxisZoomLevel = Math.max(xAxisZoomLevel, 0.01);
                yAxisZoomLevel = Math.max(yAxisZoomLevel, 0.01);

                updateAxisZoom();
                updateZoomDisplay();
            }

            function resetAxisZoom() {
                axisZoomLevel = 1.0;
                xAxisZoomLevel = 1.0;
                yAxisZoomLevel = 1.0;
                axisPanOffset = { x: 0, y: 0 };
                hasPanned = false;

                updateAxisZoom();
                updateZoomDisplay();
                showToast('åæ ‡è½´å·²é‡ç½®', 'success', { duration: 4000 });
            }

            function updateAxisZoom() {
                if (!chart || !originalAxisLimits) return;

                const xRange = originalAxisLimits.xMax - originalAxisLimits.xMin;
                const yRange = originalAxisLimits.yMax - originalAxisLimits.yMin;
                const target = axisZoomTarget.value;

                // è®¡ç®—ç¼©æ”¾åçš„èŒƒå›´
                let zoomedXRange, zoomedYRange;

                if (target === 'xy') {
                    // XYè½´åŒæ­¥ç¼©æ”¾
                    zoomedXRange = xRange / axisZoomLevel;
                    zoomedYRange = yRange / axisZoomLevel;
                } else if (target === 'x') {
                    // ä»…Xè½´ç¼©æ”¾
                    zoomedXRange = xRange / xAxisZoomLevel;
                    zoomedYRange = yRange; // Yè½´ä¿æŒä¸å˜
                } else if (target === 'y') {
                    // ä»…Yè½´ç¼©æ”¾
                    zoomedXRange = xRange; // Xè½´ä¿æŒä¸å˜
                    zoomedYRange = yRange / yAxisZoomLevel;
                }

                // è®¡ç®—è§†å›¾ä¸­å¿ƒç‚¹ï¼ˆè€ƒè™‘å¹³ç§»ï¼‰
                const centerX = originalAxisLimits.xMin + xRange / 2 + axisPanOffset.x;
                const centerY = originalAxisLimits.yMin + yRange / 2 + axisPanOffset.y;

                // è®¾ç½®æ–°çš„åæ ‡è½´èŒƒå›´
                chart.options.scales.x.min = centerX - zoomedXRange / 2;
                chart.options.scales.x.max = centerX + zoomedXRange / 2;
                chart.options.scales.y.min = centerY - zoomedYRange / 2;
                chart.options.scales.y.max = centerY + zoomedYRange / 2;

                chart.update('none'); // ä¸ä½¿ç”¨åŠ¨ç”»ä»¥æé«˜æ€§èƒ½
            }

            // é¼ æ ‡æ»šè½®åæ ‡è½´ç¼©æ”¾å¤„ç†
            function handleAxisZoomWheel(e) {
                if (!chart || !originalAxisLimits) return;

                e.preventDefault();

                // æ ¹æ®æ»šè½®æ–¹å‘è°ƒæ•´ç¼©æ”¾çº§åˆ«
                const zoomFactor = e.deltaY < 0 ? 1.2 : 0.8;
                const target = axisZoomTarget.value;
                let hasChanged = false;

                if (target === 'xy') {
                    const oldAxisZoomLevel = axisZoomLevel;
                    axisZoomLevel *= zoomFactor;
                    xAxisZoomLevel *= zoomFactor;
                    yAxisZoomLevel *= zoomFactor;
                    axisZoomLevel = Math.max(axisZoomLevel, 0.01);
                    xAxisZoomLevel = Math.max(xAxisZoomLevel, 0.01);
                    yAxisZoomLevel = Math.max(yAxisZoomLevel, 0.01);
                    hasChanged = oldAxisZoomLevel !== axisZoomLevel;
                } else if (target === 'x') {
                    const oldXAxisZoomLevel = xAxisZoomLevel;
                    xAxisZoomLevel *= zoomFactor;
                    xAxisZoomLevel = Math.max(xAxisZoomLevel, 0.01);
                    hasChanged = oldXAxisZoomLevel !== xAxisZoomLevel;
                } else if (target === 'y') {
                    const oldYAxisZoomLevel = yAxisZoomLevel;
                    yAxisZoomLevel *= zoomFactor;
                    yAxisZoomLevel = Math.max(yAxisZoomLevel, 0.01);
                    hasChanged = oldYAxisZoomLevel !== yAxisZoomLevel;
                }

                if (hasChanged) {
                    updateAxisZoom();
                    updateZoomDisplay();
                }
            }

            // åæ ‡è½´å¹³ç§»å¤„ç†å‡½æ•°
            function handleAxisPanStart(e) {
                if (!chart || e.button !== 0) return; // åªå“åº”å·¦é”®

                isPanning = true;
                panStartPos.x = e.clientX;
                panStartPos.y = e.clientY;
                chartContainer.style.cursor = 'grabbing';
                e.preventDefault();
            }

            function handleAxisPanMove(e) {
                if (!isPanning || !chart) return;

                const deltaX = e.clientX - panStartPos.x;
                const deltaY = e.clientY - panStartPos.y;

                // è½¬æ¢åƒç´ åç§»ä¸ºæ•°æ®åç§»
                const xScale = chart.scales.x;
                const yScale = chart.scales.y;

                const dataDeltaX = (deltaX / xScale.width) * (xScale.max - xScale.min);
                const dataDeltaY = (deltaY / yScale.height) * (yScale.max - yScale.min);

                axisPanOffset.x -= dataDeltaX;
                axisPanOffset.y += dataDeltaY; // Yè½´æ–¹å‘ç›¸å

                updateAxisZoom();
                hasPanned = true; // æ ‡è®°å·²ç»å¹³ç§»è¿‡

                panStartPos.x = e.clientX;
                panStartPos.y = e.clientY;
                e.preventDefault();
            }

            function handleAxisPanEnd(e) {
                isPanning = false;
                chartContainer.style.cursor = 'default';
            }

            // å¤„ç†å›¾è¡¨åŒå‡»äº‹ä»¶ï¼Œæ˜¾ç¤ºæ—¶é—´åºåˆ—æµ®çª—
            function handleChartDoubleClick(e) {
                if (!chart) return;

                try {
                    // è·å–é¼ æ ‡åœ¨å›¾è¡¨ä¸Šçš„ä½ç½®
                    const rect = chart.canvas.getBoundingClientRect();
                    const mouseX = e.clientX - rect.left;
                    const mouseY = e.clientY - rect.top;

                    // ä½¿ç”¨Chart.jsçš„æ–¹æ³•è·å–å¯¹åº”çš„æ•°æ®ç‚¹
                    const canvasPosition = Chart.helpers.getRelativePosition(e, chart);
                    const dataX = chart.scales.x.getValueForPixel(canvasPosition.x);
                    const dataY = chart.scales.y.getValueForPixel(canvasPosition.y);

                    // åŸºäºXåæ ‡æ‰¾åˆ°æœ€æ¥è¿‘çš„æ•°æ®ç‚¹
                    const currentFrameData = chart.data.datasets[0].data;
                    if (!currentFrameData || currentFrameData.length === 0) return;

                    let closestPoint = null;
                    let minDistance = Infinity;

                    for (let i = 0; i < currentFrameData.length; i++) {
                        const point = currentFrameData[i];
                        if (point && point.x !== undefined) {
                            const distance = Math.abs(point.x - dataX);
                            if (distance < minDistance) {
                                minDistance = distance;
                                closestPoint = {
                                    x: point.x,
                                    y: point.y,
                                    index: i
                                };
                            }
                        }
                    }

                    if (closestPoint) {
                        // ä¿å­˜ç‚¹å‡»ä¿¡æ¯
                        clickedDataPoint = closestPoint;

                        // æ›´æ–°æµ®çª—æ ‡é¢˜å’Œç‚¹å‡»ä½ç½®ä¿¡æ¯
                        const xAxisType = xAxisTypeSelect.value;
                        const xLabel = xAxisLabelInput.value || 'Xè½´';
                        const yLabel = yAxisLabelInput.value || 'Yè½´';

                        timeSeriesModalTitle.textContent = `${xLabel} = ${closestPoint.x} çš„æ—¶é—´åºåˆ—`;
                        clickedPosition.textContent = `${xLabel}: ${closestPoint.x}, ${yLabel}: ${closestPoint.y.toFixed(2)}`;

                        // æå–æ—¶é—´åºåˆ—æ•°æ®å¹¶æ˜¾ç¤ºæµ®çª—
                        extractTimeSeriesData(closestPoint.x, xAxisType);
                    }

                } catch (error) {
                    console.error('å¤„ç†å›¾è¡¨åŒå‡»æ—¶å‡ºé”™:', error);
                    showToast('æ— æ³•æ˜¾ç¤ºæ—¶é—´åºåˆ—æ•°æ®: ' + error.message, 'error', { duration: 6000 });
                }
            }

            // å…³é—­æ—¶é—´åºåˆ—æµ®çª—
            function closeTimeSeriesModal() {
                timeSeriesModal.style.display = "none";
                timeSeriesStats.style.display = "none";
                if (timeSeriesChart) {
                    timeSeriesChart.destroy();
                    timeSeriesChart = null;
                }
                clickedDataPoint = null;
            }

            // å¤„ç†å›¾è¡¨ç‚¹å‡»äº‹ä»¶ï¼Œæ˜¾ç¤ºæ—¶é—´åºåˆ—æµ®çª—
            function handleChartClick(activeElement, chart) {
                try {
                    const datasetIndex = activeElement.datasetIndex;
                    const index = activeElement.index;
                    const chartData = chart.data.datasets[datasetIndex].data;

                    if (!chartData || chartData.length === 0 || index >= chartData.length) {
                        return;
                    }

                    // è·å–ç‚¹å‡»çš„æ•°æ®ç‚¹ä¿¡æ¯
                    const clickedXValue = chartData[index].x;
                    const clickedYValue = chartData[index].y;

                    // ä¿å­˜ç‚¹å‡»ä¿¡æ¯
                    clickedDataPoint = {
                        x: clickedXValue,
                        y: clickedYValue,
                        index: index
                    };

                    // æ›´æ–°æµ®çª—æ ‡é¢˜å’Œç‚¹å‡»ä½ç½®ä¿¡æ¯
                    const xAxisType = xAxisTypeSelect.value;
                    const xLabel = xAxisLabelInput.value || 'Xè½´';
                    const yLabel = yAxisLabelInput.value || 'Yè½´';

                    timeSeriesModalTitle.textContent = `${xLabel} = ${clickedXValue} çš„æ—¶é—´åºåˆ—`;
                    clickedPosition.textContent = `${xLabel}: ${clickedXValue}, ${yLabel}: ${clickedYValue.toFixed(2)}`;

                    // æå–æ—¶é—´åºåˆ—æ•°æ®å¹¶æ˜¾ç¤ºæµ®çª—
                    extractTimeSeriesData(clickedXValue, xAxisType);

                } catch (error) {
                    console.error('å¤„ç†å›¾è¡¨ç‚¹å‡»æ—¶å‡ºé”™:', error);
                    showToast('æ— æ³•æ˜¾ç¤ºæ—¶é—´åºåˆ—æ•°æ®: ' + error.message, 'error', { duration: 6000 });
                }
            }

            // æå–ç‰¹å®šXä½ç½®çš„æ—¶é—´åºåˆ—æ•°æ®ï¼ˆå¤šæ–‡ä»¶ç‰ˆæœ¬ï¼‰
            function extractTimeSeriesData(targetXValue, xAxisType) {
                try {
                    if (csvFiles.length === 0) {
                        throw new Error('æ²¡æœ‰å¯ç”¨çš„æ•°æ®æ–‡ä»¶');
                    }

                    // è·å–è®¾ç½®å‚æ•°
                    const startRow = parseInt(startRowInput.value) - 1;
                    const skipFrames = parseInt(skipFramesInput.value) || 0;
                    const xAxisRow = parseInt(xAxisRowInput.value) - 1;
                    const startCol = parseInt(startColInput.value) - 1;
                    const endRow = parseInt(endRowInput.value);
                    const endCol = parseInt(endColInput.value);

                    // è®¡ç®—å®é™…èŒƒå›´
                    const firstFile = csvFiles[0].data;
                    const actualEndRow = endRow < 0 ? firstFile.length + endRow : endRow;
                    const actualEndCol = endCol < 0 ? firstFile[0].length + endCol : endCol;

                    // è·å–Xè½´æ•°æ®
                    const xAxisData = firstFile[xAxisRow].slice(startCol, actualEndCol + 1);

                    // æ‰¾åˆ°ç›®æ ‡Xå€¼åœ¨Xè½´æ•°æ®ä¸­çš„ç´¢å¼•
                    let targetIndex = -1;
                    for (let i = 0; i < xAxisData.length; i++) {
                        const xVal = xAxisType === 'linear' ? parseFloat(xAxisData[i]) : xAxisData[i];
                        const targetVal = xAxisType === 'linear' ? parseFloat(targetXValue) : targetXValue;

                        if (Math.abs(xVal - targetVal) < 1e-10 || xVal === targetVal) {
                            targetIndex = i;
                            break;
                        }
                    }

                    if (targetIndex === -1) {
                        throw new Error('æœªæ‰¾åˆ°åŒ¹é…çš„Xè½´ä½ç½®');
                    }

                    // æå–æ‰€æœ‰æ–‡ä»¶çš„æ—¶é—´åºåˆ—æ•°æ®
                    const allFilesTimeSeries = [];
                    const frameLabels = [];
                    // åŠ¨æ€æ•°æ®è‰²ç³»ï¼šä½¿ç”¨é²œæ˜å¯¹æ¯”è‰²ï¼Œçªå‡ºåŠ¨æ€å˜åŒ–
                    const dynamicDataColors = ['#E74C3C', '#F39C12', '#27AE60', '#8E44AD', '#E67E22', '#16A085', '#D35400', '#C0392B'];

                    for (let fileIndex = 0; fileIndex < csvFiles.length; fileIndex++) {
                        const fileInfo = csvFiles[fileIndex];
                        const fileData = fileInfo.data;
                        const timeSeriesData = [];

                        // éå†æ‰€æœ‰å¸§æ•°æ®
                        for (let i = startRow; i <= actualEndRow; i += (skipFrames + 1)) {
                            if (i < fileData.length) {
                                const rowData = fileData[i].slice(startCol, actualEndCol + 1);
                                if (targetIndex < rowData.length && rowData[targetIndex] !== '' && rowData[targetIndex] !== 'NaN' && !isNaN(parseFloat(rowData[targetIndex]))) {
                                    const timeLabel = fileData[i][0] || `æ—¶é—´_${i + 1}`;
                                    const value = parseFloat(rowData[targetIndex]);

                                    timeSeriesData.push({
                                        x: timeLabel,
                                        y: value
                                    });

                                    // åªä¸ºç¬¬ä¸€ä¸ªæ–‡ä»¶æ”¶é›†æ—¶é—´æ ‡ç­¾
                                    if (fileIndex === 0) {
                                        frameLabels.push(timeLabel);
                                    }
                                }
                            }
                        }

                        if (timeSeriesData.length > 0) {
                            allFilesTimeSeries.push({
                                fileName: fileInfo.displayName,
                                data: timeSeriesData,
                                color: dynamicDataColors[fileIndex % dynamicDataColors.length] // ä½¿ç”¨åŠ¨æ€æ•°æ®è‰²ç³»
                            });
                        }
                    }

                    if (allFilesTimeSeries.length === 0) {
                        throw new Error('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æ—¶é—´åºåˆ—æ•°æ®');
                    }

                    // æ˜¾ç¤ºå¤šæ–‡ä»¶æ—¶é—´åºåˆ—æµ®çª—å¹¶ç»˜åˆ¶å¯¹æ¯”å›¾è¡¨
                    showMultiFileTimeSeriesModal(allFilesTimeSeries, frameLabels, targetXValue);

                } catch (error) {
                    console.error('æå–æ—¶é—´åºåˆ—æ•°æ®æ—¶å‡ºé”™:', error);
                    showToast('æå–æ—¶é—´åºåˆ—æ•°æ®å¤±è´¥: ' + error.message, 'error', { duration: 8000 });
                }
            }

            // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
            function calculateStatistics(data) {
                if (!data || data.length === 0) {
                    return null;
                }

                const values = data.map(point => point.y).filter(y => y !== null && y !== undefined && !isNaN(y));
                if (values.length === 0) {
                    return null;
                }

                // ä½¿ç”¨å¾ªç¯ä»£æ›¿æ‰©å±•è¿ç®—ç¬¦,é¿å…Windowsä¸‹å‚æ•°æ•°é‡é™åˆ¶å¼‚å¸¸
                let max = values[0];
                let min = values[0];
                for (let i = 1; i < values.length; i++) {
                    if (values[i] > max) max = values[i];
                    if (values[i] < min) min = values[i];
                }
                const mean = values.reduce((sum, val) => sum + val, 0) / values.length;

                // è®¡ç®—æ ‡å‡†å·®
                const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
                const stdDev = Math.sqrt(variance);

                return {
                    max: max,
                    min: min,
                    mean: mean,
                    stdDev: stdDev,
                    count: values.length,
                    range: max - min
                };
            }

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤º
            function updateStatisticsDisplay(stats) {
                if (!stats) {
                    timeSeriesStats.style.display = 'none';
                    return;
                }

                statsMax.textContent = stats.max.toFixed(3);
                statsMin.textContent = stats.min.toFixed(3);
                statsAvg.textContent = stats.mean.toFixed(3);
                statsStd.textContent = stats.stdDev.toFixed(3);
                statsCount.textContent = stats.count;
                statsRange.textContent = stats.range.toFixed(3);

                timeSeriesStats.style.display = 'block';
            }

            // æ›´æ–°å¤šæ–‡ä»¶ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤ºï¼ˆè¡¨æ ¼å½¢å¼ï¼‰
            function updateMultiFileStatisticsDisplay(allStats, targetXValue) {
                if (!allStats || allStats.length === 0) {
                    timeSeriesStats.style.display = 'none';
                    return;
                }

                // åˆ›å»ºè¡¨æ ¼HTML
                const fileCount = allStats.length;
                let tableHTML = `
                    <div style="margin-bottom: 15px;">
                        <strong>Xè½´ä½ç½®: ${targetXValue}</strong> - å¤šæ–‡ä»¶ç»Ÿè®¡å¯¹æ¯” (${fileCount} ä¸ªæ–‡ä»¶)
                    </div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="background-color: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <th style="padding: 8px; text-align: left; border: 1px solid #dee2e6;">æ–‡ä»¶</th>
                                <th style="padding: 8px; text-align: right; border: 1px solid #dee2e6;">æœ€å¤§å€¼</th>
                                <th style="padding: 8px; text-align: right; border: 1px solid #dee2e6;">æœ€å°å€¼</th>
                                <th style="padding: 8px; text-align: right; border: 1px solid #dee2e6;">å¹³å‡å€¼</th>
                                <th style="padding: 8px; text-align: right; border: 1px solid #dee2e6;">æ ‡å‡†å·®</th>
                                <th style="padding: 8px; text-align: right; border: 1px solid #dee2e6;">æ•°æ®ç‚¹æ•°</th>
                                <th style="padding: 8px; text-align: right; border: 1px solid #dee2e6;">æå·®</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                // æ·»åŠ æ¯ä¸ªæ–‡ä»¶çš„ç»Ÿè®¡ä¿¡æ¯è¡Œ
                for (const fileStat of allStats) {
                    const stats = fileStat.stats;
                    if (stats) {
                        tableHTML += `
                            <tr>
                                <td style="padding: 6px 8px; border: 1px solid #dee2e6;">
                                    <span style="display: inline-block; width: 12px; height: 12px; background-color: ${fileStat.color}; border-radius: 50%; margin-right: 6px;"></span>
                                    ${fileStat.fileName}
                                </td>
                                <td style="padding: 6px 8px; text-align: right; border: 1px solid #dee2e6;">${stats.max.toFixed(3)}</td>
                                <td style="padding: 6px 8px; text-align: right; border: 1px solid #dee2e6;">${stats.min.toFixed(3)}</td>
                                <td style="padding: 6px 8px; text-align: right; border: 1px solid #dee2e6;">${stats.mean.toFixed(3)}</td>
                                <td style="padding: 6px 8px; text-align: right; border: 1px solid #dee2e6;">${stats.stdDev.toFixed(3)}</td>
                                <td style="padding: 6px 8px; text-align: right; border: 1px solid #dee2e6;">${stats.count}</td>
                                <td style="padding: 6px 8px; text-align: right; border: 1px solid #dee2e6;">${stats.range.toFixed(3)}</td>
                            </tr>
                        `;
                    }
                }

                // å¦‚æœæœ‰å¤šä¸ªæ–‡ä»¶ï¼Œæ·»åŠ æ±‡æ€»è¡Œ
                if (allStats.length > 1) {
                    const validStats = allStats.filter(fs => fs.stats).map(fs => fs.stats);
                    if (validStats.length > 0) {
                        const avgMax = validStats.reduce((sum, s) => sum + s.max, 0) / validStats.length;
                        const avgMin = validStats.reduce((sum, s) => sum + s.min, 0) / validStats.length;
                        const avgMean = validStats.reduce((sum, s) => sum + s.mean, 0) / validStats.length;
                        const avgStd = validStats.reduce((sum, s) => sum + s.stdDev, 0) / validStats.length;
                        const totalCount = validStats.reduce((sum, s) => sum + s.count, 0);
                        const avgRange = validStats.reduce((sum, s) => sum + s.range, 0) / validStats.length;

                        tableHTML += `
                            <tr style="background-color: #f8f9fa; font-weight: bold; border-top: 2px solid #dee2e6;">
                                <td style="padding: 8px; border: 1px solid #dee2e6;">å¹³å‡å€¼</td>
                                <td style="padding: 8px; text-align: right; border: 1px solid #dee2e6;">${avgMax.toFixed(3)}</td>
                                <td style="padding: 8px; text-align: right; border: 1px solid #dee2e6;">${avgMin.toFixed(3)}</td>
                                <td style="padding: 8px; text-align: right; border: 1px solid #dee2e6;">${avgMean.toFixed(3)}</td>
                                <td style="padding: 8px; text-align: right; border: 1px solid #dee2e6;">${avgStd.toFixed(3)}</td>
                                <td style="padding: 8px; text-align: right; border: 1px solid #dee2e6;">${totalCount}</td>
                                <td style="padding: 8px; text-align: right; border: 1px solid #dee2e6;">${avgRange.toFixed(3)}</td>
                            </tr>
                        `;
                    }
                }

                tableHTML += `
                        </tbody>
                    </table>
                `;

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ
                timeSeriesStats.innerHTML = tableHTML;
                timeSeriesStats.style.display = 'block';
            }

            // æ˜¾ç¤ºå¤šæ–‡ä»¶æ—¶é—´åºåˆ—æµ®çª—å¹¶ç»˜åˆ¶å¯¹æ¯”å›¾è¡¨
            function showMultiFileTimeSeriesModal(allFilesTimeSeries, frameLabels, targetXValue) {
                try {
                    // æ›´æ–°æ¨¡æ€æ¡†æ ‡é¢˜ä»¥åæ˜ å¤šæ–‡ä»¶å¯¹æ¯”
                    const xLabel = xAxisLabelInput.value || 'Xè½´';
                    timeSeriesModalTitle.textContent = `${xLabel} = ${targetXValue} çš„å¤šæ–‡ä»¶æ—¶é—´åºåˆ—å¯¹æ¯”`;

                    // æ˜¾ç¤ºæµ®çª—
                    timeSeriesModal.style.display = "block";

                    // è®¡ç®—å¹¶æ˜¾ç¤ºå¤šæ–‡ä»¶ç»Ÿè®¡ä¿¡æ¯
                    const allStats = [];
                    for (const fileSeries of allFilesTimeSeries) {
                        const stats = calculateStatistics(fileSeries.data);
                        allStats.push({
                            fileName: fileSeries.fileName,
                            color: fileSeries.color,
                            stats: stats
                        });
                    }
                    updateMultiFileStatisticsDisplay(allStats, targetXValue);

                    // å¦‚æœå·²æœ‰å›¾è¡¨å®ä¾‹ï¼Œå…ˆé”€æ¯
                    if (timeSeriesChart) {
                        timeSeriesChart.destroy();
                    }

                    // å‡†å¤‡å¤šæ–‡ä»¶å¯¹æ¯”å›¾è¡¨æ•°æ®
                    const datasets = allFilesTimeSeries.map(fileSeries => ({
                        label: fileSeries.fileName,
                        data: fileSeries.data,
                        borderColor: fileSeries.color,
                        backgroundColor: fileSeries.color + '20',
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        tension: 0.1,
                        fill: false
                    }));

                    // åˆ›å»ºå¤šæ–‡ä»¶æ—¶é—´åºåˆ—å¯¹æ¯”å›¾è¡¨
                    const ctx = timeSeriesChartContainer.getContext('2d');
                    timeSeriesChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 500
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                title: {
                                    display: false
                                },
                                legend: {
                                    display: true,
                                    position: 'top',
                                    labels: {
                                        usePointStyle: true,
                                        padding: 15
                                    }
                                },
                                tooltip: {
                                    enabled: function(context) {
                                        return tooltipModeSelect.value !== 'off';
                                    },
                                    callbacks: {
                                        title: function(context) {
                                            const xAxisLabel = xAxisLabelInput.value || 'æ—¶é—´';
                                            return `${xAxisLabel}: ${context[0].label}`;
                                        },
                                        label: function(context) {
                                            const tooltipMode = tooltipModeSelect.value;
                                            if (tooltipMode === 'compact') {
                                                // ç¼©ç•¥æ˜¾ç¤ºï¼šåªæ˜¾ç¤ºæ•°æ®å€¼
                                                return `${context.parsed.y.toFixed(4)}`;
                                            } else if (tooltipMode === 'full') {
                                                // å®Œæ•´æ˜¾ç¤ºï¼šæ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯å’Œæ•°æ®å€¼
                                                return `${context.dataset.label}: ${context.parsed.y.toFixed(4)}`;
                                            } else {
                                                // å…³é—­æ˜¾ç¤ºï¼šè¿”å›ç©ºå­—ç¬¦ä¸²
                                                return '';
                                            }
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    type: 'category',
                                    title: {
                                        display: true,
                                        text: 'æ—¶é—´'
                                    },
                                    grid: {
                                        display: true,
                                        color: 'rgba(0,0,0,0.1)'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'æ•°å€¼'
                                    },
                                    grid: {
                                        display: true,
                                        color: 'rgba(0,0,0,0.1)'
                                    }
                                }
                            }
                        }
                    });

                } catch (error) {
                    console.error('æ˜¾ç¤ºå¤šæ–‡ä»¶æ—¶é—´åºåˆ—å›¾è¡¨æ—¶å‡ºé”™:', error);
                    showToast('æ˜¾ç¤ºæ—¶é—´åºåˆ—å›¾è¡¨å¤±è´¥: ' + error.message, 'error', { duration: 8000 });
                }
            }

            // æ˜¾ç¤ºæ—¶é—´åºåˆ—æµ®çª—å¹¶ç»˜åˆ¶å›¾è¡¨ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
            function showTimeSeriesModal(timeSeriesData, frameLabels, targetXValue) {
                try {
                    // æ˜¾ç¤ºæµ®çª—
                    timeSeriesModal.style.display = "block";

                    // è®¡ç®—å¹¶æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                    const stats = calculateStatistics(timeSeriesData);
                    updateStatisticsDisplay(stats);

                    // å¦‚æœå·²æœ‰å›¾è¡¨å®ä¾‹ï¼Œå…ˆé”€æ¯
                    if (timeSeriesChart) {
                        timeSeriesChart.destroy();
                    }

                    // å‡†å¤‡å›¾è¡¨æ•°æ®
                    const datasets = [{
                        label: `${targetXValue} æ—¶é—´åºåˆ—`,
                        data: timeSeriesData,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        tension: 0.1,
                        fill: true
                    }];

                    // åˆ›å»ºæ—¶é—´åºåˆ—å›¾è¡¨
                    const ctx = timeSeriesChartContainer.getContext('2d');
                    timeSeriesChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            datasets: datasets
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 300
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                title: {
                                    display: false
                                },
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                tooltip: {
                                    enabled: function(context) {
                                        return tooltipModeSelect.value !== 'off';
                                    },
                                    callbacks: {
                                        title: function(context) {
                                            const xAxisLabel = xAxisLabelInput.value || 'æ—¶é—´';
                                            return `${xAxisLabel}: ${context[0].label}`;
                                        },
                                        label: function(context) {
                                            const tooltipMode = tooltipModeSelect.value;
                                            if (tooltipMode === 'compact') {
                                                // ç¼©ç•¥æ˜¾ç¤ºï¼šåªæ˜¾ç¤ºæ•°æ®å€¼
                                                return `${context.parsed.y.toFixed(4)}`;
                                            } else if (tooltipMode === 'full') {
                                                // å®Œæ•´æ˜¾ç¤ºï¼šæ˜¾ç¤ºæ•°æ®å€¼ï¼ˆè¿™é‡Œæ˜¯å•æ–‡ä»¶ï¼Œä¸éœ€è¦æ–‡ä»¶åï¼‰
                                                return `æ•°å€¼: ${context.parsed.y.toFixed(4)}`;
                                            } else {
                                                // å…³é—­æ˜¾ç¤ºï¼šè¿”å›ç©ºå­—ç¬¦ä¸²
                                                return '';
                                            }
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'æ—¶é—´'
                                    },
                                    ticks: {
                                        maxTicksLimit: 20,
                                        autoSkip: true,
                                        maxRotation: 45
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: yAxisLabelInput.value || 'æ•°å€¼'
                                    }
                                }
                            }
                        }
                    });

                } catch (error) {
                    console.error('æ˜¾ç¤ºæ—¶é—´åºåˆ—æµ®çª—æ—¶å‡ºé”™:', error);
                    showToast('æ˜¾ç¤ºæ—¶é—´åºåˆ—å›¾è¡¨å¤±è´¥: ' + error.message, 'error', { duration: 6000 });
                }
            }

            // ä¿å­˜è§†é¢‘åŠŸèƒ½
            async function saveVideo() {
                if (isRecording || !chart || frameData.length === 0) {
                    return;
                }

                try {
                    isRecording = true;
                    saveVideoBtn.disabled = true;
                    saveVideoBtn.textContent = 'å½•åˆ¶ä¸­...';

                    // åˆ›å»ºå–æ¶ˆå½•åˆ¶çš„æ§åˆ¶å™¨
                    recordingAbortController = new AbortController();

                    // ç»Ÿä¸€çš„å–æ¶ˆå½•åˆ¶å¤„ç†å‡½æ•°
                    const handleCancelRecording = () => {
                        if (recordingAbortController) {
                            recordingAbortController.abort();
                            // æ¢å¤æŒ‰é’®çŠ¶æ€
                            isRecording = false;
                            saveVideoBtn.disabled = false;
                            saveVideoBtn.textContent = 'ä¿å­˜è§†é¢‘';
                            recordingAbortController = null;
                            if (recordingToast) {
                                removeToast(recordingToast);
                                recordingToast = null;
                            }
                            showToast('å½•åˆ¶å·²å–æ¶ˆ', 'warning', { duration: 4000 });
                        }
                    };

                    // æ˜¾ç¤ºå½•åˆ¶è¿›åº¦Toastï¼ˆå¸¦å–æ¶ˆæŒ‰é’®ï¼‰
                    recordingToast = showToast('å‡†å¤‡å½•åˆ¶...', 'info', {
                        persistent: true,
                        showCancel: true,
                        cancelText: 'å–æ¶ˆå½•åˆ¶',
                        onCancel: handleCancelRecording
                    });

                    // è·å–canvaså…ƒç´ 
                    const canvas = chartContainer.querySelector('canvas');
                    if (!canvas) {
                        throw new Error('æœªæ‰¾åˆ°å›¾è¡¨ç”»å¸ƒ');
                    }

                    // è§£æè§†é¢‘è´¨é‡è®¾ç½®
                    const videoQuality = videoQualitySelect.value;

                    // æ ¹æ®è´¨é‡è®¾ç½®è®¡ç®—ç›®æ ‡åˆ†è¾¨ç‡å’Œç ç‡
                    let targetWidth, targetHeight, videoBitrate, videoFPS;
                    switch (videoQuality) {
                        case 'extreme':
                            // æè‡´è´¨é‡ - 4K
                            targetWidth = 3840;
                            targetHeight = 2160;
                            videoBitrate = 15000000; // 15 Mbps
                            videoFPS = 30;
                            // 4K è€—æ—¶æç¤º
                            if (frameData.length > 50) {
                                showToast('4Kæ¸²æŸ“è€—æ—¶å¯èƒ½è¾ƒé•¿ï¼Œè¯·è€å¿ƒç­‰å¾…', 'warning', { duration: 5000 });
                            }
                            break;
                        case 'ultra':
                            // è¶…é«˜è´¨é‡ - 2K
                            targetWidth = 2560;
                            targetHeight = 1440;
                            videoBitrate = 8000000; // 8 Mbps
                            videoFPS = 30;
                            break;
                        case 'high':
                            // é«˜è´¨é‡ - 1080p
                            targetWidth = 1920;
                            targetHeight = 1080;
                            videoBitrate = 5000000; // 5 Mbps
                            videoFPS = 30;
                            break;
                        case 'medium':
                        default:
                            // ä¸­ç­‰è´¨é‡ - 720p
                            targetWidth = 1280;
                            targetHeight = 720;
                            videoBitrate = 2500000; // 2.5 Mbps
                            videoFPS = 30;
                            break;
                        case 'low':
                            // ä½è´¨é‡ - 480p
                            targetWidth = 854;
                            targetHeight = 480;
                            videoBitrate = 1000000; // 1 Mbps
                            videoFPS = 24;
                            break;
                    }

                    // è®¡ç®—å­—å·ç¼©æ”¾æ¯”ä¾‹ï¼ˆåŸºäº1080pä¸ºåŸºå‡†ï¼‰
                    const baseResolution = 1920; // 1080på®½åº¦
                    const scaleFactor = targetWidth / baseResolution;

                    // è®¡ç®—å„å…ƒç´ å­—å·ï¼Œè®¾ç½®æœ€å°å­—å·é™åˆ¶
                    const titleFontSize = Math.max(Math.round(16 * scaleFactor), 12);
                    const axisTitleFontSize = Math.max(Math.round(14 * scaleFactor), 10);
                    const axisTickFontSize = Math.max(Math.round(12 * scaleFactor), 8);
                    const legendFontSize = Math.max(Math.round(12 * scaleFactor), 8);

                    // åå°å½•åˆ¶ - åˆ›å»ºç¦»å±canvasï¼ˆä½¿ç”¨é«˜è´¨é‡åˆ†è¾¨ç‡ï¼‰
                    const offscreenCanvas = document.createElement('canvas');
                    const canvasRect = canvas.getBoundingClientRect();
                    const devicePixelRatio = window.devicePixelRatio || 1;

                    // è®¾ç½®é«˜åˆ†è¾¨ç‡è¾“å‡º
                    offscreenCanvas.width = targetWidth;
                    offscreenCanvas.height = targetHeight;

                    // è®¡ç®—è§†é¢‘å¸§ç‡ï¼ˆä½¿ç”¨è®¾ç½®çš„å¸§ç‡è€Œä¸æ˜¯åŸºäºå¸§é—´éš”ï¼‰
                    const frameInterval = parseInt(frameIntervalInput.value);

                    // åˆ›å»ºè§†é¢‘å½•åˆ¶å™¨ï¼ˆä½¿ç”¨VP9ç¼–ç å™¨å¹¶è®¾ç½®ç ç‡ï¼‰
                    const stream = offscreenCanvas.captureStream(videoFPS);

                    // è®¾ç½®è§†é¢‘è½¨é“çš„ç ç‡
                    const videoTracks = stream.getVideoTracks();
                    if (videoTracks.length > 0) {
                        videoTracks[0].applyConstraints({
                            width: { ideal: targetWidth },
                            height: { ideal: targetHeight },
                            frameRate: { ideal: videoFPS },
                            bitrate: videoBitrate
                        });
                    }

                    // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒçš„æ ¼å¼
                    let mimeType = 'video/webm;codecs=vp9';
                    if (!MediaRecorder.isTypeSupported(mimeType)) {
                        mimeType = 'video/webm;codecs=vp8';
                        if (!MediaRecorder.isTypeSupported(mimeType)) {
                            mimeType = 'video/webm';
                        }
                    }

                    const mediaRecorder = new MediaRecorder(stream, {
                        mimeType: mimeType,
                        videoBitsPerSecond: videoBitrate
                    });

                    const chunks = [];

                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            chunks.push(event.data);
                            console.log(`æ”¶åˆ°æ•°æ®å— ${chunks.length}, å¤§å°: ${event.data.size}`);
                        }
                    };

                    // æ·»åŠ é”™è¯¯å¤„ç†
                    mediaRecorder.onerror = (event) => {
                        console.error('MediaRecorderé”™è¯¯:', event.error);
                        throw new Error('å½•åˆ¶é”™è¯¯: ' + event.error.message);
                    };

                    mediaRecorder.onstop = async () => {
                        console.log(`MediaRecorderåœæ­¢ï¼Œæ€»å…±æ”¶åˆ° ${chunks.length} ä¸ªæ•°æ®å—`);
                        try {
                            if (recordingAbortController?.signal.aborted) {
                                // å½•åˆ¶è¢«å–æ¶ˆ
                                isRecording = false;
                                saveVideoBtn.disabled = false;
                                saveVideoBtn.textContent = 'ä¿å­˜è§†é¢‘';
                                recordingAbortController = null;
                                recordingToast = null;
                                showToast('å½•åˆ¶å·²å–æ¶ˆ', 'warning', { duration: 4000 });
                                return;
                            }

                            updateToast(recordingToast, 'æ­£åœ¨ç”Ÿæˆè§†é¢‘æ–‡ä»¶...');

                            // åˆ›å»ºè§†é¢‘blob
                            if (chunks.length === 0) {
                                throw new Error('æ²¡æœ‰å½•åˆ¶åˆ°è§†é¢‘æ•°æ®');
                            }

                            const blob = new Blob(chunks, { type: mimeType });
                            console.log(`è§†é¢‘blobåˆ›å»ºæˆåŠŸï¼Œå¤§å°: ${blob.size} å­—èŠ‚ï¼Œç±»å‹: ${blob.type}`);

                            // æ£€æŸ¥blobå¤§å°
                            if (blob.size === 0) {
                                throw new Error('ç”Ÿæˆçš„è§†é¢‘æ–‡ä»¶ä¸ºç©º');
                            }

                            updateToast(recordingToast, 'æ­£åœ¨å‡†å¤‡ä¸‹è½½...');

                            // åˆ›å»ºä¸‹è½½é“¾æ¥
                            const url = URL.createObjectURL(blob);

                            const a = document.createElement('a');
                            a.href = url;

                            // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
                            const generateUniqueFileName = (baseName) => {
                                let fileName = baseName + '.webm';
                                let counter = 1;

                                // å¦‚æœåŸºç¡€æ–‡ä»¶åå·²ç»åŒ…å«åºå·æ ¼å¼ï¼Œå…ˆç§»é™¤åºå·éƒ¨åˆ†
                                let cleanBaseName = baseName;
                                const suffixMatch = baseName.match(/^(.*?)\s*\(\d+\)$/);
                                if (suffixMatch) {
                                    cleanBaseName = suffixMatch[1].trim();
                                }

                                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåæ–‡ä»¶
                                while (localStorage.getItem('video_file_' + fileName)) {
                                    // ä½¿ç”¨æ¸…ç†åçš„åŸºç¡€åç§°æ·»åŠ åºå·
                                    fileName = cleanBaseName + ' (' + counter + ').webm';
                                    counter++;
                                }

                                // æ ‡è®°æ­¤æ–‡ä»¶åå·²è¢«ä½¿ç”¨
                                localStorage.setItem('video_file_' + fileName, Date.now().toString());

                                // æ¸…ç†æ—§çš„æ–‡ä»¶åè®°å½•ï¼ˆä¿æŒæœ€è¿‘100ä¸ªï¼‰
                                const keys = Object.keys(localStorage).filter(key => key.startsWith('video_file_'));
                                if (keys.length > 100) {
                                    keys.slice(0, keys.length - 100).forEach(key => localStorage.removeItem(key));
                                }

                                return fileName;
                            };

                            const baseFileName = (chartTitleInput.value || 'æ•°æ®åŠ¨ç”»')
                                .replace(/[\\/:"*?<>|]/g, '')  // ç§»é™¤æ–‡ä»¶åä¸­çš„éæ³•å­—ç¬¦
                                .replace(/\s+/g, '_')         // å°†ç©ºæ ¼æ›¿æ¢ä¸ºä¸‹åˆ’çº¿
                                .trim();

                            const uniqueFileName = generateUniqueFileName(baseFileName);
                            a.download = uniqueFileName;

                            // è§¦å‘ä¸‹è½½ï¼ˆæ·»åŠ è¶…æ—¶ä¿æŠ¤ï¼‰
                            try {
                                await Promise.race([
                                    new Promise(resolve => {
                                        document.body.appendChild(a);
                                        a.click();
                                        document.body.removeChild(a);
                                        setTimeout(resolve, 100);
                                    }),
                                    new Promise((_, reject) =>
                                        setTimeout(() => reject(new Error('ä¸‹è½½è§¦å‘è¶…æ—¶')), 10000)
                                    )
                                ]);
                            } catch (error) {
                                // æ¸…ç†DOM
                                if (a.parentNode) {
                                    document.body.removeChild(a);
                                }
                                throw new Error('è§¦å‘ä¸‹è½½å¤±è´¥: ' + error.message);
                            }

                            // æ¸…ç†URLå¯¹è±¡
                            setTimeout(() => {
                                try {
                                    URL.revokeObjectURL(url);
                                } catch (e) {
                                    console.warn('æ¸…ç†URLå¤±è´¥:', e);
                                }
                            }, 1000);

                            // æ¢å¤æŒ‰é’®çŠ¶æ€
                            isRecording = false;
                            saveVideoBtn.disabled = false;
                            saveVideoBtn.textContent = 'ä¿å­˜è§†é¢‘';
                            recordingAbortController = null;

                            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                            removeToast(recordingToast);
                            recordingToast = null;
                            showToast('è§†é¢‘ä¿å­˜æˆåŠŸï¼æ–‡ä»¶å·²ä¸‹è½½åˆ°æ‚¨çš„ä¸‹è½½æ–‡ä»¶å¤¹', 'success', { duration: 5000 });

                        } catch (error) {
                            console.error('ä¿å­˜è§†é¢‘æ—¶å‡ºé”™:', error);
                            isRecording = false;
                            saveVideoBtn.disabled = false;
                            saveVideoBtn.textContent = 'ä¿å­˜è§†é¢‘';
                            recordingAbortController = null;

                            if (recordingToast) {
                                removeToast(recordingToast);
                                recordingToast = null;
                            }
                            showToast('ä¿å­˜è§†é¢‘å¤±è´¥: ' + error.message, 'error', { duration: 8000 });
                        }
                    };

                    // å¼€å§‹å½•åˆ¶
                    mediaRecorder.start(100); // æ¯100msæ”¶é›†ä¸€æ¬¡æ•°æ®
                    console.log('MediaRecorderå·²å¯åŠ¨ï¼ŒçŠ¶æ€:', mediaRecorder.state);

                    // å‡†å¤‡å½•åˆ¶å‚æ•°
                    const totalRecordFrames = frameData.length;
                    const startRow = parseInt(startRowInput.value) - 1;

                    // æ¸²æŸ“æ‰€æœ‰å¸§ï¼ˆå¹¶è¡Œæˆ–ä¸²è¡Œï¼‰
                    updateToast(recordingToast, `å‡†å¤‡æ¸²æŸ“ ${targetWidth}x${targetHeight} é«˜åˆ†è¾¨ç‡å¸§æ•°æ®...`);

                    let renderedFrames;
                    try {
                        // å°è¯•å¹¶è¡Œæ¸²æŸ“
                        console.log('=== å¼€å§‹å¹¶è¡Œæ¸²æŸ“æµ‹è¯• ===');
                        console.log('æ€»å¸§æ•°:', totalRecordFrames);
                        console.log('ç›®æ ‡åˆ†è¾¨ç‡:', targetWidth + 'x' + targetHeight);
                        console.log('å­—å·è®¾ç½®:', { titleFontSize, axisTitleFontSize, axisTickFontSize, legendFontSize });

                        // è·å–æ‰€æœ‰DOMå…ƒç´ çš„å€¼ï¼Œé¿å…åœ¨å¹¶è¡Œæ‰§è¡Œä¸­è®¿é—®DOM
                        const chartTitle = chartTitleInput.value;
                        const showLegend = showLegendSelect.value === 'true';
                        const xAxisType = xAxisTypeSelect.value;
                        const xAxisLabel = xAxisLabelInput.value;
                        const yAxisLabel = yAxisLabelInput.value;
                        const xMin = xMinInput.value === 'auto' ? 'auto' : parseFloat(xMinInput.value);
                        const xMax = xMaxInput.value === 'auto' ? 'auto' : parseFloat(xMaxInput.value);
                        const yMin = yMinInput.value === 'auto' ? 'auto' : parseFloat(yMinInput.value);
                        const yMax = yMaxInput.value === 'auto' ? 'auto' : parseFloat(yMaxInput.value);
                        const skipFrames = parseInt(skipFramesInput.value) || 0;

                        // å…ˆæµ‹è¯•å•ä¸ªå¸§æ¸²æŸ“
                        console.log('æµ‹è¯•å•ä¸ªå¸§æ¸²æŸ“...');
                        const testFrame = await renderSingleFrame(targetWidth, targetHeight, 0, startRow, {
                            titleFontSize,
                            axisTitleFontSize,
                            axisTickFontSize,
                            legendFontSize
                        }, {
                            chartTitle,
                            showLegend,
                            xAxisType,
                            xAxisLabel,
                            yAxisLabel,
                            xMin,
                            xMax,
                            yMin,
                            yMax,
                            skipFrames
                        });
                        console.log('å•ä¸ªå¸§æµ‹è¯•æˆåŠŸï¼Œcanvaså¤§å°:', testFrame.width + 'x' + testFrame.height);

                        console.log('å¼€å§‹çœŸæ­£çš„å¹¶è¡Œæ¸²æŸ“...');
                        renderedFrames = await renderAllFramesParallel(
                            targetWidth,
                            targetHeight,
                            totalRecordFrames,
                            startRow,
                            recordingAbortController,
                        (progress) => {
                            // æ›´æ–°æ¸²æŸ“è¿›åº¦
                            updateToast(recordingToast, `æ­£åœ¨æ¸²æŸ“å¸§æ•°æ®... ${progress}%`, {
                                showCancel: true,
                                cancelText: 'å–æ¶ˆå½•åˆ¶',
                                onCancel: handleCancelRecording
                            });
                        }, {
                            titleFontSize,
                            axisTitleFontSize,
                            axisTickFontSize,
                            legendFontSize
                        }, {
                            chartTitle,
                            showLegend,
                            xAxisType,
                            xAxisLabel,
                            yAxisLabel,
                            xMin,
                            xMax,
                            yMin,
                            yMax,
                            skipFrames
                        }
                    );
                    } catch (error) {
                        console.error('å¹¶è¡Œæ¸²æŸ“å¤±è´¥ï¼Œè¯¦ç»†é”™è¯¯ä¿¡æ¯:', {
                            message: error.message,
                            stack: error.stack,
                            name: error.name
                        });
                        updateToast(recordingToast, 'å¹¶è¡Œæ¸²æŸ“å¤±è´¥ï¼Œåˆ‡æ¢åˆ°ä¸²è¡Œæ¸²æŸ“æ¨¡å¼...');

                        // ä¸²è¡Œæ¸²æŸ“ï¼ˆæ›´ç¨³å®šä½†è¾ƒæ…¢ï¼‰
                        renderedFrames = [];
                        for (let frameIndex = 0; frameIndex < totalRecordFrames; frameIndex++) {
                            if (recordingAbortController?.signal.aborted) {
                                throw new Error('å½•åˆ¶å·²å–æ¶ˆ');
                            }

                            const progress = Math.round((frameIndex / totalRecordFrames) * 100);
                            updateToast(recordingToast, `æ­£åœ¨æ¸²æŸ“å¸§æ•°æ®(ä¸²è¡Œ)... ${progress}%`, {
                                showCancel: true,
                                cancelText: 'å–æ¶ˆå½•åˆ¶',
                                onCancel: handleCancelRecording
                            });

                            renderedFrames.push(await renderSingleFrame(targetWidth, targetHeight, frameIndex, startRow, {
                                titleFontSize,
                                axisTitleFontSize,
                                axisTickFontSize,
                                legendFontSize
                            }, {
                                chartTitle: chartTitleInput.value,
                                showLegend: showLegendSelect.value === 'true',
                                xAxisType: xAxisTypeSelect.value,
                                xAxisLabel: xAxisLabelInput.value,
                                yAxisLabel: yAxisLabelInput.value,
                                xMin: xMinInput.value === 'auto' ? 'auto' : parseFloat(xMinInput.value),
                                xMax: xMaxInput.value === 'auto' ? 'auto' : parseFloat(xMaxInput.value),
                                yMin: yMinInput.value === 'auto' ? 'auto' : parseFloat(yMinInput.value),
                                yMax: yMaxInput.value === 'auto' ? 'auto' : parseFloat(yMaxInput.value),
                                skipFrames: parseInt(skipFramesInput.value) || 0
                            }));
                        }
                    }

                    // æ£€æŸ¥æ˜¯å¦è¢«å–æ¶ˆ
                    if (recordingAbortController.signal.aborted) {
                        mediaRecorder.stop();
                        return;
                    }

                    updateToast(recordingToast, 'å¼€å§‹å½•åˆ¶è§†é¢‘...');

                    // å¼€å§‹å½•åˆ¶å¹¶é€å¸§è¾“å‡ºåˆ°ç¦»å±canvas
                    const recordAllFrames = async () => {
                        for (let frameIndex = 0; frameIndex < totalRecordFrames; frameIndex++) {
                            // æ£€æŸ¥æ˜¯å¦è¢«å–æ¶ˆ
                            if (recordingAbortController.signal.aborted) {
                                mediaRecorder.stop();
                                return;
                            }

                            // æ›´æ–°è¿›åº¦
                            const progress = Math.round((frameIndex / totalRecordFrames) * 100);
                            updateToast(recordingToast, `æ­£åœ¨å½•åˆ¶è§†é¢‘... ${frameIndex + 1}/${totalRecordFrames} (${progress}%)`, {
                                showCancel: true,
                                cancelText: 'å–æ¶ˆå½•åˆ¶',
                                onCancel: handleCancelRecording
                            });

                            // å°†é¢„æ¸²æŸ“çš„å¸§ç»˜åˆ¶åˆ°ç¦»å±canvasï¼ˆè®¾ç½®ç™½è‰²èƒŒæ™¯ï¼‰
                            const offscreenCtx = offscreenCanvas.getContext('2d');
                            offscreenCtx.fillStyle = 'white';
                            offscreenCtx.fillRect(0, 0, offscreenCanvas.width, offscreenCanvas.height);
                            offscreenCtx.drawImage(renderedFrames[frameIndex], 0, 0);

                            // ç­‰å¾…å¸§é—´éš”æ—¶é—´ï¼ˆåŸºäºè®¾ç½®çš„è§†é¢‘å¸§ç‡ï¼‰
                            const targetFrameInterval = 1000 / videoFPS;
                            await new Promise(resolve => setTimeout(resolve, targetFrameInterval));
                        }

                        // å½•åˆ¶å®Œæˆ
                        updateToast(recordingToast, 'å½•åˆ¶å®Œæˆï¼Œæ­£åœ¨å¤„ç†è§†é¢‘...');
                        console.log('æ‰€æœ‰å¸§æ¸²æŸ“å®Œæˆï¼Œå‡†å¤‡åœæ­¢MediaRecorder');

                        // æ·»åŠ è¶…æ—¶ä¿æŠ¤ï¼Œç¡®ä¿ä¸ä¼šå¡ä½
                        const stopTimeout = setTimeout(() => {
                            console.error('MediaRecorderåœæ­¢è¶…æ—¶ï¼Œå¼ºåˆ¶å¤„ç†');
                            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                                try {
                                    mediaRecorder.stop();
                                } catch (e) {
                                    console.error('å¼ºåˆ¶åœæ­¢å¤±è´¥:', e);
                                }
                            }
                        }, 5000); // 5ç§’è¶…æ—¶

                        // ç¡®ä¿MediaRecorderåœæ­¢
                        try {
                            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                                mediaRecorder.stop();
                                console.log('MediaRecorder.stop()å·²è°ƒç”¨');

                                // æ¸…é™¤è¶…æ—¶
                                clearTimeout(stopTimeout);
                            } else {
                                console.log('MediaRecorderå·²ç»æ˜¯inactiveçŠ¶æ€');
                                clearTimeout(stopTimeout);
                            }
                        } catch (error) {
                            console.error('åœæ­¢MediaRecorderæ—¶å‡ºé”™:', error);
                            clearTimeout(stopTimeout);
                            throw error;
                        }
                    };

                    // å¼€å§‹åå°å½•åˆ¶
                    recordAllFrames();

                } catch (error) {
                    console.error('å½•åˆ¶è§†é¢‘æ—¶å‡ºé”™:', error);
                    isRecording = false;
                    saveVideoBtn.disabled = false;
                    saveVideoBtn.textContent = 'ä¿å­˜è§†é¢‘';
                    recordingAbortController = null;

                    if (recordingToast) {
                        removeToast(recordingToast);
                        recordingToast = null;
                    }
                    showToast('å½•åˆ¶è§†é¢‘å¤±è´¥: ' + error.message, 'error', { duration: 8000 });
                }
            }

            // å¹¶è¡Œæ¸²æŸ“æ‰€æœ‰å¸§ä»¥åŠ é€Ÿå¤„ç†
            async function renderAllFramesParallel(width, height, totalFrames, startRow, abortController, progressCallback, fontSizeConfig = {}, chartConfig = {}) {
                console.log(`=== renderAllFramesParallel å¼€å§‹ ===`);
                console.log(`å‚æ•°: ${width}x${height}, æ€»å¸§æ•°: ${totalFrames}, èµ·å§‹è¡Œ: ${startRow}`);
                console.log(`abortControllerå­˜åœ¨: ${!!abortController}`);
                console.log(`progressCallbackç±»å‹: ${typeof progressCallback}`);

                const renderedFrames = new Array(totalFrames);
                // æ ¹æ®åˆ†è¾¨ç‡è°ƒæ•´æ‰¹é‡å¤§å°ï¼Œé«˜åˆ†è¾¨ç‡æ—¶å‡å°‘å¹¶å‘
                const maxConcurrent = width >= 1920 ? 2 : (width >= 1280 ? 4 : 8);
                const batchSize = Math.min(maxConcurrent, totalFrames);
                console.log(`æœ€å¤§å¹¶å‘æ•°: ${maxConcurrent}, æ‰¹æ¬¡å¤§å°: ${batchSize}`);
                const batches = [];

                // å°†å¸§åˆ†æ‰¹å¤„ç†
                for (let i = 0; i < totalFrames; i += batchSize) {
                    batches.push({
                        start: i,
                        end: Math.min(i + batchSize, totalFrames)
                    });
                }
                console.log(`åˆ†æ‰¹å®Œæˆï¼Œæ€»å…± ${batches.length} ä¸ªæ‰¹æ¬¡`);

                let completedFrames = 0;

                // å¹¶è¡Œå¤„ç†æ¯ä¸ªæ‰¹æ¬¡
                console.log('å¼€å§‹å¹¶è¡Œå¤„ç†æ¯ä¸ªæ‰¹æ¬¡...');
                for (let batchIndex = 0; batchIndex < batches.length; batchIndex++) {
                    const batch = batches[batchIndex];
                    console.log(`å¤„ç†ç¬¬ ${batchIndex + 1}/${batches.length} æ‰¹æ¬¡ï¼Œå¸§èŒƒå›´: ${batch.start}-${batch.end-1}`);

                    // æ£€æŸ¥æ˜¯å¦è¢«å–æ¶ˆ
                    if (abortController?.signal.aborted) {
                        console.log('æ£€æµ‹åˆ°å–æ¶ˆä¿¡å·ï¼Œåœæ­¢æ¸²æŸ“');
                        throw new Error('å½•åˆ¶å·²å–æ¶ˆ');
                    }

                    const batchPromises = [];

                    // ä¸ºæ‰¹æ¬¡ä¸­çš„æ¯å¸§åˆ›å»ºæ¸²æŸ“ä»»åŠ¡
                    console.log(`ä¸ºæ‰¹æ¬¡ ${batchIndex + 1} åˆ›å»º ${batch.end - batch.start} ä¸ªæ¸²æŸ“ä»»åŠ¡`);
                    for (let frameIndex = batch.start; frameIndex < batch.end; frameIndex++) {
                        console.log(`åˆ›å»ºæ¸²æŸ“ä»»åŠ¡: å¸§ ${frameIndex + 1}`);

                        batchPromises.push(renderSingleFrame(width, height, frameIndex, startRow, fontSizeConfig, chartConfig));
                    }

                    // ç­‰å¾…å½“å‰æ‰¹æ¬¡å®Œæˆï¼ˆæ·»åŠ è¶…æ—¶ä¿æŠ¤ï¼‰
                    console.log(`ç­‰å¾…æ‰¹æ¬¡ ${batchIndex + 1} å®Œæˆï¼Œ${batchPromises.length} ä¸ªä»»åŠ¡...`);
                    const batchResults = await Promise.race([
                        Promise.all(batchPromises),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('æ¸²æŸ“è¶…æ—¶')), 30000)) // 30ç§’è¶…æ—¶
                    ]);
                    console.log(`æ‰¹æ¬¡ ${batchIndex + 1} å®Œæˆï¼Œæ”¶åˆ° ${batchResults.length} ä¸ªç»“æœ`);

                    // ä¿å­˜æ‰¹æ¬¡ç»“æœ
                    for (let i = 0; i < batchResults.length; i++) {
                        const frameIndex = batch.start + i;
                        renderedFrames[frameIndex] = batchResults[i];
                        completedFrames++;

                        // æ›´æ–°è¿›åº¦
                        const progress = Math.round((completedFrames / totalFrames) * 100);
                        progressCallback(progress);
                    }
                }

                console.log(`=== renderAllFramesParallel å®Œæˆ ===`);
                console.log(`æ€»å…±æ¸²æŸ“ ${renderedFrames.filter(f => f).length}/${renderedFrames.length} å¸§`);
                return renderedFrames;
            }

            // æ¸²æŸ“å•ä¸ªå¸§ï¼ˆä¼˜åŒ–æ€§èƒ½å’Œå†…å­˜ï¼‰
            async function renderSingleFrame(width, height, frameIndex, startRow, fontSizeConfig = {}, chartConfig = {}) {
                return new Promise((resolve, reject) => {
                    const timeoutId = setTimeout(() => {
                        reject(new Error(`æ¸²æŸ“ç¬¬ ${frameIndex + 1} å¸§è¶…æ—¶`));
                    }, 60000); // 60ç§’è¶…æ—¶

                    try {
                        console.log(`å¼€å§‹æ¸²æŸ“ç¬¬ ${frameIndex + 1} å¸§ï¼Œå­—å·è®¾ç½®:`, fontSizeConfig);
                        // åˆ›å»ºä¸´æ—¶canvasç”¨äºæ¸²æŸ“
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = width;
                        tempCanvas.height = height;

                        // è®¾ç½®ç™½è‰²èƒŒæ™¯
                        const tempCtx = tempCanvas.getContext('2d');
                        tempCtx.fillStyle = 'white';
                        tempCtx.fillRect(0, 0, width, height);

                        // è·å–å½“å‰å¸§æ—¶é—´ï¼ˆè€ƒè™‘è·³å¸§è®¾ç½®ï¼‰
                        const skipFrames = chartConfig.skipFrames || 0;
                        const actualRowIndex = startRow + frameIndex * (skipFrames + 1);
                        const currentTime = csvFiles.length > 0 ? csvFiles[0].data[actualRowIndex][0] : `æ—¶é—´_${frameIndex + 1}`;

                        // å‡†å¤‡æ•°æ®é›† - å¤šæ–‡ä»¶ç‰ˆæœ¬
                        const datasets = [];

                        // æ·»åŠ æ‰€æœ‰æ–‡ä»¶çš„åŠ¨æ€æ•°æ®é›†
                        for (let fileIndex = 0; fileIndex < allFilesFrameData.length; fileIndex++) {
                            const fileInfo = allFilesFrameData[fileIndex];
                            const csvFileInfo = csvFiles[fileIndex];
                            datasets.push({
                                label: csvFileInfo.displayName, // ä½¿ç”¨æ˜¾ç¤ºåç§°
                                data: fileInfo.frameData[frameIndex], // å½“å‰å¸§æ•°æ®
                                borderColor: fileInfo.color,
                                backgroundColor: fileInfo.color + '20', // æ·»åŠ é€æ˜åº¦
                                borderWidth: 2.5, // åŠ¨æ€æ•°æ®çº¿æ¡é€‚ä¸­ç²—ç»†
                                pointRadius: 0, // å»æ‰ç‚¹æ ‡è®°
                                pointHoverRadius: 5, // é¼ æ ‡æ‚¬æµ®æ—¶æ˜¾ç¤ºç‚¹
                                tension: 0.1,
                                borderDash: [] // ç¡®ä¿ä½¿ç”¨å®çº¿
                            });
                        }

                        // æ·»åŠ å¸¸æ˜¾è¡Œæ•°æ®é›†ï¼ˆæ¥è‡ªæ‰€æœ‰æ–‡ä»¶ï¼‰
                        for (let i = 0; i < constantRowsData.length; i++) {
                            const constRowData = constantRowsData[i];
                            datasets.push({
                                label: constRowData.label,
                                data: constRowData.data,
                                borderColor: constRowData.color,
                                backgroundColor: constRowData.color + '20',
                                borderWidth: 1.5, // å¸¸æ˜¾è¡Œä½¿ç”¨ç»†å®çº¿
                                pointRadius: 0,
                                pointHoverRadius: 4,
                                tension: 0.1,
                                borderDash: [] // ä½¿ç”¨å®çº¿
                            });
                        }

                        // åˆ›å»ºä¸´æ—¶å›¾è¡¨ï¼ˆé«˜åˆ†è¾¨ç‡ä¼˜åŒ–ï¼‰
                        const tempChart = new Chart(tempCanvas, {
                            type: 'line',
                            data: { datasets: datasets },
                            options: {
                                responsive: false,
                                maintainAspectRatio: false,
                                animation: false, // å…³é—­åŠ¨ç”»ä»¥æé«˜æ€§èƒ½
                                backgroundColor: 'white', // è®¾ç½®å›¾è¡¨èƒŒæ™¯ä¸ºç™½è‰²
                                devicePixelRatio: 1, // å›ºå®šåƒç´ æ¯”ä¾‹ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»æ‰‹åŠ¨å¤„ç†äº†é«˜åˆ†è¾¨ç‡
                                plugins: {
                                    title: {
                                        display: true,
                                        text: [chartConfig.chartTitle || 'æ•°æ®åŠ¨ç”»', `${currentTime}`],
                                        font: { size: fontSizeConfig.titleFontSize || 16 },
                                        color: '#333' // æ ‡é¢˜é¢œè‰²
                                    },
                                    legend: {
                                        display: chartConfig.showLegend || (allFilesFrameData.length > 1 || constantRowsData.length > 0),
                                        labels: {
                                            color: '#333',
                                            font: { size: fontSizeConfig.legendFontSize || 12 } // å›¾ä¾‹æ–‡å­—é¢œè‰²
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        type: chartConfig.xAxisType || 'linear',
                                        title: {
                                            display: true,
                                            text: chartConfig.xAxisLabel || 'Xè½´',
                                            color: '#333',
                                            font: { size: fontSizeConfig.axisTitleFontSize || 14 }
                                        },
                                        ticks: {
                                            color: '#333', // åˆ»åº¦æ ‡ç­¾é¢œè‰²
                                            font: { size: fontSizeConfig.axisTickFontSize || 12 }
                                        },
                                        grid: {
                                            color: '#e0e0e0' // ç½‘æ ¼çº¿é¢œè‰²
                                        },
                                        min: chartConfig.xAxisType === 'linear' ? chartConfig.xMin : undefined,
                                        max: chartConfig.xAxisType === 'linear' ? chartConfig.xMax : undefined
                                    },
                                    y: {
                                        title: {
                                            display: true,
                                            text: chartConfig.yAxisLabel || 'Yè½´',
                                            color: '#333',
                                            font: { size: fontSizeConfig.axisTitleFontSize || 14 }
                                        },
                                        ticks: {
                                            color: '#333',
                                            font: { size: fontSizeConfig.axisTickFontSize || 12 }
                                        },
                                        grid: {
                                            color: '#e0e0e0'
                                        },
                                        min: chartConfig.yMin === 'auto' ? null : chartConfig.yMin,
                                        max: chartConfig.yMax === 'auto' ? null : chartConfig.yMax
                                    }
                                }
                            }
                        });

                        // ç­‰å¾…å›¾è¡¨æ¸²æŸ“å®Œæˆ
                        setTimeout(() => {
                            try {
                                // åˆ›å»ºæœ€ç»ˆçš„canvasç”¨äºè¾“å‡º
                                const outputCanvas = document.createElement('canvas');
                                outputCanvas.width = width;
                                outputCanvas.height = height;
                                const outputCtx = outputCanvas.getContext('2d');

                                // è®¾ç½®ç™½è‰²èƒŒæ™¯
                                outputCtx.fillStyle = 'white';
                                outputCtx.fillRect(0, 0, width, height);

                                // ç»˜åˆ¶å›¾è¡¨ï¼Œç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„å°ºå¯¸
                                outputCtx.drawImage(tempCanvas, 0, 0, width, height);

                                // æ¸…ç†ä¸´æ—¶å›¾è¡¨
                                tempChart.destroy();

                                resolve(outputCanvas);
                            } catch (error) {
                                tempChart.destroy();
                                reject(error);
                            }
                        }, 100); // ç»™è¶³å¤Ÿæ—¶é—´æ¸²æŸ“

                        clearTimeout(timeoutId); // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨

                    } catch (error) {
                        clearTimeout(timeoutId); // æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨
                        reject(error);
                    }
                });
            }
        });
    </script>
</body>
</html>
